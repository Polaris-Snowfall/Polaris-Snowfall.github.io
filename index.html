<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8" />
        
      <meta name="description" content="Boom? PWN ! ! !" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title> 北极落小雪</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>
  </html>
</html>


<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="app">
    
      
    <main class="content on">
      
<section class="cover">
    
  <div class="cover-frame">
    <div class="bg-box">
      <img src="/images/0.jpg" alt="image frame" />
    </div>
    <div class="cover-inner text-center text-white">
      <h1><a href="/">北极落小雪</a></h1>
      <div id="subtitle-box">
        
        <span id="subtitle"></span>
        
      </div>
      <div>
        
      </div>
    </div>
  </div>
  <div class="cover-learn-more">
    <a href="javascript:void(0)" class="anchor"><i class="ri-arrow-down-line"></i></a>
  </div>
</section>



<script src="https://cdn.staticfile.org/typed.js/2.0.12/typed.min.js"></script>


<!-- Subtitle -->

  <script>
    try {
      var typed = new Typed("#subtitle", {
        strings: ['遗憾的话,总会有的...', '翰青HanQi-blogs', 'Polaris_Snowfall...'],
        startDelay: 0,
        typeSpeed: 200,
        loop: true,
        backSpeed: 100,
        showCursor: true
      });
    } catch (err) {
      console.log(err)
    }
  </script>
  
<div id="main">
  <section class="outer">
  
  
  <article class="articles">
    
    
    
    
    <article
  id="post-6.828-Lab6"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/6.828-Lab6/"
    >MIT6.828 Lab6</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/6.828-Lab6/" class="article-date">
  <time datetime="2023-11-14T16:00:00.000Z" itemprop="datePublished">2023-11-15</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> / <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a> / <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/6-828/">6.828</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h2 id="Lab-6-Network-Driver"><a href="#Lab-6-Network-Driver" class="headerlink" title="Lab 6: Network Driver"></a>Lab 6: Network Driver</h2><h3 id="Part-A-Initialization-and-transmitting-packets"><a href="#Part-A-Initialization-and-transmitting-packets" class="headerlink" title="Part A: Initialization and transmitting packets"></a>Part A: Initialization and transmitting packets</h3><h4 id="time"><a href="#time" class="headerlink" title="time"></a>time</h4><p>在之前的时钟中断调度前加一个对time_tick函数的调用,注意时钟中断每个CPU都会收到,而我们的目的是计时,所以选择固定选择一个CPU来处理就好,bootcpu当然是最合适的.</p>
<pre class=" language-c"><code class="language-c">        <span class="token keyword">case</span> IRQ_OFFSET<span class="token operator">+</span>IRQ_TIMER<span class="token punctuation">:</span>
            <span class="token function">lapic_eoi</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>thiscpu<span class="token operator">==</span>bootcpu<span class="token punctuation">)</span>
                <span class="token function">time_tick</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sched_yield</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="The-Network-Interface-Card"><a href="#The-Network-Interface-Card" class="headerlink" title="The Network Interface Card"></a>The Network Interface Card</h4><p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202311131138871.png"></p>
<h5 id="PCI-Interface"><a href="#PCI-Interface" class="headerlink" title="PCI Interface"></a>PCI Interface</h5><p>现在要完成E1000作为一个PCI设备的识别和初始化</p>
<blockquote>
<p>The E1000 is a PCI device, which means it plugs into the PCI bus on the motherboard. The PCI bus has address, data, and interrupt lines, and allows the CPU to communicate with PCI devices and PCI devices to read and write memory. A PCI device needs to be discovered and initialized before it can be used. Discovery is the process of walking the PCI bus looking for attached devices. Initialization is the process of allocating I/O and memory space as well as negotiating the IRQ line for the device to use.</p>
</blockquote>
<blockquote>
<p> To perform PCI initialization during boot, the PCI code walks the PCI bus looking for devices. When it finds a device, it reads its vendor ID and device ID and uses these two values as a key to search the pci_attach_vendor array. </p>
<p>If the discovered device’s vendor ID and device ID match an entry in the array, the PCI code calls that entry’s attachfn to perform device initialization.</p>
</blockquote>
<p>在Software Developer’s Manual中找到E1000的vendor ID和device ID,为E1000声明一个用来attach的函数</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> PCI_E1000_VENDOR_ID 0x8086</span>
<span class="token macro property">#<span class="token directive keyword">define</span> PCI_E1000_DEVICE_ID 0x100E</span>

<span class="token keyword">int</span> <span class="token function">e1000_attach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> pci_func <span class="token operator">*</span>pcif<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>填入pci_attach_vendor数组中,这样E1000可以被识别.</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> pci_driver pci_attach_vendor<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token punctuation">{</span>PCI_E1000_VENDOR_ID<span class="token punctuation">,</span>PCI_E1000_DEVICE_ID<span class="token punctuation">,</span>e1000_attach<span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h5 id="Memory-mapped"><a href="#Memory-mapped" class="headerlink" title="Memory-mapped"></a>Memory-mapped</h5><blockquote>
<p>Software communicates with the E1000 via memory-mapped I/O (MMIO).</p>
</blockquote>
<p>mmio_map_region的实现在lab4中.</p>
<pre class=" language-c"><code class="language-c">
<span class="token keyword">volatile</span> <span class="token keyword">void</span><span class="token operator">*</span> e1000<span class="token punctuation">;</span>


<span class="token keyword">int</span> <span class="token function">e1000_attach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> pci_func <span class="token operator">*</span>pcif<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">pci_func_enable</span><span class="token punctuation">(</span>pcif<span class="token punctuation">)</span><span class="token punctuation">;</span>

    e1000 <span class="token operator">=</span> <span class="token function">mmio_map_region</span><span class="token punctuation">(</span>pcif<span class="token operator">-></span>reg_base<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>pcif<span class="token operator">-></span>reg_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"Device e1000 attached, status:%p\n"</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="Transmitting-Packets"><a href="#Transmitting-Packets" class="headerlink" title="Transmitting Packets"></a>Transmitting Packets</h4><h5 id="C-Structures"><a href="#C-Structures" class="headerlink" title="C Structures"></a>C Structures</h5><p>加上e1000设备的初始化操作</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> e1000_tx_desc tds<span class="token punctuation">[</span>NTRANS_DESC<span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token keyword">int</span> <span class="token function">e1000_attach</span><span class="token punctuation">(</span><span class="token keyword">struct</span> pci_func <span class="token operator">*</span>pcif<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">int</span> r<span class="token punctuation">;</span>
    <span class="token function">pci_func_enable</span><span class="token punctuation">(</span>pcif<span class="token punctuation">)</span><span class="token punctuation">;</span>

    e1000 <span class="token operator">=</span> <span class="token function">mmio_map_region</span><span class="token punctuation">(</span>pcif<span class="token operator">-></span>reg_base<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>pcif<span class="token operator">-></span>reg_size<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"Device e1000 attached, status:%p\n"</span><span class="token punctuation">,</span><span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_STATUS<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_TDBAL<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">PADDR</span><span class="token punctuation">(</span>tds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_TDLEN<span class="token punctuation">)</span> <span class="token operator">=</span> TDLEN<span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_TDH<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_TDT<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_TCTL<span class="token punctuation">)</span> <span class="token operator">=</span> E1000_TCTL_EN<span class="token operator">|</span>
                                    E1000_TCTL_PSP<span class="token operator">|</span>
                                <span class="token punctuation">(</span>E1000_TCTL_COLD<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token operator">&lt;&lt;</span>E1000_TCTL_COLD_SHIFT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_TIPG<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">12</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class=" language-c"><code class="language-c"><span class="token keyword">inline</span> uint32_t <span class="token function">tdh</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_TDH<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">inline</span> uint32_t <span class="token function">tdt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_TDT<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">tds_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>NTRANS_DESC<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        tds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">=</span> <span class="token function">PADDR</span><span class="token punctuation">(</span>tdbufs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_TDBAL<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">PADDR</span><span class="token punctuation">(</span>tds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_TDBAH<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_TDLEN<span class="token punctuation">)</span> <span class="token operator">=</span> TDLEN<span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_TDH<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_TDT<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_TCTL<span class="token punctuation">)</span> <span class="token operator">=</span> E1000_TCTL_EN<span class="token operator">|</span>
                                    E1000_TCTL_PSP<span class="token operator">|</span>
                                <span class="token punctuation">(</span>E1000_TCTL_COLD<span class="token operator">&amp;</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token operator">&lt;&lt;</span>E1000_TCTL_COLD_SHIFT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                                
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_TIPG<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span><span class="token number">12</span> <span class="token operator">&lt;&lt;</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">tx_pkt</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> buf<span class="token punctuation">,</span>size_t nbytes<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>nbytes<span class="token operator">></span>DESC_BUF_SZ<span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"tx_pkt: invalid packet size\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>tds<span class="token punctuation">[</span><span class="token function">tdt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cmd<span class="token operator">&amp;</span>E1000_TXD_CMD_RS<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>tds<span class="token punctuation">[</span><span class="token function">tdt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>status<span class="token operator">&amp;</span>E1000_TXD_STAT_DD<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token function">cprintf</span><span class="token punctuation">(</span><span class="token string">"tx_pkt: the transmit queue is full,please retry\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token operator">-</span>E_TDQ_FULL<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>tdbufs<span class="token punctuation">[</span><span class="token function">tdt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>buf<span class="token punctuation">,</span>nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tds<span class="token punctuation">[</span><span class="token function">tdt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token punctuation">(</span>uint16_t<span class="token punctuation">)</span>nbytes<span class="token punctuation">;</span>
    tds<span class="token punctuation">[</span><span class="token function">tdt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>cmd <span class="token operator">|</span><span class="token operator">=</span> <span class="token punctuation">(</span>E1000_TXD_CMD_RS<span class="token operator">|</span>E1000_TXD_CMD_EOP<span class="token punctuation">)</span><span class="token punctuation">;</span>
    tds<span class="token punctuation">[</span><span class="token function">tdt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">~</span>E1000_TXD_STAT_DD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_TDT<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">tdt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span>NTRANS_DESC<span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="Part-B-Receiving-packets-and-the-web-server"><a href="#Part-B-Receiving-packets-and-the-web-server" class="headerlink" title="Part B: Receiving packets and the web server"></a>Part B: Receiving packets and the web server</h3><p>和Transmit packets类似,查手册写就行了.</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">rx_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>NRECV_DESC<span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        rds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>addr <span class="token operator">=</span> <span class="token function">PADDR</span><span class="token punctuation">(</span>rdbufs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        rds<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>E1000_RXD_STAT_DD<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_RAL<span class="token punctuation">)</span> <span class="token operator">=</span> MAC_IPL<span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_RAH<span class="token punctuation">)</span> <span class="token operator">=</span> MAC_IPH<span class="token operator">|</span>E1000_RAH_AV<span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">128</span><span class="token punctuation">;</span><span class="token operator">++</span>i<span class="token punctuation">)</span>
        <span class="token punctuation">(</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_MTA<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_RDBAL<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">PADDR</span><span class="token punctuation">(</span>rds<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_RDBAH<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_RDLEN<span class="token punctuation">)</span> <span class="token operator">=</span> NRECV_DESC<span class="token operator">*</span>DESC_BUF_SZ<span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_RDH<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_RDT<span class="token punctuation">)</span> <span class="token operator">=</span> NRECV_DESC<span class="token number">-1</span><span class="token punctuation">;</span>
    
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_RCTL<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token punctuation">(</span>E1000_RCTL_EN <span class="token operator">|</span> E1000_RCTL_SECRC <span class="token operator">|</span> E1000_RCTL_BAM <span class="token operator">|</span> <span class="token number">0</span><span class="token operator">&lt;&lt;</span>RCTL_BSIZE_SHIFT<span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">~</span>E1000_RCTL_LPE<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">int</span> <span class="token function">rx_pkt</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> buf<span class="token punctuation">,</span>size_t max_bytes<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    uint32_t next <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">rdt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">%</span>NRECV_DESC<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rds<span class="token punctuation">[</span>next<span class="token punctuation">]</span><span class="token punctuation">.</span>status<span class="token operator">&amp;</span>E1000_RXD_STAT_DD<span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_RDQ_EMPTY<span class="token punctuation">;</span>
    uint16_t lenth <span class="token operator">=</span> rds<span class="token punctuation">[</span>next<span class="token punctuation">]</span><span class="token punctuation">.</span>length<span class="token punctuation">;</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>lenth<span class="token operator">></span>max_bytes<span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token operator">-</span>E_INVAL<span class="token punctuation">;</span>
    <span class="token function">memcpy</span><span class="token punctuation">(</span>buf<span class="token punctuation">,</span>rdbufs<span class="token punctuation">[</span>next<span class="token punctuation">]</span><span class="token punctuation">,</span>lenth<span class="token punctuation">)</span><span class="token punctuation">;</span>
    rds<span class="token punctuation">[</span>next<span class="token punctuation">]</span><span class="token punctuation">.</span>status <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">~</span>E1000_RXD_STAT_DD<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token operator">*</span><span class="token punctuation">(</span>uint32_t<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>e1000<span class="token operator">+</span>E1000_RDT<span class="token punctuation">)</span> <span class="token operator">=</span> next<span class="token punctuation">;</span>
    <span class="token keyword">return</span> lenth<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a>效果</h3><p>其他代码详见github.<br>通过所有测试.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202311141920905.png"></p>
<p>现在启动httpd server,在浏览器中访问html页面(正好桌面上有这个html及css等文件,就拿来实验了,这是我曾经的一次作业,你可以通过这个页面猜到,我最终没有通过考试),可以看到这样的界面.<br>你可以看到有张只有一小半的BUPT校徽,<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202311141954122.png"><br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202311141744741.png"></p>
<p>我尝试输出字节数的方式来探究其只有一小半的原因.发现确实未发送完全.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202311141751103.png"></p>
<p>我启动e1000的调试功能,多次实验发现在第125次发送时稳定触发,与TX描述符个数无关,更奇怪的时,触发之后125,126,127还能够继续传输,并且再次触发.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202311142017469.png"><br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202311142036889.png"></p>
<p>我在课程提供的qemu的源码中找到了这一报错,它意味着e1000正在发送的描述符的buffer_addr为空,但我找不出原因,我的初始化工作和其他工作看起来没有问题,至少不太可能出现buffer_addr为空的问题.我不确定是否是课程提供的qemu存在的问题,该问题会在以后的开发中再来解决,毕竟计算机网络方面的知识我还所知甚少,近期的开发会先从JOS一些实现的优化开始.</p>
<p>如果您知道问题出在哪里,请联系我,感激不尽.</p>
<pre class=" language-c"><code class="language-c">        <span class="token keyword">if</span> <span class="token punctuation">(</span>desc<span class="token punctuation">.</span>buffer_addr<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>desc_offset <span class="token operator">&lt;</span> size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                size_t iov_copy<span class="token punctuation">;</span>
                hwaddr ba <span class="token operator">=</span> <span class="token function">le64_to_cpu</span><span class="token punctuation">(</span>desc<span class="token punctuation">.</span>buffer_addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
                size_t copy_size <span class="token operator">=</span> size <span class="token operator">-</span> desc_offset<span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>copy_size <span class="token operator">></span> s<span class="token operator">-></span>rxbuf_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    copy_size <span class="token operator">=</span> s<span class="token operator">-></span>rxbuf_size<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">do</span> <span class="token punctuation">{</span>
                    iov_copy <span class="token operator">=</span> <span class="token function">MIN</span><span class="token punctuation">(</span>copy_size<span class="token punctuation">,</span> iov<span class="token operator">-></span>iov_len <span class="token operator">-</span> iov_ofs<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">pci_dma_write</span><span class="token punctuation">(</span>d<span class="token punctuation">,</span> ba<span class="token punctuation">,</span> iov<span class="token operator">-></span>iov_base <span class="token operator">+</span> iov_ofs<span class="token punctuation">,</span> iov_copy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    copy_size <span class="token operator">-</span><span class="token operator">=</span> iov_copy<span class="token punctuation">;</span>
                    ba <span class="token operator">+</span><span class="token operator">=</span> iov_copy<span class="token punctuation">;</span>
                    iov_ofs <span class="token operator">+</span><span class="token operator">=</span> iov_copy<span class="token punctuation">;</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>iov_ofs <span class="token operator">==</span> iov<span class="token operator">-></span>iov_len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        iov<span class="token operator">++</span><span class="token punctuation">;</span>
                        iov_ofs <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>copy_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            desc_offset <span class="token operator">+</span><span class="token operator">=</span> desc_size<span class="token punctuation">;</span>
            desc<span class="token punctuation">.</span>length <span class="token operator">=</span> <span class="token function">cpu_to_le16</span><span class="token punctuation">(</span>desc_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>desc_offset <span class="token operator">>=</span> total_size<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                desc<span class="token punctuation">.</span>status <span class="token operator">|</span><span class="token operator">=</span> E1000_RXD_STAT_EOP <span class="token operator">|</span> E1000_RXD_STAT_IXSM<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment" spellcheck="true">/* Guest zeroing out status is not a hardware requirement.
                   Clear EOP in case guest didn't do it. */</span>
                desc<span class="token punctuation">.</span>status <span class="token operator">&amp;</span><span class="token operator">=</span> <span class="token operator">~</span>E1000_RXD_STAT_EOP<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment" spellcheck="true">// as per intel docs; skip descriptors with null buf addr</span>
            <span class="token function">DBGOUT</span><span class="token punctuation">(</span>RX<span class="token punctuation">,</span> <span class="token string">"Null RX descriptor!!\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/6%C2%B7828/" rel="tag">6·828</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-HQOS-Design-and-Implementation"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/HQOS-Design-and-Implementation/"
    >HQOS 设计与实现</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/HQOS-Design-and-Implementation/" class="article-date">
  <time datetime="2023-11-14T16:00:00.000Z" itemprop="datePublished">2023-11-15</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/">程序设计</a> / <a class="article-category-link" href="/categories/%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1/HQOS/">HQOS</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="序"><a href="#序" class="headerlink" title="序"></a>序</h1><p>“THE MAN WHO CHANGED CHROME” 曾经指出如何学习计算机基础知识:</p>
<blockquote>
<p>自己写一个CPU,在自己写的CPU上运行自己写的操作系统,然后用自己写的编译器编译运行一个程序.</p>
</blockquote>
<p>于是便有了写一个操作系统的想法.在粗略看完一遍《操作系统真相还原》后,感觉从引导操作系统到实现各种操作系统概念的完整过程工作量有点太大了,暂时还没有那么多时间和精力来完成,便暂且搁置了.</p>
<p>感谢MIT的6.828课程,让我能在有限的时间里一步一步地实现一个操作系统雏形JOS.JOS的开发过程请查看 /学习笔记/6.828分类下的文章.</p>
<p>在接下来的几年时间,我会继续开发扩展该操作系统,并重构目前实现模型中我不太喜欢的实现,就叫它HQOS吧.</p>
<p>本博客记录当前版本HQOS的设计与实现,你可以在github上找到其历史文档及代码实现.</p>
<h1 id="设计与实现-Version-0-0"><a href="#设计与实现-Version-0-0" class="headerlink" title="设计与实现 Version 0.0"></a>设计与实现 Version 0.0</h1><h2 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h2><p>HQOS使用C语言进行开发,是一个基于x86架构的Unix-like微内核操作系统,你可以从中找到很多Unix-like的设计和功能.一些模块如File system,Network等在用户态实现.</p>
<ol>
<li>Memory management</li>
<li>Processes and Threads</li>
<li>File systems</li>
<li>Network</li>
<li>System calls, Interrupts, Exceptions</li>
<li>User library</li>
</ol>
<h2 id="Memory-management"><a href="#Memory-management" class="headerlink" title="Memory management"></a>Memory management</h2><h3 id="Physical-Page-Management"><a href="#Physical-Page-Management" class="headerlink" title="Physical Page Management"></a>Physical Page Management</h3><h4 id="Keep-track-of-physical-page-frames"><a href="#Keep-track-of-physical-page-frames" class="headerlink" title="Keep track of (physical) page frames"></a>Keep track of (physical) page frames</h4><p>HQOS以页面粒度进行物理内存管理.对于每一个物理页,使用一个PageInfo结构来跟踪其的使用情况(空闲或使用中,被多少”用户”使用).所有的PageInfo结构位于一个连续的数组中,PageInfo结构在数组中的索引与物理页的地址相关联(IDX &lt;—&gt; PGNUM = PADDR / PGSIZE).</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> PageInfo <span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// Next page on the free list.</span>
    <span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>pp_link<span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">// pp_ref is the count of pointers (usually in page table entries)</span>
    <span class="token comment" spellcheck="true">// to this page, for pages allocated using page_alloc.</span>
    <span class="token comment" spellcheck="true">// Pages allocated at boot time using pmap.c's</span>
    <span class="token comment" spellcheck="true">// boot_alloc do not have valid reference count fields.</span>

    uint16_t pp_ref<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="Dynamically-allocate-x2F-free-page-frames"><a href="#Dynamically-allocate-x2F-free-page-frames" class="headerlink" title="Dynamically allocate / free page frames"></a>Dynamically allocate / free page frames</h4><h5 id="Interface"><a href="#Interface" class="headerlink" title="Interface"></a>Interface</h5><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//For kernel:</span>
<span class="token comment" spellcheck="true">//请求分配一个物理页</span>
<span class="token keyword">struct</span> PageInfo <span class="token operator">*</span><span class="token function">page_alloc</span><span class="token punctuation">(</span><span class="token keyword">int</span> alloc_flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//减少对某物理页的一次引用</span>
<span class="token keyword">void</span>
<span class="token function">page_decref</span><span class="token punctuation">(</span><span class="token keyword">struct</span> PageInfo<span class="token operator">*</span> pp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//释放某物理页</span>
<span class="token keyword">void</span>	<span class="token function">page_free</span><span class="token punctuation">(</span><span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>pp<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//For User:</span>
<span class="token comment" spellcheck="true">//分配并映射一个页面</span>
<span class="token keyword">int</span>	<span class="token function">sys_page_alloc</span><span class="token punctuation">(</span>envid_t env<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pg<span class="token punctuation">,</span> <span class="token keyword">int</span> perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//映射一个页面</span>
<span class="token keyword">int</span>	<span class="token function">sys_page_map</span><span class="token punctuation">(</span>envid_t src_env<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>src_pg<span class="token punctuation">,</span>
             envid_t dst_env<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dst_pg<span class="token punctuation">,</span> <span class="token keyword">int</span> perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//取消一个页面的映射</span>
<span class="token keyword">int</span>	<span class="token function">sys_page_unmap</span><span class="token punctuation">(</span>envid_t env<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pg<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h5 id="Implementation"><a href="#Implementation" class="headerlink" title="Implementation"></a>Implementation</h5><p>HQOS以单向链表的数据结构组织空闲物理页.page_alloc与page_free分别从空闲链表中取出一个物理页或加入一个到空闲链表中.在目前的实现中,page_free仅在page_decref中调用,当且仅当某物理页不再被任何一处引用,释放该物理页.</p>
<h3 id="Virtual-memory-management"><a href="#Virtual-memory-management" class="headerlink" title="Virtual memory management"></a>Virtual memory management</h3><h4 id="Page-translation"><a href="#Page-translation" class="headerlink" title="Page translation"></a>Page translation</h4><h5 id="Interface-1"><a href="#Interface-1" class="headerlink" title="Interface"></a>Interface</h5><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//For kernel:</span>
<span class="token comment" spellcheck="true">//插入一个页面到页表中(映射一个虚拟地址对应的页面)</span>
<span class="token keyword">int</span>	<span class="token function">page_insert</span><span class="token punctuation">(</span>pde_t <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> <span class="token keyword">struct</span> PageInfo <span class="token operator">*</span>pp<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">,</span> <span class="token keyword">int</span> perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//从页表中移除一个页面(取消一个虚拟地址对应页面的映射)</span>
<span class="token keyword">void</span>	<span class="token function">page_remove</span><span class="token punctuation">(</span>pde_t <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment" spellcheck="true">//寻找虚拟地址对应页面的PageInfo结构及页表条目</span>
<span class="token keyword">struct</span> PageInfo <span class="token operator">*</span><span class="token function">page_lookup</span><span class="token punctuation">(</span>pde_t <span class="token operator">*</span>pgdir<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>va<span class="token punctuation">,</span> pte_t <span class="token operator">*</span><span class="token operator">*</span>pte_store<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h5 id="Implementation-1"><a href="#Implementation-1" class="headerlink" title="Implementation"></a>Implementation</h5><p>HQOS运行在x86’s protected-mode memory management architecture之上.<br>逻辑地址(虚拟地址)经Segmentation Mechanism转换为线性地址,再经由Paging Mechanism转换到物理地址,最终送上硬件总线.</p>
<p>HQOS仅通过页面翻译过程完成虚拟地址到物理地址的转换,(实现的方式是: 将全局描述符表中所有条目的段基址设置为0,段界限设置为0xffffffff,此时线性地址就等于虚拟地址.),segmentation在HQOS的实现中更多地作用于权限控制.</p>
<p>HQOS使用二级页表来完成页面翻译,一个页目录表中有1024个页表条目,一个页表中有1024个页条目,每个页大小为4096字节.(当然,这是x86硬件决定的)</p>
<h4 id="Pagefault-handling"><a href="#Pagefault-handling" class="headerlink" title="Pagefault handling"></a>Pagefault handling</h4><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//For User</span>
<span class="token function">sys_env_set_pgfault_upcall</span><span class="token punctuation">(</span>envid_t envid<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>func<span class="token punctuation">)</span>
</code></pre>
<p>HQOS对于内核态的页面错误,产生Kernel panic.而对于用户态的页面错误,销毁产生页面错误的用户进程或派发到一个完成注册的用户态页面错误处理函数.</p>
<h4 id="Page-replacement-待实现"><a href="#Page-replacement-待实现" class="headerlink" title="Page replacement (待实现)"></a>Page replacement (待实现)</h4><h2 id="Processes-and-Threads"><a href="#Processes-and-Threads" class="headerlink" title="Processes and Threads"></a>Processes and Threads</h2><h3 id="Processes"><a href="#Processes" class="headerlink" title="Processes"></a>Processes</h3><h4 id="Process-model"><a href="#Process-model" class="headerlink" title="Process model"></a>Process model</h4><p>HQOS使用术语”环境(Environment)“来表示进程.<br>    HQOS使用struct Env的数组来管理系统中所有进程(无论进程是否存在,进程状态由env_status标识),数组的大小即为HQOS允许的最大进程数NENV.</p>
<pre class=" language-c"><code class="language-c"><span class="token keyword">struct</span> Env <span class="token punctuation">{</span>
    <span class="token keyword">struct</span> Trapframe env_tf<span class="token punctuation">;</span>	<span class="token comment" spellcheck="true">// Saved registers</span>
    <span class="token keyword">struct</span> Env <span class="token operator">*</span>env_link<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// Next free Env</span>
    envid_t env_id<span class="token punctuation">;</span>			<span class="token comment" spellcheck="true">// Unique environment identifier</span>
    envid_t env_parent_id<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// env_id of this env's parent</span>
    <span class="token keyword">enum</span> EnvType env_type<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// Indicates special system environments</span>
    <span class="token keyword">unsigned</span> env_status<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// Status of the environment</span>
    uint32_t env_runs<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// Number of times environment has run</span>
    <span class="token keyword">int</span> env_cpunum<span class="token punctuation">;</span>			<span class="token comment" spellcheck="true">// The CPU that the env is running on</span>

    <span class="token comment" spellcheck="true">// Address space</span>
    pde_t <span class="token operator">*</span>env_pgdir<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// Kernel virtual address of page dir</span>

    <span class="token comment" spellcheck="true">// Exception handling</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>env_pgfault_upcall<span class="token punctuation">;</span>	<span class="token comment" spellcheck="true">// Page fault upcall entry point</span>

    bool env_ipc_recving<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// Env is blocked receiving</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>env_ipc_dstva<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// VA at which to map received page</span>
    uint32_t env_ipc_value<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// Data value sent to us</span>
    envid_t env_ipc_from<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// envid of the sender</span>
    <span class="token keyword">int</span> env_ipc_perm<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// Perm of page mapping received</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>每个进程有自己独立的页目录表,即拥有一个独立的32位虚拟地址空间.这意味着同一个物理页可以映射到多个进程中,这是HQOS目前进程间通信实现的关键.HQOS中属于内核的物理空间完整的映射到每个进程的虚拟地址空间中.</p>
<p>进程目前不具有也不需要独立的内核堆栈.</p>
<h4 id="Process-creation"><a href="#Process-creation" class="headerlink" title="Process creation"></a>Process creation</h4><h5 id="Interface-2"><a href="#Interface-2" class="headerlink" title="Interface"></a>Interface</h5><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//For Kernel:</span>
<span class="token comment" spellcheck="true">// Allocates a new env with env_alloc, loads the named elf</span>
<span class="token comment" spellcheck="true">// binary into it with load_icode, and sets its env_type.</span>
<span class="token comment" spellcheck="true">// This function is ONLY called during kernel initialization,</span>
<span class="token comment" spellcheck="true">// before running the first user-mode environment.</span>
<span class="token comment" spellcheck="true">// The new env's parent ID is set to 0.</span>
<span class="token comment" spellcheck="true">//</span>
<span class="token keyword">void</span>
<span class="token function">env_create</span><span class="token punctuation">(</span>uint8_t <span class="token operator">*</span>binary<span class="token punctuation">,</span> <span class="token keyword">enum</span> EnvType type<span class="token punctuation">)</span>

<span class="token comment" spellcheck="true">//For User:</span>
<span class="token comment" spellcheck="true">//Create the new environment</span>
<span class="token comment" spellcheck="true">//the register set is copied from the current environment</span>
<span class="token comment" spellcheck="true">//新进程的虚拟地址空间仅初始化了内核部分</span>
envid_t
<span class="token function">sys_exofork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
</code></pre>
<h4 id="Process-scheduling"><a href="#Process-scheduling" class="headerlink" title="Process scheduling"></a>Process scheduling</h4><h5 id="Interface-3"><a href="#Interface-3" class="headerlink" title="Interface"></a>Interface</h5><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">//For Kernel:</span>
<span class="token comment" spellcheck="true">// Choose a user environment to run and run it.</span>
<span class="token keyword">void</span>
<span class="token function">sched_yield</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//For User:</span>
<span class="token keyword">void</span>
<span class="token function">sys_yield</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h5 id="Implementation-2"><a href="#Implementation-2" class="headerlink" title="Implementation"></a>Implementation</h5><p>HQOS的进程调度采用轮转调度(round robin).但目前还没有加入时间片的概念.每当时钟中断产生,时钟中断处理例程从当前进程在进程数组中的位置开始遍历其他进程,切换到下一个可运行状态的进程.若无其他可运行的进程,进程重启自身.内核进程不会因时钟中断发生调度(因为目前处理器在内核态时屏蔽中断).<br>进程当然也可主动让出处理器.</p>
<p>这样的实现当然是让人非常不满的,很快其将会重新实现.</p>
<h4 id="Interprocess-Communication-IPC"><a href="#Interprocess-Communication-IPC" class="headerlink" title="Interprocess Communication (IPC)"></a>Interprocess Communication (IPC)</h4><h5 id="Locking"><a href="#Locking" class="headerlink" title="Locking"></a>Locking</h5><p>HQOS支持多处理器,可能会有多个进程同时进入内核态.HQOS使用一个内核整体的Kernel Lock,进入内核时获取,离开内核时释放,也就是说,HQOS目前仅支持单个内核进程运行.这样的实现依赖于HQOS内核空间对所有进程而言是共享的.</p>
<h5 id="Sending-and-Receiving-Messages"><a href="#Sending-and-Receiving-Messages" class="headerlink" title="Sending and Receiving Messages"></a>Sending and Receiving Messages</h5><h6 id="By-Value"><a href="#By-Value" class="headerlink" title="By Value"></a>By Value</h6><p>通过用户进程可读的进程表(envs数组)来传递一字长的value.然而该value对所有进程都可见,且一字长的数据太短,所以一般用来辅助By page的传递方式.</p>
<h6 id="By-page"><a href="#By-page" class="headerlink" title="By page"></a>By page</h6><p>将sender的某页面映射到recver的虚拟地址空间中.<br>sender指示接收进程及页面权限.<br>recver指示将要映射到的虚拟地址.</p>
<p>recver阻塞直到sender将其唤醒.检测消息来源是否为期望的sender的工作由用户态调用者完成.</p>
<pre class=" language-c"><code class="language-c"> <span class="token keyword">int</span>
<span class="token function">sys_ipc_try_send</span><span class="token punctuation">(</span>envid_t envid<span class="token punctuation">,</span> uint32_t value<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>srcva<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> perm<span class="token punctuation">)</span>
<span class="token keyword">int</span>
<span class="token function">sys_ipc_recv</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>dstva<span class="token punctuation">)</span>
</code></pre>
<h3 id="Threads-线程-待实现"><a href="#Threads-线程-待实现" class="headerlink" title="Threads 线程(待实现)"></a>Threads 线程(待实现)</h3><h2 id="File-systems"><a href="#File-systems" class="headerlink" title="File systems"></a>File systems</h2><h3 id="On-Disk-File-System-Structure"><a href="#On-Disk-File-System-Structure" class="headerlink" title="On-Disk File System Structure"></a>On-Disk File System Structure</h3><h4 id="Sectors-and-Blocks"><a href="#Sectors-and-Blocks" class="headerlink" title="Sectors and Blocks"></a>Sectors and Blocks</h4><p>磁盘每个扇区大小为512字节,JOS使用的块大小为512字节.</p>
<h4 id="Superblocks"><a href="#Superblocks" class="headerlink" title="Superblocks"></a>Superblocks</h4><p>HQOS仅有一个超级块,位于磁盘1(第二个磁盘)的块1(第二个扇区).</p>
<pre class=" language-c"><code class="language-c"><span class="token macro property">#<span class="token directive keyword">define</span> FS_MAGIC	0x53465148	</span><span class="token comment" spellcheck="true">// related vaguely to 'HQFS'</span>

<span class="token keyword">struct</span> Super <span class="token punctuation">{</span>
    uint32_t s_magic<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// Magic number: FS_MAGIC</span>
    uint32_t s_nblocks<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// Total number of blocks on disk</span>
    <span class="token keyword">struct</span> File s_root<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// Root directory node</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<h4 id="File-Meta-data"><a href="#File-Meta-data" class="headerlink" title="File Meta-data"></a>File Meta-data</h4><p>文件的元数据保存在其所在的目录文件中.<br>f_direct数组中记录的为保存该文件数据的磁盘的块号(直接块).<br>f_indirect为间接块的块号,该块的数据为该文件对应的其他直接块的块号,相当于direct数组的扩展.</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Number of block pointers in a File descriptor</span>
<span class="token macro property">#<span class="token directive keyword">define</span> NDIRECT		10</span>
<span class="token comment" spellcheck="true">// Number of direct block pointers in an indirect block</span>
<span class="token macro property">#<span class="token directive keyword">define</span> NINDIRECT	(BLKSIZE / 4)</span>

<span class="token keyword">struct</span> File <span class="token punctuation">{</span>
    <span class="token keyword">char</span> f_name<span class="token punctuation">[</span>MAXNAMELEN<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment" spellcheck="true">// filename</span>
    off_t f_size<span class="token punctuation">;</span>			<span class="token comment" spellcheck="true">// file size in bytes</span>
    uint32_t f_type<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// file type</span>

    <span class="token comment" spellcheck="true">// Block pointers.</span>
    <span class="token comment" spellcheck="true">// A block is allocated iff its value is != 0.</span>
    uint32_t f_direct<span class="token punctuation">[</span>NDIRECT<span class="token punctuation">]</span><span class="token punctuation">;</span>	<span class="token comment" spellcheck="true">// direct blocks</span>
    uint32_t f_indirect<span class="token punctuation">;</span>		<span class="token comment" spellcheck="true">// indirect block</span>

    <span class="token comment" spellcheck="true">// Pad out to 256 bytes; must do arithmetic in case we're compiling</span>
    <span class="token comment" spellcheck="true">// fsformat on a 64-bit machine.</span>
    uint8_t f_pad<span class="token punctuation">[</span><span class="token number">256</span> <span class="token operator">-</span> MAXNAMELEN <span class="token operator">-</span> <span class="token number">8</span> <span class="token operator">-</span> <span class="token number">4</span><span class="token operator">*</span>NDIRECT <span class="token operator">-</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token function">__attribute__</span><span class="token punctuation">(</span><span class="token punctuation">(</span>packed<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment" spellcheck="true">// required only on some 64-bit machines</span>
</code></pre>
<h4 id="Directories"><a href="#Directories" class="headerlink" title="Directories"></a>Directories</h4><p>保存文件的元数据,目录本身也是一个文件,其元数据保存在其上层目录中.根目录的内容保存在超级块中.</p>
<h3 id="File-System-Structure"><a href="#File-System-Structure" class="headerlink" title="File System Structure"></a>File System Structure</h3><h4 id="Disk-Access"><a href="#Disk-Access" class="headerlink" title="Disk Access"></a>Disk Access</h4><p>HQOS没有在内核中添加IDE磁盘驱动程序及相关系统调用,而是将其实现于用户态的文件系统中.文件系统进程使用了EFLAGS中的IOPL位,有权限执行IO指令.</p>
<h4 id="Block-Cache"><a href="#Block-Cache" class="headerlink" title="Block Cache"></a>Block Cache</h4><p>HQOS借助虚拟地址空间来实现块缓存(不得不夸一下JOS的设计者们,好多巧妙的实现).文件系统的DISKMAP(0x10000000 )至DISKMAP+DISKMAX(0xD0000000)用来缓存磁盘,共3GB空间,故HQOS仅支持3GB以下的磁盘.</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Return the virtual address of this disk block.</span>
<span class="token keyword">void</span><span class="token operator">*</span>
<span class="token function">diskaddr</span><span class="token punctuation">(</span>uint32_t blockno<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>blockno <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token punctuation">(</span>super <span class="token operator">&amp;&amp;</span> blockno <span class="token operator">>=</span> super<span class="token operator">-></span>s_nblocks<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">"bad block number %08x in diskaddr"</span><span class="token punctuation">,</span> blockno<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>DISKMAP <span class="token operator">+</span> blockno <span class="token operator">*</span> BLKSIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>HQOS并不直接读取完整的3GB磁盘空间到地址空间中,而是当访问磁盘块所在页时,触发页面错误,由错误处理例程从磁盘中读入并完成映射.</p>
<pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// Fault any disk block that is read in to memory by</span>
<span class="token comment" spellcheck="true">// loading it from disk.</span>
<span class="token keyword">static</span> <span class="token keyword">void</span>
<span class="token function">bc_pgfault</span><span class="token punctuation">(</span><span class="token keyword">struct</span> UTrapframe <span class="token operator">*</span>utf<span class="token punctuation">)</span>
</code></pre>
<p>文件系统依赖页面的PTE_D(dirty)位来决定是否需要刷新块(写回到磁盘).</p>
<p>由于目前HQOS还未实现页面置换算法,我很担心Block Cache对内存的消耗.</p>
<h4 id="Block-Bitmap"><a href="#Block-Bitmap" class="headerlink" title="Block Bitmap"></a>Block Bitmap</h4><p>HQOS使用Bitmap来记录磁盘中Block的使用状态,进而完成分配释放等操作.</p>
<h3 id="The-file-system-interface"><a href="#The-file-system-interface" class="headerlink" title="The file system interface"></a>The file system interface</h3><p>文件系统接口是以进程间通信的方式提供的.文件系统持续无休止的接收其他进程的IPC请求,将请求调度到特定的处理例程,完成请求的文件操作.</p>
<h2 id="Network"><a href="#Network" class="headerlink" title="Network"></a>Network</h2><p>我暂时还不熟悉计算机网络相关知识,所以对Network部分的说明不会太多.</p>
<h3 id="Network-System"><a href="#Network-System" class="headerlink" title="Network System"></a>Network System</h3><p>这是HQOS网络体系的总览.HQOS使用E1000网卡,在Kernel中实现由E1000的驱动程序,负责将packet传给E1000或从E1000接收packet.与E1000驱动程序进行交互的是用户态的Network server,由核心网络进程、输出进程、输入进程构成.<br>核心网络进程的实现使用了开源的IwIP的TCP/IP协议套件.</p>
<p>其他用户进程通过IPC机制与Network server交互.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202311152114274.png"></p>
<h2 id="System-calls-Interrupts-Exceptions"><a href="#System-calls-Interrupts-Exceptions" class="headerlink" title="System calls, Interrupts, Exceptions"></a>System calls, Interrupts, Exceptions</h2><p>实话说我不认为System calls, Interrupts, Exceptions的概念是与其他操作系统概念并列的,不过作为OS实现的重要部分,我需要单独的一章来说明,之前已经在其他操作系统概念的说明中介绍过的部分不再说明.</p>
<h3 id="Protected-Control-Transfer"><a href="#Protected-Control-Transfer" class="headerlink" title="Protected Control Transfer"></a>Protected Control Transfer</h3><h4 id="The-Interrupt-Descriptor-Table"><a href="#The-Interrupt-Descriptor-Table" class="headerlink" title="The Interrupt Descriptor Table"></a>The Interrupt Descriptor Table</h4><p>异常和中断导致处理器从用户模式切换到内核模式,内核模式的入口点和中断处理例程由内核明确规定.在HQOS中,所有的中断或异常都会导致切换到内核态,并由内核态进行处理(即使HQOS允许用户态页面错误处理例程,那也是先进入内核再由内核处理例程dispatch),这是在中断描述符表IDT中实现的.</p>
<p>HQOS目前仅支持中断门,意味着HQOS不支持嵌套中断.</p>
<h4 id="The-Task-State-Segment"><a href="#The-Task-State-Segment" class="headerlink" title="The Task State Segment"></a>The Task State Segment</h4><p>发生中断时,处理器将状态保存到TSS段中ESP3和SS3中,并加载ESP0和SS0,从内核返回是逆过程.HQOS目前仅使用TSS作为用户/内核堆栈的切换.HQOS目前为每个CPU分配了一个内核堆栈.</p>
<h3 id="syscall"><a href="#syscall" class="headerlink" title="syscall"></a>syscall</h3><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// syscall.c</span>
<span class="token keyword">void</span>	<span class="token function">sys_cputs</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>string<span class="token punctuation">,</span> size_t len<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">sys_cgetc</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
envid_t	<span class="token function">sys_getenvid</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">sys_env_destroy</span><span class="token punctuation">(</span>envid_t<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span>	<span class="token function">sys_yield</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> envid_t <span class="token function">sys_exofork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">sys_env_set_status</span><span class="token punctuation">(</span>envid_t env<span class="token punctuation">,</span> <span class="token keyword">int</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">sys_env_set_trapframe</span><span class="token punctuation">(</span>envid_t env<span class="token punctuation">,</span> <span class="token keyword">struct</span> Trapframe <span class="token operator">*</span>tf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">sys_env_set_pgfault_upcall</span><span class="token punctuation">(</span>envid_t env<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>upcall<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">sys_page_alloc</span><span class="token punctuation">(</span>envid_t env<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pg<span class="token punctuation">,</span> <span class="token keyword">int</span> perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">sys_page_map</span><span class="token punctuation">(</span>envid_t src_env<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>src_pg<span class="token punctuation">,</span>
             envid_t dst_env<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>dst_pg<span class="token punctuation">,</span> <span class="token keyword">int</span> perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">sys_page_unmap</span><span class="token punctuation">(</span>envid_t env<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">sys_ipc_try_send</span><span class="token punctuation">(</span>envid_t to_env<span class="token punctuation">,</span> uint32_t value<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pg<span class="token punctuation">,</span> <span class="token keyword">int</span> perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">sys_ipc_recv</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>rcv_pg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">sys_time_msec</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">sys_tx_pkt</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> buf<span class="token punctuation">,</span>size_t nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2 id="User-library"><a href="#User-library" class="headerlink" title="User library"></a>User library</h2><pre class=" language-c"><code class="language-c"><span class="token comment" spellcheck="true">// exit.c</span>
<span class="token keyword">void</span>	<span class="token function">exit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// pgfault.c</span>
<span class="token keyword">void</span>	<span class="token function">set_pgfault_handler</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token punctuation">(</span><span class="token operator">*</span>handler<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">struct</span> UTrapframe <span class="token operator">*</span>utf<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// readline.c</span>
<span class="token keyword">char</span><span class="token operator">*</span>	<span class="token function">readline</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>buf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// ipc.c</span>
<span class="token keyword">void</span>	<span class="token function">ipc_send</span><span class="token punctuation">(</span>envid_t to_env<span class="token punctuation">,</span> uint32_t value<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pg<span class="token punctuation">,</span> <span class="token keyword">int</span> perm<span class="token punctuation">)</span><span class="token punctuation">;</span>
int32_t <span class="token function">ipc_recv</span><span class="token punctuation">(</span>envid_t <span class="token operator">*</span>from_env_store<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>pg<span class="token punctuation">,</span> <span class="token keyword">int</span> <span class="token operator">*</span>perm_store<span class="token punctuation">)</span><span class="token punctuation">;</span>
envid_t	<span class="token function">ipc_find_env</span><span class="token punctuation">(</span><span class="token keyword">enum</span> EnvType type<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// fork.c</span>
<span class="token macro property">#<span class="token directive keyword">define</span>	PTE_SHARE	0x400</span>
envid_t	<span class="token function">fork</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// fd.c</span>
<span class="token keyword">int</span>	<span class="token function">close</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
ssize_t	<span class="token function">read</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
ssize_t	<span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">seek</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> off_t offset<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span>	<span class="token function">close_all</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
ssize_t	<span class="token function">readn</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> size_t nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">dup</span><span class="token punctuation">(</span><span class="token keyword">int</span> oldfd<span class="token punctuation">,</span> <span class="token keyword">int</span> newfd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">fstat</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> <span class="token keyword">struct</span> Stat <span class="token operator">*</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">stat</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token keyword">struct</span> Stat <span class="token operator">*</span>statbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// file.c</span>
<span class="token keyword">int</span>	<span class="token function">open</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">,</span> <span class="token keyword">int</span> mode<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">ftruncate</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">,</span> off_t size<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">remove</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>path<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">sync</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// pageref.c</span>
<span class="token keyword">int</span>	<span class="token function">pageref</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// sockets.c</span>
<span class="token keyword">int</span>     <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>addr<span class="token punctuation">,</span> socklen_t <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>     <span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>name<span class="token punctuation">,</span> socklen_t namelen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>     <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">int</span> how<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>     <span class="token function">connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>name<span class="token punctuation">,</span> socklen_t namelen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>     <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>     <span class="token function">socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// nsipc.c</span>
<span class="token keyword">int</span>     <span class="token function">nsipc_accept</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>addr<span class="token punctuation">,</span> socklen_t <span class="token operator">*</span>addrlen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>     <span class="token function">nsipc_bind</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>name<span class="token punctuation">,</span> socklen_t namelen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>     <span class="token function">nsipc_shutdown</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">int</span> how<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>     <span class="token function">nsipc_close</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>     <span class="token function">nsipc_connect</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">struct</span> sockaddr <span class="token operator">*</span>name<span class="token punctuation">,</span> socklen_t namelen<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>     <span class="token function">nsipc_listen</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">int</span> backlog<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>     <span class="token function">nsipc_recv</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>mem<span class="token punctuation">,</span> <span class="token keyword">int</span> len<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>     <span class="token function">nsipc_send</span><span class="token punctuation">(</span><span class="token keyword">int</span> s<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">void</span> <span class="token operator">*</span>buf<span class="token punctuation">,</span> <span class="token keyword">int</span> size<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> flags<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>     <span class="token function">nsipc_socket</span><span class="token punctuation">(</span><span class="token keyword">int</span> domain<span class="token punctuation">,</span> <span class="token keyword">int</span> type<span class="token punctuation">,</span> <span class="token keyword">int</span> protocol<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// spawn.c</span>
envid_t	<span class="token function">spawn</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>program<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span><span class="token operator">*</span>argv<span class="token punctuation">)</span><span class="token punctuation">;</span>
envid_t	<span class="token function">spawnl</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>program<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>arg0<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// console.c</span>
<span class="token keyword">void</span>	<span class="token function">cputchar</span><span class="token punctuation">(</span><span class="token keyword">int</span> c<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">getchar</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">iscons</span><span class="token punctuation">(</span><span class="token keyword">int</span> fd<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">opencons</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// pipe.c</span>
<span class="token keyword">int</span>	<span class="token function">pipe</span><span class="token punctuation">(</span><span class="token keyword">int</span> pipefds<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span>	<span class="token function">pipeisclosed</span><span class="token punctuation">(</span><span class="token keyword">int</span> pipefd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">// wait.c</span>
<span class="token keyword">void</span>	<span class="token function">wait</span><span class="token punctuation">(</span>envid_t env<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">//sleep.c</span>
<span class="token keyword">void</span> <span class="token function">sleep</span><span class="token punctuation">(</span><span class="token keyword">int</span> ms<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> <span class="token function">transpackt</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> buf<span class="token punctuation">,</span>size_t nbytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">recvpackt</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span> buf<span class="token punctuation">,</span>size_t max_bytes<span class="token punctuation">,</span><span class="token keyword">int</span><span class="token operator">*</span> lenth_store<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><p><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2018/readings/i386/toc.htm">Intel 80386 Reference Manual</a><br><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2018/readings/hardware/8254x_GBe_SDM.pdf">Intel’s Software Developer’s Manual for the E1000</a></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/HQOS/" rel="tag">HQOS</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-Life"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/Life/"
    >如果有一天</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/Life/" class="article-date">
  <time datetime="2023-11-07T16:00:00.000Z" itemprop="datePublished">2023-11-08</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E9%9A%8F%E7%AC%94/">随笔</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  Here's something encrypted, password is required to continue reading. 
      <a class="article-more-link" href="/2023/Life/"
        >阅读更多...</a
      >
       
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-Syntax-Analysis"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/Syntax-Analysis/"
    >语法分析</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/Syntax-Analysis/" class="article-date">
  <time datetime="2023-11-02T16:00:00.000Z" itemprop="datePublished">2023-11-03</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> / <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/">编译原理</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><h2 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h2><p>语法分析器接收词法分析器提供的记号串,检查它们是否能由源程序语言的文法产生.</p>
<p>语法分析器的输出是对词法分析器产生的记号流的分析树的某种表示.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202310201353760.png"></p> 
      <a class="article-more-link" href="/2023/Syntax-Analysis/"
        >阅读更多...</a
      >
       
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Syntax-Analysis/" rel="tag">Syntax-Analysis</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-6.828-Lab5"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/6.828-Lab5/"
    >MIT6.828 Lab5</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/6.828-Lab5/" class="article-date">
  <time datetime="2023-10-24T16:00:00.000Z" itemprop="datePublished">2023-10-25</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> / <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a> / <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/6-828/">6.828</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>最崩溃的一集…Lab倒是很简单,只是文件系统一启用,之前代码的好多问题都显现出来了,然后就是debugggg.</p>
<h2 id="Lab-5-File-system-Spawn-and-Shell"><a href="#Lab-5-File-system-Spawn-and-Shell" class="headerlink" title="Lab 5: File system, Spawn and Shell"></a>Lab 5: File system, Spawn and Shell</h2><h3 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h3><p>切换分支之后编译有点问题,改一改:</p>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202310241258348.png"><br>在GNUmakefile中加上-Wno-address-of-packed-member</p>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202310241423170.png"></p>
<p>将fs.h中定义的全局变量改为外部变量,并在fs.c中定义.</p>
<pre><code class="c">extern struct Super *super;		// superblock
extern uint32_t *bitmap;		// bitmap blocks mapped in memory
</code></pre>
<p>改下输出,lab4满分通过.</p>
<h3 id="File-system-preliminaries"><a href="#File-system-preliminaries" class="headerlink" title="File system preliminaries"></a>File system preliminaries</h3><p>文件系统的设计就不在这里说了,详见《HQOS 设计与实现》.</p> 
      <a class="article-more-link" href="/2023/6.828-Lab5/"
        >阅读更多...</a
      >
       
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/6%C2%B7828/" rel="tag">6·828</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-Shanghai-Master-WP"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/Shanghai-Master-WP/"
    >中华武数杯2023 WP</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/Shanghai-Master-WP/" class="article-date">
  <time datetime="2023-10-18T16:00:00.000Z" itemprop="datePublished">2023-10-19</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/ctf%E5%A4%8D%E7%8E%B0/">ctf复现</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>最喜欢的高版本堆题,挺有意思的.<br><del>所以到底叫上海大师杯还是中华武数杯</del></p>
<h1 id="randomHeap"><a href="#randomHeap" class="headerlink" title="randomHeap"></a>randomHeap</h1><p>glibc2.35堆,保护全开</p>
<h2 id="逆向"><a href="#逆向" class="headerlink" title="逆向"></a>逆向</h2><p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202310171525325.png"></p>
<p>程序实现了这样的堆管理结构.初始化时,分配了16个堆管理结构和16个大小为0x28字节的堆块,放入chunk_list和chunk_manager_list.正常情况下这两个结构应该是用户不可见的.</p> 
      <a class="article-more-link" href="/2023/Shanghai-Master-WP/"
        >阅读更多...</a
      >
       
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pwn/" rel="tag">Pwn</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-Shortest-Path-Algorithm"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/Shortest-Path-Algorithm/"
    >最短路径算法</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/Shortest-Path-Algorithm/" class="article-date">
  <time datetime="2023-10-17T16:00:00.000Z" itemprop="datePublished">2023-10-18</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> / <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">数据结构与算法</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>为啥突然开始学算法?详见中华武数杯Shortest_path</p>
<h1 id="单源最短路径"><a href="#单源最短路径" class="headerlink" title="单源最短路径"></a>单源最短路径</h1><h2 id="Dijkstra算法"><a href="#Dijkstra算法" class="headerlink" title="Dijkstra算法"></a>Dijkstra算法</h2><p>定义一个集合S:从源点到该节点的最短路径已被找到的结点Vi的集合.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202310172223227.png"><br>一个映射表(map)dist.dist[s,Vi]表示从s出发只经过集合S内的结点到达结点Vi的最短路径长度.(其实对这个算法而言是个数组)</p>
<p>初始状态集合S中仅有源点s,dist[s,s]=0.向dist数组中添加所有从源点s能直接到达的结点的路径长度.</p> 
      <a class="article-more-link" href="/2023/Shortest-Path-Algorithm/"
        >阅读更多...</a
      >
       
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Algorithm/" rel="tag">Algorithm</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-6.828-Lab4"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/6.828-Lab4/"
    >MIT6.828 Lab4</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/6.828-Lab4/" class="article-date">
  <time datetime="2023-10-13T16:00:00.000Z" itemprop="datePublished">2023-10-14</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> / <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a> / <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/6-828/">6.828</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="Lec-9"><a href="#Lec-9" class="headerlink" title="Lec 9"></a>Lec 9</h1><h2 id="“Locking”"><a href="#“Locking”" class="headerlink" title="“Locking”"></a>“Locking”</h2><blockquote>
<p>When we say that a lock protects data, we really mean that the lock protects some<br>collection of invariants that apply to the data. Invariants are properties of data struc-<br>tures that are maintained across operations. Typically, an operation’s correct behavior<br>depends on the invariants being true when the operation begins. The operation may<br>temporarily violate the invariants but must reestablish them before finishing. For ex-<br>ample, in the linked list case, the invariant is that list points at the first node in the<br>list and that each node’s next field points at the next node. The implementation of<br>insert violates this invariant temporarily: in line 15, l points to the next list element,<br>but list does not point at l yet (reestablished at line 16). The race condition we ex-<br>amined above happened because a second CPU executed code that depended on the<br>list invariants while they were (temporarily) violated. Proper use of a lock ensures that<br>only one CPU at a time can operate on the data structure in the critical section, so<br>that no CPU will execute a data structure operation when the data structure’s invari-<br>ants do not hold.</p>
</blockquote> 
      <a class="article-more-link" href="/2023/6.828-Lab4/"
        >阅读更多...</a
      >
       
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/6%C2%B7828/" rel="tag">6·828</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-Lexical-Analysis"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/Lexical-Analysis/"
    >词法分析</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/Lexical-Analysis/" class="article-date">
  <time datetime="2023-10-12T16:00:00.000Z" itemprop="datePublished">2023-10-13</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> / <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/">编译原理</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h1><h2 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h2><p>词法分析是编译的第一阶段.词法分析主要任务是读入输入字符,产生记号(token)序列,提交给语法分析使用.<br>由于这种交互模式,词法分析器可以作为语法分析器的子程序或协作程序.语法分析器每次调用词法分析器持续读入字符,直到识别出下一个记号.</p>
<p>词法分析除了产生记号,也收集记号相关的信息作为记号的属性(比如数字的值,标识符对应的字符串).记号影响语法分析,记号的属性影响记号的翻译.属性一般存储在符号表中.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202310121650256.png"></p> 
      <a class="article-more-link" href="/2023/Lexical-Analysis/"
        >阅读更多...</a
      >
       
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Lexical-Analysis/" rel="tag">Lexical-Analysis</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-The Art Of Linux Kernel Design--Notes"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/The%20Art%20Of%20Linux%20Kernel%20Design--Notes/"
    >Linux内核设计的艺术 阅读笔记</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/The%20Art%20Of%20Linux%20Kernel%20Design--Notes/" class="article-date">
  <time datetime="2023-10-03T16:00:00.000Z" itemprop="datePublished">2023-10-04</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> / <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>Linux0.11内核.正文部分记录过程,引用部分记录知识点和理解.</p>
<h1 id="main函数之前的功能"><a href="#main函数之前的功能" class="headerlink" title="main函数之前的功能"></a>main函数之前的功能</h1><h2 id="加载操作系统"><a href="#加载操作系统" class="headerlink" title="加载操作系统"></a>加载操作系统</h2><p>经典流程:<br>计算机加电设置cs:ip为0xffff0,运行ROM中的BIOS,BIOS初始化中断向量表和一些硬件设备,加载0盘0道1扇区的引导程序bootsect到0x7c00处.bootsect是与操作系统配套的,规划物理内存,加载操作系统,设置根设备为软盘.</p>
<blockquote>
<p>Linux0.11要求系统必须存在一个根文件系统,其他文件系统挂接其上.因此Linux的启动需要两部分数据,即系统内核镜像和根文件系统.(kernel pwn中的bzimage和文件系统(比如busybox提供的))</p>
</blockquote> 
      <a class="article-more-link" href="/2023/The%20Art%20Of%20Linux%20Kernel%20Design--Notes/"
        >阅读更多...</a
      >
       
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kernel/" rel="tag">Kernel</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-6.828-Lab3"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/6.828-Lab3/"
    >MIT6.828 Lab3</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/6.828-Lab3/" class="article-date">
  <time datetime="2023-10-02T16:00:00.000Z" itemprop="datePublished">2023-10-03</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> / <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/">操作系统</a> / <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/6-828/">6.828</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="Lec-7"><a href="#Lec-7" class="headerlink" title="Lec 7"></a>Lec 7</h1><p>一些虚拟内存实现的技巧,如延迟分配,写时复制等<br><a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2018/lec/l-usingvm.pdf">https://pdos.csail.mit.edu/6.828/2018/lec/l-usingvm.pdf</a></p>
<h2 id="Lab3-User-Environments"><a href="#Lab3-User-Environments" class="headerlink" title="Lab3 User Environments"></a>Lab3 User Environments</h2><h3 id="PartA-User-Environments-and-Exception-Handling"><a href="#PartA-User-Environments-and-Exception-Handling" class="headerlink" title="PartA: User Environments and Exception Handling"></a>PartA: User Environments and Exception Handling</h3><h4 id="Creating-and-Running-Environments"><a href="#Creating-and-Running-Environments" class="headerlink" title="Creating and Running Environments"></a>Creating and Running Environments</h4><p>创建并初始化envs,env_setup_vm函数为环境e建立一个专属的页目录表,由于在UTOP上的内核空间映射对每个环境都是相同的,所以可以直接拷贝kern_pgdir过来.</p> 
      <a class="article-more-link" href="/2023/6.828-Lab3/"
        >阅读更多...</a
      >
       
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/6%C2%B7828/" rel="tag">6·828</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
    <article
  id="post-ycb2023"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h2 itemprop="name">
  <a class="article-title" href="/2023/ycb2023/"
    >羊城杯2023 复现</a> 
</h2>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/ycb2023/" class="article-date">
  <time datetime="2023-09-30T16:00:00.000Z" itemprop="datePublished">2023-10-01</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/ctf%E5%A4%8D%E7%8E%B0/">ctf复现</a>
  </div>
   
    </div>
      
    <div class="article-entry" itemprop="articleBody">
       
  <p>heap没出没进线下…</p>
<h2 id="login"><a href="#login" class="headerlink" title="login"></a>login</h2><p>qemu-riscv64 -g 2333 ./pwn<br>gdbinit这样设置方便调试,然后gdb-multiarch -x gdbinit就能调了</p>
<pre><code class="gdb">set arch riscv:rv64
target remote 127.0.0.1:2333
define hook-stop
    info reg
    echo "\n\n\n\n\n"
    x/10i $pc
end

b *0x123457EA
c
</code></pre> 
      <a class="article-more-link" href="/2023/ycb2023/"
        >阅读更多...</a
      >
       
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <footer class="article-footer">
       
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pwn/" rel="tag">Pwn</a></li></ul>

    </footer>
  </div>

   
    
</article>

    
  </article>
  

  
  <nav class="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">下一页</a>
  </nav>
  
</section>
</div>

      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2022-2023
        <i class="ri-heart-fill heart_icon"></i> 翰青HanQi
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="北极落小雪"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2022/About">关于</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->
 
<script src="/js/clickLove.js"></script>
 
<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>

</html>