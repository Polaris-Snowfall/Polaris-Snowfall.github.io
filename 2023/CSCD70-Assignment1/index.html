<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8" />
        
      <meta name="description" content="Boom? PWN ! ! !" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>CSCD70-Assignment1 Introduction to LLVM |  北极落小雪</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style><!-- hexo-inject:begin --><!-- hexo-inject:end -->
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>
  </html>
</html>


<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-CSCD70-Assignment1"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  CSCD70-Assignment1 Introduction to LLVM
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/CSCD70-Assignment1/" class="article-date">
  <time datetime="2023-12-09T16:00:00.000Z" itemprop="datePublished">2023-12-10</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> / <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/">静态分析</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">1.7k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">9 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <span id="more"></span>
<h1 id="函数信息"><a href="#函数信息" class="headerlink" title="函数信息"></a>函数信息</h1><p>没啥好说的.</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">class</span> <span class="token class-name">FunctionInfoPass</span> final <span class="token operator">:</span> <span class="token keyword">public</span> PassInfoMixin<span class="token operator">&lt;</span>FunctionInfoPass<span class="token operator">></span> <span class="token punctuation">{</span>
<span class="token keyword">public</span><span class="token operator">:</span>
  PreservedAnalyses <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>maybe_unused<span class="token punctuation">]</span><span class="token punctuation">]</span> Module <span class="token operator">&amp;</span>M<span class="token punctuation">,</span> ModuleAnalysisManager <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"CSCD70 Function Information Pass"</span>
           <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>

    <span class="token comment" spellcheck="true">/// @todo(CSCD70) Please complete this method.</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> F <span class="token operator">:</span> M<span class="token punctuation">.</span><span class="token function">functions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Function Name: "</span> <span class="token operator">&lt;&lt;</span> F<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
      <span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Number of Arguments: "</span> <span class="token operator">&lt;&lt;</span> F<span class="token punctuation">.</span><span class="token function">arg_size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
      <span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Number of Calls: "</span> <span class="token operator">&lt;&lt;</span> F<span class="token punctuation">.</span><span class="token function">getNumUses</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
      <span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Number OF BBs: "</span> <span class="token operator">&lt;&lt;</span> F<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
      <span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Number of Instructions: "</span> <span class="token operator">&lt;&lt;</span> F<span class="token punctuation">.</span><span class="token function">getInstructionCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> PreservedAnalyses<span class="token operator">::</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// class FunctionInfoPass</span>
</code></pre>
<h1 id="局部优化"><a href="#局部优化" class="headerlink" title="局部优化"></a>局部优化</h1><h2 id="代数恒等式"><a href="#代数恒等式" class="headerlink" title="代数恒等式"></a>代数恒等式</h2><h3 id="识别"><a href="#识别" class="headerlink" title="识别"></a>识别</h3><p>加减运算中,其中一个操作数为常量0;乘除运算中,其中一个操作数为常量1.</p>
<p>在判别常量的值的时候,需要这样的转化:</p>
<pre class=" language-cpp"><code class="language-cpp">Value<span class="token operator">*</span> oper1 <span class="token operator">=</span>In<span class="token punctuation">.</span><span class="token function">getOperand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
ConstVal1 <span class="token operator">=</span> dyn_cast<span class="token operator">&lt;</span>ConstantInt<span class="token operator">></span><span class="token punctuation">(</span>oper1<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getSExtValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>但是在二元运算中,操作数不一定是ConstantInt,所以需要先判别一下:</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">if</span><span class="token punctuation">(</span>isa<span class="token operator">&lt;</span>ConstantInt<span class="token operator">></span><span class="token punctuation">(</span>oper1<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre>
<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><p>用代数恒等式的最终值代替所有引用该指令结果的地方,然后删除该指令.</p>
<pre class=" language-cpp"><code class="language-cpp">In<span class="token punctuation">.</span><span class="token function">replaceAllUsesWith</span><span class="token punctuation">(</span>AlgebraicIdentity<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>删除指令应该在遍历完所有指令之后,否则可能会导致迭代器失效.<br>一个相关的demo如下:</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span></span>
<span class="token macro property">#<span class="token directive keyword">include</span> <span class="token string">&lt;vector></span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span> <span class="token function">vec</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span>std<span class="token operator">::</span>vector<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">></span><span class="token operator">::</span>iterator iter <span class="token operator">=</span> vec<span class="token punctuation">.</span><span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>iter<span class="token operator">!=</span>vec<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token operator">++</span>iter<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> <span class="token operator">*</span>iter <span class="token operator">&lt;&lt;</span><span class="token string">" "</span><span class="token punctuation">;</span>
        vec<span class="token punctuation">.</span><span class="token function">erase</span><span class="token punctuation">(</span>iter<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre><code>g++ test.cpp &amp;&amp; ./a.out
22145664082593 0872 180082552 2 6101240994215 82538  19428801684252 4048 9411899120 87594 220361632 217 91908160516051605 88948 81625610688 288 288 288 211024042 80848 8242 242 242 242 0 80094 85240422961 961 961 961 87619 85558 23824 894 894 894 89286254005 213 959527952795279527221 52042352892352045204520452049 87673 54062283040 040 040 040 84094 84344 840972344 844 844 844 844 844 844 844 844 840972344 840972344 891303733 94279427942794279427942794279427942748211 876164408 540161074 540161016101610161074 540161074 540161074 
......
段错误
</code></pre>
<p>将所有要删除的指令加入一个vector,最后统一删除.</p>
<pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">void</span> <span class="token function">delIns</span><span class="token punctuation">(</span>std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>Instruction<span class="token operator">*</span><span class="token operator">></span> InsList<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> ins <span class="token operator">:</span> InsList<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>ins<span class="token operator">-</span><span class="token operator">></span><span class="token function">isSafeToRemove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      ins<span class="token operator">-</span><span class="token operator">></span><span class="token function">eraseFromParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>注意这里使用的是eraseFromParent,使用removeFromParent会导致如下错误:</p>
<pre class=" language-c"><code class="language-c">Instruction referencing instruction not embedded in a basic block<span class="token operator">!</span>
  <span class="token operator">%</span><span class="token number">5</span> <span class="token operator">=</span> sdiv i32 <span class="token operator">%</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span>
</code></pre>
<pre class=" language-cpp"><code class="language-cpp">  <span class="token comment" spellcheck="true">/// This method unlinks 'this' from the containing basic block, but does not</span>
  <span class="token comment" spellcheck="true">/// delete it.</span>
  <span class="token keyword">void</span> <span class="token function">removeFromParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment" spellcheck="true">/// This method unlinks 'this' from the containing basic block and deletes it.</span>
  <span class="token comment" spellcheck="true">///</span>
  <span class="token comment" spellcheck="true">/// \returns an iterator pointing to the element after the erased one</span>
  SymbolTableList<span class="token operator">&lt;</span>Instruction<span class="token operator">></span><span class="token operator">::</span>iterator <span class="token function">eraseFromParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><pre class=" language-cpp"><code class="language-cpp">PreservedAnalyses AlgebraicIdentityPass<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>maybe_unused<span class="token punctuation">]</span><span class="token punctuation">]</span> Function <span class="token operator">&amp;</span>F<span class="token punctuation">,</span>
                                             FunctionAnalysisManager <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment" spellcheck="true">/// @todo(CSCD70) Please complete this method.</span>
  <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>Instruction<span class="token operator">*</span><span class="token operator">></span> del_InsList<span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> BB <span class="token operator">:</span> F<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> In <span class="token operator">:</span> BB<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>In<span class="token punctuation">.</span><span class="token function">isBinaryOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        Value<span class="token operator">*</span> AlgebraicIdentity <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">bool</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> oper1 <span class="token operator">=</span>In<span class="token punctuation">.</span><span class="token function">getOperand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> oper2 <span class="token operator">=</span>In<span class="token punctuation">.</span><span class="token function">getOperand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        int64_t ConstVal1<span class="token punctuation">,</span>ConstVal2<span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>isa<span class="token operator">&lt;</span>ConstantInt<span class="token operator">></span><span class="token punctuation">(</span>oper1<span class="token punctuation">)</span><span class="token punctuation">)</span>
          ConstVal1 <span class="token operator">=</span> dyn_cast<span class="token operator">&lt;</span>ConstantInt<span class="token operator">></span><span class="token punctuation">(</span>oper1<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getSExtValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>isa<span class="token operator">&lt;</span>ConstantInt<span class="token operator">></span><span class="token punctuation">(</span>oper2<span class="token punctuation">)</span><span class="token punctuation">)</span>
          ConstVal2 <span class="token operator">=</span> dyn_cast<span class="token operator">&lt;</span>ConstantInt<span class="token operator">></span><span class="token punctuation">(</span>oper2<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getSExtValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">switch</span> <span class="token punctuation">(</span>In<span class="token punctuation">.</span><span class="token function">getOpcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          <span class="token comment" spellcheck="true">//x+0 x-0 --> x</span>
        <span class="token keyword">case</span> Instruction<span class="token operator">::</span>Add<span class="token operator">:</span>
        <span class="token keyword">case</span> Instruction<span class="token operator">::</span>Sub<span class="token operator">:</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>isa<span class="token operator">&lt;</span>ConstantInt<span class="token operator">></span><span class="token punctuation">(</span>oper1<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token operator">!</span>ConstVal1<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>isa<span class="token operator">&lt;</span>ConstantInt<span class="token operator">></span><span class="token punctuation">(</span>oper2<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token operator">!</span>ConstVal2<span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">{</span>
            AlgebraicIdentity <span class="token operator">=</span> oper1 <span class="token operator">?</span> oper1 <span class="token operator">:</span> oper2<span class="token punctuation">;</span>
            flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        
        <span class="token keyword">case</span> Instruction<span class="token operator">::</span>Mul<span class="token operator">:</span>
        <span class="token keyword">case</span> Instruction<span class="token operator">::</span>SDiv<span class="token operator">:</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>isa<span class="token operator">&lt;</span>ConstantInt<span class="token operator">></span><span class="token punctuation">(</span>oper1<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>ConstVal1<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>isa<span class="token operator">&lt;</span>ConstantInt<span class="token operator">></span><span class="token punctuation">(</span>oper2<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>ConstVal2<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">{</span>
            AlgebraicIdentity <span class="token operator">=</span> ConstVal1<span class="token operator">==</span><span class="token number">1</span><span class="token operator">?</span> oper2 <span class="token operator">:</span> oper1<span class="token punctuation">;</span>
            flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> 
          <span class="token punctuation">}</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
          In<span class="token punctuation">.</span><span class="token function">replaceAllUsesWith</span><span class="token punctuation">(</span>AlgebraicIdentity<span class="token punctuation">)</span><span class="token punctuation">;</span>
          del_InsList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>In<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token operator">++</span>cnt<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">delIns</span><span class="token punctuation">(</span>del_InsList<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"define dso_local void @AlgebraicIdentity(i32 noundef %0) {"</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
  <span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"Algebraic Identity: "</span> <span class="token operator">&lt;&lt;</span> cnt <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> PreservedAnalyses<span class="token operator">::</span><span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><pre><code>make &amp;&amp; opt -load-pass-plugin=./libLocalOpts.so -passes=algebraic-identity ./test/TestCase1.ll -o ./TestCase.bc &amp;&amp; llvm-dis TestCase.bc -o TestCase.ll
</code></pre>
<p>优化前:</p>
<pre><code>define dso_local void @AlgebraicIdentity(i32 noundef %0) {
  %2 = add nsw i32 %0, 0
  %3 = add nsw i32 0, %0
  %4 = mul nsw i32 %0, 1
  %5 = mul nsw i32 1, %0
  %6 = sub nsw i32 %0, 0
  %7 = sdiv i32 %0, 1
  %8 = call i32 (ptr, ...) @printf(ptr noundef @.str, i32 noundef %2, i32 noundef %3, i32 noundef %4, i32 noundef %5, i32 noundef %6, i32 noundef %7)
  ret void
}
</code></pre>
<p>优化后:</p>
<pre><code>define dso_local void @AlgebraicIdentity(i32 noundef %0) {
  %2 = call i32 (ptr, ...) @printf(ptr noundef @.str, i32 noundef %0, i32 noundef 0, i32 noundef %0, i32 noundef %0, i32 noundef %0, i32 noundef 1)
  ret void
}
</code></pre>
<h2 id="强度削弱"><a href="#强度削弱" class="headerlink" title="强度削弱"></a>强度削弱</h2><h3 id="识别-1"><a href="#识别-1" class="headerlink" title="识别"></a>识别</h3><p>乘除运算,其中一个操作数为2的幂.</p>
<h3 id="优化-1"><a href="#优化-1" class="headerlink" title="优化"></a>优化</h3><p>在原指令下方增加一条移位指令,移除并删除原指令.这里要用到IRBuilder.<br>用当前指令来初始化builder,为其设置指令的插入点.</p>
<pre class=" language-cpp"><code class="language-cpp">IRBuilder<span class="token operator">&lt;</span><span class="token operator">></span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>In<span class="token punctuation">)</span><span class="token punctuation">;</span>
Value<span class="token operator">*</span> NewIns <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">CreateShl</span><span class="token punctuation">(</span>oper<span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span>
In<span class="token punctuation">.</span><span class="token function">replaceAllUsesWith</span><span class="token punctuation">(</span>NewIns<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h3 id="完整代码-1"><a href="#完整代码-1" class="headerlink" title="完整代码"></a>完整代码</h3><pre class=" language-cpp"><code class="language-cpp"><span class="token keyword">int</span> <span class="token function">getshift</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token punctuation">(</span>x <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>x <span class="token operator">&amp;</span> <span class="token punctuation">(</span>x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
  <span class="token keyword">while</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    x <span class="token operator">=</span> x<span class="token operator">>></span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token operator">++</span>i<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> i<span class="token punctuation">;</span>

<span class="token punctuation">}</span>

PreservedAnalyses StrengthReductionPass<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>maybe_unused<span class="token punctuation">]</span><span class="token punctuation">]</span> Function <span class="token operator">&amp;</span>F<span class="token punctuation">,</span>
                                             FunctionAnalysisManager <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment" spellcheck="true">/// @todo(CSCD70) Please complete this method.</span>
  <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>Instruction<span class="token operator">*</span><span class="token operator">></span> del_InsList<span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> BB <span class="token operator">:</span> F<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> In <span class="token operator">:</span> BB<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>In<span class="token punctuation">.</span><span class="token function">isBinaryOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">int</span> shift <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        Value<span class="token operator">*</span> oper<span class="token punctuation">;</span>
        <span class="token keyword">auto</span> oper1 <span class="token operator">=</span>In<span class="token punctuation">.</span><span class="token function">getOperand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> oper2 <span class="token operator">=</span>In<span class="token punctuation">.</span><span class="token function">getOperand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> shift1 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span>shift2 <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>isa<span class="token operator">&lt;</span>ConstantInt<span class="token operator">></span><span class="token punctuation">(</span>oper1<span class="token punctuation">)</span><span class="token punctuation">)</span>
          shift1 <span class="token operator">=</span> <span class="token function">getshift</span><span class="token punctuation">(</span>dyn_cast<span class="token operator">&lt;</span>ConstantInt<span class="token operator">></span><span class="token punctuation">(</span>oper1<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getSExtValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>isa<span class="token operator">&lt;</span>ConstantInt<span class="token operator">></span><span class="token punctuation">(</span>oper2<span class="token punctuation">)</span><span class="token punctuation">)</span>
          shift2 <span class="token operator">=</span> <span class="token function">getshift</span><span class="token punctuation">(</span>dyn_cast<span class="token operator">&lt;</span>ConstantInt<span class="token operator">></span><span class="token punctuation">(</span>oper2<span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">></span><span class="token function">getSExtValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token keyword">switch</span> <span class="token punctuation">(</span>In<span class="token punctuation">.</span><span class="token function">getOpcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token keyword">case</span> Instruction<span class="token operator">::</span>Mul<span class="token operator">:</span>
        <span class="token keyword">case</span> Instruction<span class="token operator">::</span>SDiv<span class="token operator">:</span>
        <span class="token keyword">case</span> Instruction<span class="token operator">::</span>UDiv<span class="token operator">:</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>isa<span class="token operator">&lt;</span>ConstantInt<span class="token operator">></span><span class="token punctuation">(</span>oper1<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>shift1<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>isa<span class="token operator">&lt;</span>ConstantInt<span class="token operator">></span><span class="token punctuation">(</span>oper2<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>shift2<span class="token operator">!=</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">{</span>
            shift <span class="token operator">=</span> shift1<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">?</span> shift2 <span class="token operator">:</span> shift1<span class="token punctuation">;</span>
            oper <span class="token operator">=</span> shift1<span class="token operator">==</span><span class="token operator">-</span><span class="token number">1</span><span class="token operator">?</span> oper1 <span class="token operator">:</span> oper2<span class="token punctuation">;</span>
            
            IRBuilder<span class="token operator">&lt;</span><span class="token operator">></span> <span class="token function">builder</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>In<span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            Value<span class="token operator">*</span> NewIns<span class="token punctuation">;</span>
            <span class="token keyword">switch</span> <span class="token punctuation">(</span>In<span class="token punctuation">.</span><span class="token function">getOpcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
            <span class="token keyword">case</span> Instruction<span class="token operator">::</span>Mul<span class="token operator">:</span>
              NewIns <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">CreateShl</span><span class="token punctuation">(</span>oper<span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> Instruction<span class="token operator">::</span>SDiv<span class="token operator">:</span>
            <span class="token keyword">case</span> Instruction<span class="token operator">::</span>UDiv<span class="token operator">:</span>
              NewIns <span class="token operator">=</span>builder<span class="token punctuation">.</span><span class="token function">CreateAShr</span><span class="token punctuation">(</span>oper<span class="token punctuation">,</span>shift<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">break</span><span class="token punctuation">;</span>            
            <span class="token punctuation">}</span>

            In<span class="token punctuation">.</span><span class="token function">replaceAllUsesWith</span><span class="token punctuation">(</span>NewIns<span class="token punctuation">)</span><span class="token punctuation">;</span>
            del_InsList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>In<span class="token punctuation">)</span><span class="token punctuation">;</span>
            cnt<span class="token operator">++</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">delIns</span><span class="token punctuation">(</span>del_InsList<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"define dso_local void @StrengthReduction(i32 noundef %0) {"</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
  <span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"strength-reduction: "</span> <span class="token operator">&lt;&lt;</span> cnt <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> PreservedAnalyses<span class="token operator">::</span><span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><pre><code> make &amp;&amp; opt -load-pass-plugin=./libLocalOpts.so -passes=algebraic-identity,strength-reduction ./test/TestCase2.ll -o ./TestCase.bc &amp;&amp; llvm-dis TestCase.bc -o TestCase.ll
</code></pre>
<p>优化前:</p>
<pre><code>define dso_local void @StrengthReduction(i32 noundef %0) {
  %2 = mul nsw i32 %0, 2
  %3 = mul nsw i32 64, %0
  %4 = sdiv i32 %0, 4
  %5 = sdiv i32 %0, 128
  %6 = call i32 (ptr, ...) @printf(ptr noundef @.str.1, i32 noundef %2, i32 noundef %3, i32 noundef %4, i32 noundef %5)
  ret void
}
</code></pre>
<p>优化后:</p>
<pre><code>define dso_local void @StrengthReduction(i32 noundef %0) {
  %2 = shl i32 %0, 1
  %3 = shl i32 %0, 6
  %4 = ashr i32 %0, 2
  %5 = ashr i32 %0, 7
  %6 = call i32 (ptr, ...) @printf(ptr noundef @.str.1, i32 noundef %2, i32 noundef %3, i32 noundef %4, i32 noundef %5)
  ret void
}
</code></pre>
<h2 id="Multi-Instruction-Optimization"><a href="#Multi-Instruction-Optimization" class="headerlink" title="Multi-Instruction Optimization"></a>Multi-Instruction Optimization</h2><h3 id="识别-2"><a href="#识别-2" class="headerlink" title="识别"></a>识别</h3><p>以先加后减运算为例: </p>
<pre><code>c = a+b;d = c-a;  --&gt;  c = a+b;d = b;
</code></pre>
<p>对于指令In,遍历其UserIn,如果UserIn的操作符含义与In的操作符相反(如加与减,乘与除),且UserIn的第二个操作数(减数)与In的任一操作数(加数)均为对同一个Value的引用.</p>
<p>其实就是UserIn正好抵消In的运算,具体是否可消除模式的识别与操作符本身有关,这里仅以上述先加后减的模式进行优化.</p>
<h3 id="优化-2"><a href="#优化-2" class="headerlink" title="优化"></a>优化</h3><p>以之前的值替换即可.</p>
<h3 id="完整代码-2"><a href="#完整代码-2" class="headerlink" title="完整代码"></a>完整代码</h3><pre class=" language-cpp"><code class="language-cpp">PreservedAnalyses MultiInstOptPass<span class="token operator">::</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token punctuation">[</span>maybe_unused<span class="token punctuation">]</span><span class="token punctuation">]</span> Function <span class="token operator">&amp;</span>F<span class="token punctuation">,</span>
                                        FunctionAnalysisManager <span class="token operator">&amp;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token comment" spellcheck="true">/// @todo(CSCD70) Please complete this method.</span>
  <span class="token keyword">int</span> cnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  std<span class="token operator">::</span>vector<span class="token operator">&lt;</span>Instruction<span class="token operator">*</span><span class="token operator">></span> del_InsList<span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> BB <span class="token operator">:</span> F<span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">auto</span><span class="token operator">&amp;</span> In <span class="token operator">:</span> BB<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>In<span class="token punctuation">.</span><span class="token function">isBinaryOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">{</span>
        <span class="token keyword">int</span> op <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">;</span> <span class="token comment" spellcheck="true">//1 -> + ; 0 -> -;</span>
        <span class="token keyword">int</span> Incnt <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> oper1 <span class="token operator">=</span> In<span class="token punctuation">.</span><span class="token function">getOperand</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">auto</span> oper2 <span class="token operator">=</span> In<span class="token punctuation">.</span><span class="token function">getOperand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>In<span class="token punctuation">.</span><span class="token function">getOpcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
        <span class="token keyword">case</span> Instruction<span class="token operator">::</span>Add<span class="token operator">:</span>
          <span class="token keyword">for</span><span class="token punctuation">(</span>User<span class="token operator">*</span> user<span class="token operator">:</span>In<span class="token punctuation">.</span><span class="token function">users</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
          <span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>Instruction<span class="token operator">*</span> UserIn <span class="token operator">=</span> dyn_cast<span class="token operator">&lt;</span>Instruction<span class="token operator">></span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
              Value<span class="token operator">*</span> Val <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
              <span class="token keyword">if</span><span class="token punctuation">(</span>In<span class="token punctuation">.</span><span class="token function">isBinaryOp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
              <span class="token punctuation">{</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span>UserIn<span class="token operator">-</span><span class="token operator">></span><span class="token function">getOpcode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> Instruction<span class="token operator">::</span>Sub<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                  <span class="token keyword">if</span><span class="token punctuation">(</span>UserIn<span class="token operator">-</span><span class="token operator">></span><span class="token function">getOperand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> oper1<span class="token punctuation">)</span>
                    Val <span class="token operator">=</span> oper2<span class="token punctuation">;</span>
                  <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>UserIn<span class="token operator">-</span><span class="token operator">></span><span class="token function">getOperand</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> oper2<span class="token punctuation">)</span>
                    Val <span class="token operator">=</span> oper1<span class="token punctuation">;</span>

                  <span class="token keyword">if</span><span class="token punctuation">(</span>Val<span class="token punctuation">)</span>
                  <span class="token punctuation">{</span>
                    UserIn<span class="token operator">-</span><span class="token operator">></span><span class="token function">replaceAllUsesWith</span><span class="token punctuation">(</span>Val<span class="token punctuation">)</span><span class="token punctuation">;</span>  
                    del_InsList<span class="token punctuation">.</span><span class="token function">push_back</span><span class="token punctuation">(</span>UserIn<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token operator">++</span>cnt<span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        
        <span class="token keyword">default</span><span class="token operator">:</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">delIns</span><span class="token punctuation">(</span>del_InsList<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"define dso_local void @MultiInstOpt(i32 noundef %0, i32 noundef %1) {"</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
  <span class="token function">outs</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> <span class="token string">"multi-inst-opt: "</span> <span class="token operator">&lt;&lt;</span> cnt <span class="token operator">&lt;&lt;</span> <span class="token string">"\n"</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> PreservedAnalyses<span class="token operator">::</span><span class="token function">none</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h3><pre><code>make &amp;&amp; opt -load-pass-plugin=./libLocalOpts.so -passes=algebraic-identity,strength-reduction,multi-inst-opt ./test/TestCaseBasic.ll -o ./TestCase.bc &amp;&amp; llvm-dis TestCase.bc -o TestCase.ll
</code></pre>
<pre><code>define dso_local void @MultiInstOpt(i32 noundef %0, i32 noundef %1) {
  %3 = add nsw i32 %0, 3
  %4 = sub nsw i32 %3, 3
  %5 = add nsw i32 %0, %1
  %6 = sub nsw i32 %5, %1
  %7 = call i32 (ptr, ...) @printf(ptr noundef @.str.1, i32 noundef %3, i32 noundef %4, i32 noundef %5, i32 noundef %6)
  ret void
}
</code></pre>
<pre><code>define dso_local void @MultiInstOpt(i32 noundef %0, i32 noundef %1) {
  %3 = add nsw i32 %0, 3
  %4 = add nsw i32 %0, %1
  %5 = call i32 (ptr, ...) @printf(ptr noundef @.str.1, i32 noundef %3, i32 noundef %0, i32 noundef %4, i32 noundef %0)
  ret void
}
</code></pre>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://jamorant12138.github.io/2023/CSCD70-Assignment1/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CSCD70/" rel="tag">CSCD70</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/" rel="tag">静态分析</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2023/DataFlow-Analysis/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            数据流分析 学习笔记
          
        </div>
      </a>
    
    
      <a href="/2023/JQCTF223%20Qemu-mr%20Recursive-MMIO-Flaws/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">京麒CTF2023 qemu-mr MMIO重入攻击</div>
      </a>
    
  </nav>

  
   
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2022-2023
        <i class="ri-heart-fill heart_icon"></i> 翰青HanQi
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="北极落小雪"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2022/About">关于</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->
 
<script src="/js/clickLove.js"></script>
 
<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>

</html>