<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8" />
        
      <meta name="description" content="Boom? PWN ! ! !" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>CSCD70-Assignment1 Introduction to LLVM |  北极落小雪</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>
  </html>
</html>


<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-CSCD70-Assignment1"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  CSCD70-Assignment1 Introduction to LLVM
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/CSCD70-Assignment1/" class="article-date">
  <time datetime="2023-12-09T16:00:00.000Z" itemprop="datePublished">2023-12-10</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> / <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/">静态分析</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">1.8k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">9 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <h1 id="函数信息"><a href="#函数信息" class="headerlink" title="函数信息"></a>函数信息</h1><span id="more"></span>
<p>没啥好说的.</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FunctionInfoPass</span> <span class="keyword">final</span> : <span class="keyword">public</span> PassInfoMixin&lt;FunctionInfoPass&gt; {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="function">PreservedAnalyses <span class="title">run</span><span class="params">([[maybe_unused]] Module &amp;M, ModuleAnalysisManager &amp;)</span> </span>{</span><br><span class="line">    <span class="built_in">outs</span>() &lt;&lt; <span class="string">"CSCD70 Function Information Pass"</span></span><br><span class="line">           &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// @todo(CSCD70) Please complete this method.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; F : M.<span class="built_in">functions</span>())</span><br><span class="line">    {</span><br><span class="line">      <span class="built_in">outs</span>() &lt;&lt; <span class="string">"Function Name: "</span> &lt;&lt; F.<span class="built_in">getName</span>() &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">      <span class="built_in">outs</span>() &lt;&lt; <span class="string">"Number of Arguments: "</span> &lt;&lt; F.<span class="built_in">arg_size</span>() &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">      <span class="built_in">outs</span>() &lt;&lt; <span class="string">"Number of Calls: "</span> &lt;&lt; F.<span class="built_in">getNumUses</span>() &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">      <span class="built_in">outs</span>() &lt;&lt; <span class="string">"Number OF BBs: "</span> &lt;&lt; F.<span class="built_in">size</span>() &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">      <span class="built_in">outs</span>() &lt;&lt; <span class="string">"Number of Instructions: "</span> &lt;&lt; F.<span class="built_in">getInstructionCount</span>() &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> PreservedAnalyses::<span class="built_in">all</span>();</span><br><span class="line">  }</span><br><span class="line">}; <span class="comment">// class FunctionInfoPass</span></span><br></pre></td></tr></tbody></table></figure>
<h1 id="局部优化"><a href="#局部优化" class="headerlink" title="局部优化"></a>局部优化</h1><h2 id="代数恒等式"><a href="#代数恒等式" class="headerlink" title="代数恒等式"></a>代数恒等式</h2><h3 id="识别"><a href="#识别" class="headerlink" title="识别"></a>识别</h3><p>加减运算中,其中一个操作数为常量0;乘除运算中,其中一个操作数为常量1.</p>
<p>在判别常量的值的时候,需要这样的转化:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Value* oper1 =In.<span class="built_in">getOperand</span>(<span class="number">0</span>)</span><br><span class="line">ConstVal1 = <span class="built_in">dyn_cast</span>&lt;ConstantInt&gt;(oper1)-&gt;<span class="built_in">getSExtValue</span>()</span><br></pre></td></tr></tbody></table></figure>
<p>但是在二元运算中,操作数不一定是ConstantInt,所以需要先判别一下:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="built_in">isa</span>&lt;ConstantInt&gt;(oper1))</span><br></pre></td></tr></tbody></table></figure>
<h3 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h3><p>用代数恒等式的最终值代替所有引用该指令结果的地方,然后删除该指令.</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In.<span class="built_in">replaceAllUsesWith</span>(AlgebraicIdentity);</span><br></pre></td></tr></tbody></table></figure>

<p>删除指令应该在遍历完所有指令之后,否则可能会导致迭代器失效.<br>一个相关的demo如下:</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">vec</span><span class="params">({<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>})</span></span>;</span><br><span class="line">    <span class="keyword">for</span>(std::vector&lt;<span class="type">int</span>&gt;::iterator iter = vec.<span class="built_in">begin</span>();iter!=vec.<span class="built_in">end</span>();++iter)</span><br><span class="line">    {</span><br><span class="line">        std::cout &lt;&lt; *iter &lt;&lt;<span class="string">" "</span>;</span><br><span class="line">        vec.<span class="built_in">erase</span>(iter);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">g++ test.cpp &amp;&amp; ./a.out</span><br><span class="line">22145664082593 0872 180082552 2 6101240994215 82538  19428801684252 4048 9411899120 87594 220361632 217 91908160516051605 88948 81625610688 288 288 288 211024042 80848 8242 242 242 242 0 80094 85240422961 961 961 961 87619 85558 23824 894 894 894 89286254005 213 959527952795279527221 52042352892352045204520452049 87673 54062283040 040 040 040 84094 84344 840972344 844 844 844 844 844 844 844 844 840972344 840972344 891303733 94279427942794279427942794279427942748211 876164408 540161074 540161016101610161074 540161074 540161074 </span><br><span class="line">......</span><br><span class="line">段错误</span><br></pre></td></tr></tbody></table></figure>

<p>将所有要删除的指令加入一个vector,最后统一删除.</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">delIns</span><span class="params">(std::vector&lt;Instruction*&gt; InsList)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; ins : InsList)</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">if</span>(ins-&gt;<span class="built_in">isSafeToRemove</span>())</span><br><span class="line">    {</span><br><span class="line">      ins-&gt;<span class="built_in">eraseFromParent</span>();</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>注意这里使用的是eraseFromParent,使用removeFromParent会导致如下错误:</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Instruction referencing instruction not embedded in a basic block!</span><br><span class="line">  %<span class="number">5</span> = sdiv i32 %<span class="number">3</span>, <span class="number">10</span></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// This method unlinks 'this' from the containing basic block, but does not</span></span><br><span class="line"><span class="comment">/// delete it.</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">removeFromParent</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// This method unlinks 'this' from the containing basic block and deletes it.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// \returns an iterator pointing to the element after the erased one</span></span><br><span class="line">SymbolTableList&lt;Instruction&gt;::<span class="function">iterator <span class="title">eraseFromParent</span><span class="params">()</span></span>;</span><br></pre></td></tr></tbody></table></figure>
<h3 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PreservedAnalyses <span class="title">AlgebraicIdentityPass::run</span><span class="params">([[maybe_unused]] Function &amp;F,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             FunctionAnalysisManager &amp;)</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @todo(CSCD70) Please complete this method.</span></span><br><span class="line">  <span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">  std::vector&lt;Instruction*&gt; del_InsList;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; BB : F)</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; In : BB)</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span>(In.<span class="built_in">isBinaryOp</span>())</span><br><span class="line">      {</span><br><span class="line">        Value* AlgebraicIdentity = <span class="number">0</span>;</span><br><span class="line">        <span class="type">bool</span> flag = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">auto</span> oper1 =In.<span class="built_in">getOperand</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">auto</span> oper2 =In.<span class="built_in">getOperand</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">int64_t</span> ConstVal1,ConstVal2;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">isa</span>&lt;ConstantInt&gt;(oper1))</span><br><span class="line">          ConstVal1 = <span class="built_in">dyn_cast</span>&lt;ConstantInt&gt;(oper1)-&gt;<span class="built_in">getSExtValue</span>();</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">isa</span>&lt;ConstantInt&gt;(oper2))</span><br><span class="line">          ConstVal2 = <span class="built_in">dyn_cast</span>&lt;ConstantInt&gt;(oper2)-&gt;<span class="built_in">getSExtValue</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (In.<span class="built_in">getOpcode</span>())</span><br><span class="line">        {</span><br><span class="line">          <span class="comment">//x+0 x-0 --&gt; x</span></span><br><span class="line">        <span class="keyword">case</span> Instruction::Add:</span><br><span class="line">        <span class="keyword">case</span> Instruction::Sub:</span><br><span class="line">          <span class="keyword">if</span>((<span class="built_in">isa</span>&lt;ConstantInt&gt;(oper1)&amp;&amp;!ConstVal1)||(<span class="built_in">isa</span>&lt;ConstantInt&gt;(oper2)&amp;&amp;!ConstVal2))</span><br><span class="line">          {</span><br><span class="line">            AlgebraicIdentity = oper1 ? oper1 : oper2;</span><br><span class="line">            flag = <span class="literal">true</span>;</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> Instruction::Mul:</span><br><span class="line">        <span class="keyword">case</span> Instruction::SDiv:</span><br><span class="line">          <span class="keyword">if</span>((<span class="built_in">isa</span>&lt;ConstantInt&gt;(oper1)&amp;&amp;ConstVal1==<span class="number">1</span>)||(<span class="built_in">isa</span>&lt;ConstantInt&gt;(oper2)&amp;&amp;ConstVal2==<span class="number">1</span>))</span><br><span class="line">          {</span><br><span class="line">            AlgebraicIdentity = ConstVal1==<span class="number">1</span>? oper2 : oper1;</span><br><span class="line">            flag = <span class="literal">true</span>; </span><br><span class="line">          }</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span>(flag)</span><br><span class="line">        {</span><br><span class="line">          In.<span class="built_in">replaceAllUsesWith</span>(AlgebraicIdentity);</span><br><span class="line">          del_InsList.<span class="built_in">push_back</span>(&amp;In);</span><br><span class="line">          ++cnt;</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">delIns</span>(del_InsList);</span><br><span class="line">  <span class="built_in">outs</span>() &lt;&lt; <span class="string">"define dso_local void @AlgebraicIdentity(i32 noundef %0) {"</span> &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">  <span class="built_in">outs</span>() &lt;&lt; <span class="string">"Algebraic Identity: "</span> &lt;&lt; cnt &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">  <span class="keyword">return</span> PreservedAnalyses::<span class="built_in">none</span>();</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; opt -load-pass-plugin=./libLocalOpts.so -passes=algebraic-identity ./test/TestCase1.ll -o ./TestCase.bc &amp;&amp; llvm-dis TestCase.bc -o TestCase.ll</span><br></pre></td></tr></tbody></table></figure>
<p>优化前:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">define dso_local void @AlgebraicIdentity(i32 noundef %0) {</span><br><span class="line">  %2 = add nsw i32 %0, 0</span><br><span class="line">  %3 = add nsw i32 0, %0</span><br><span class="line">  %4 = mul nsw i32 %0, 1</span><br><span class="line">  %5 = mul nsw i32 1, %0</span><br><span class="line">  %6 = sub nsw i32 %0, 0</span><br><span class="line">  %7 = sdiv i32 %0, 1</span><br><span class="line">  %8 = call i32 (ptr, ...) @printf(ptr noundef @.str, i32 noundef %2, i32 noundef %3, i32 noundef %4, i32 noundef %5, i32 noundef %6, i32 noundef %7)</span><br><span class="line">  ret void</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>优化后:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">define dso_local void @AlgebraicIdentity(i32 noundef %0) {</span><br><span class="line">  %2 = call i32 (ptr, ...) @printf(ptr noundef @.str, i32 noundef %0, i32 noundef 0, i32 noundef %0, i32 noundef %0, i32 noundef %0, i32 noundef 1)</span><br><span class="line">  ret void</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="强度削弱"><a href="#强度削弱" class="headerlink" title="强度削弱"></a>强度削弱</h2><h3 id="识别-1"><a href="#识别-1" class="headerlink" title="识别"></a>识别</h3><p>乘除运算,其中一个操作数为2的幂.</p>
<h3 id="优化-1"><a href="#优化-1" class="headerlink" title="优化"></a>优化</h3><p>在原指令下方增加一条移位指令,移除并删除原指令.这里要用到IRBuilder.<br>用当前指令来初始化builder,为其设置指令的插入点.</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">IRBuilder&lt;&gt; <span class="built_in">builder</span>(&amp;In);</span><br><span class="line">Value* NewIns = builder.<span class="built_in">CreateShl</span>(oper,shift);</span><br><span class="line">In.<span class="built_in">replaceAllUsesWith</span>(NewIns);</span><br></pre></td></tr></tbody></table></figure>
<h3 id="完整代码-1"><a href="#完整代码-1" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">getshift</span><span class="params">(<span class="type">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">  <span class="keyword">if</span>(!((x &gt; <span class="number">0</span>) &amp;&amp; !(x &amp; (x - <span class="number">1</span>))))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  <span class="type">int</span> i = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">while</span>(x)</span><br><span class="line">  {</span><br><span class="line">    x = x&gt;&gt;<span class="number">1</span>;</span><br><span class="line">    ++i;</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">PreservedAnalyses <span class="title">StrengthReductionPass::run</span><span class="params">([[maybe_unused]] Function &amp;F,</span></span></span><br><span class="line"><span class="params"><span class="function">                                             FunctionAnalysisManager &amp;)</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @todo(CSCD70) Please complete this method.</span></span><br><span class="line">  <span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">  std::vector&lt;Instruction*&gt; del_InsList;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; BB : F)</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; In : BB)</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span>(In.<span class="built_in">isBinaryOp</span>())</span><br><span class="line">      {</span><br><span class="line">        <span class="type">int</span> shift = <span class="number">0</span>;</span><br><span class="line">        Value* oper;</span><br><span class="line">        <span class="keyword">auto</span> oper1 =In.<span class="built_in">getOperand</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">auto</span> oper2 =In.<span class="built_in">getOperand</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="type">int</span> shift1 = <span class="number">-1</span>,shift2 = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">isa</span>&lt;ConstantInt&gt;(oper1))</span><br><span class="line">          shift1 = <span class="built_in">getshift</span>(<span class="built_in">dyn_cast</span>&lt;ConstantInt&gt;(oper1)-&gt;<span class="built_in">getSExtValue</span>());</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">isa</span>&lt;ConstantInt&gt;(oper2))</span><br><span class="line">          shift2 = <span class="built_in">getshift</span>(<span class="built_in">dyn_cast</span>&lt;ConstantInt&gt;(oper2)-&gt;<span class="built_in">getSExtValue</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (In.<span class="built_in">getOpcode</span>())</span><br><span class="line">        {</span><br><span class="line">        <span class="keyword">case</span> Instruction::Mul:</span><br><span class="line">        <span class="keyword">case</span> Instruction::SDiv:</span><br><span class="line">        <span class="keyword">case</span> Instruction::UDiv:</span><br><span class="line">          <span class="keyword">if</span>((<span class="built_in">isa</span>&lt;ConstantInt&gt;(oper1)&amp;&amp;shift1!=<span class="number">-1</span>)||(<span class="built_in">isa</span>&lt;ConstantInt&gt;(oper2)&amp;&amp;shift2!=<span class="number">-1</span>))</span><br><span class="line">          {</span><br><span class="line">            shift = shift1==<span class="number">-1</span> ? shift2 : shift1;</span><br><span class="line">            oper = shift1==<span class="number">-1</span>? oper1 : oper2;</span><br><span class="line">            </span><br><span class="line">            IRBuilder&lt;&gt; <span class="built_in">builder</span>(&amp;In);</span><br><span class="line">            </span><br><span class="line">            Value* NewIns;</span><br><span class="line">            <span class="keyword">switch</span> (In.<span class="built_in">getOpcode</span>())</span><br><span class="line">            {</span><br><span class="line">            <span class="keyword">case</span> Instruction::Mul:</span><br><span class="line">              NewIns = builder.<span class="built_in">CreateShl</span>(oper,shift);</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> Instruction::SDiv:</span><br><span class="line">            <span class="keyword">case</span> Instruction::UDiv:</span><br><span class="line">              NewIns =builder.<span class="built_in">CreateAShr</span>(oper,shift);</span><br><span class="line">              <span class="keyword">break</span>;            </span><br><span class="line">            }</span><br><span class="line"></span><br><span class="line">            In.<span class="built_in">replaceAllUsesWith</span>(NewIns);</span><br><span class="line">            del_InsList.<span class="built_in">push_back</span>(&amp;In);</span><br><span class="line">            cnt++;</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">delIns</span>(del_InsList);</span><br><span class="line">  <span class="built_in">outs</span>() &lt;&lt; <span class="string">"define dso_local void @StrengthReduction(i32 noundef %0) {"</span> &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">  <span class="built_in">outs</span>() &lt;&lt; <span class="string">"strength-reduction: "</span> &lt;&lt; cnt &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">  <span class="keyword">return</span> PreservedAnalyses::<span class="built_in">none</span>();</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; opt -load-pass-plugin=./libLocalOpts.so -passes=algebraic-identity,strength-reduction ./test/TestCase2.ll -o ./TestCase.bc &amp;&amp; llvm-dis TestCase.bc -o TestCase.ll</span><br></pre></td></tr></tbody></table></figure>
<p>优化前:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">define dso_local void @StrengthReduction(i32 noundef %0) {</span><br><span class="line">  %2 = mul nsw i32 %0, 2</span><br><span class="line">  %3 = mul nsw i32 64, %0</span><br><span class="line">  %4 = sdiv i32 %0, 4</span><br><span class="line">  %5 = sdiv i32 %0, 128</span><br><span class="line">  %6 = call i32 (ptr, ...) @printf(ptr noundef @.str.1, i32 noundef %2, i32 noundef %3, i32 noundef %4, i32 noundef %5)</span><br><span class="line">  ret void</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>优化后:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">define dso_local void @StrengthReduction(i32 noundef %0) {</span><br><span class="line">  %2 = shl i32 %0, 1</span><br><span class="line">  %3 = shl i32 %0, 6</span><br><span class="line">  %4 = ashr i32 %0, 2</span><br><span class="line">  %5 = ashr i32 %0, 7</span><br><span class="line">  %6 = call i32 (ptr, ...) @printf(ptr noundef @.str.1, i32 noundef %2, i32 noundef %3, i32 noundef %4, i32 noundef %5)</span><br><span class="line">  ret void</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Multi-Instruction-Optimization"><a href="#Multi-Instruction-Optimization" class="headerlink" title="Multi-Instruction Optimization"></a>Multi-Instruction Optimization</h2><h3 id="识别-2"><a href="#识别-2" class="headerlink" title="识别"></a>识别</h3><p>以先加后减运算为例: </p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c = a+b;d = c-a;  --&gt;  c = a+b;d = b;</span><br></pre></td></tr></tbody></table></figure>
<p>对于指令In,遍历其UserIn,如果UserIn的操作符含义与In的操作符相反(如加与减,乘与除),且UserIn的第二个操作数(减数)与In的任一操作数(加数)均为对同一个Value的引用.</p>
<p>其实就是UserIn正好抵消In的运算,具体是否可消除模式的识别与操作符本身有关,这里仅以上述先加后减的模式进行优化.</p>
<h3 id="优化-2"><a href="#优化-2" class="headerlink" title="优化"></a>优化</h3><p>以之前的值替换即可.</p>
<h3 id="完整代码-2"><a href="#完整代码-2" class="headerlink" title="完整代码"></a>完整代码</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">PreservedAnalyses <span class="title">MultiInstOptPass::run</span><span class="params">([[maybe_unused]] Function &amp;F,</span></span></span><br><span class="line"><span class="params"><span class="function">                                        FunctionAnalysisManager &amp;)</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="comment">/// @todo(CSCD70) Please complete this method.</span></span><br><span class="line">  <span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line">  std::vector&lt;Instruction*&gt; del_InsList;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; BB : F)</span><br><span class="line">  {</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span>&amp; In : BB)</span><br><span class="line">    {</span><br><span class="line">      <span class="keyword">if</span>(In.<span class="built_in">isBinaryOp</span>())</span><br><span class="line">      {</span><br><span class="line">        <span class="type">int</span> op = <span class="number">-1</span> ; <span class="comment">//1 -&gt; + ; 0 -&gt; -;</span></span><br><span class="line">        <span class="type">int</span> Incnt = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">auto</span> oper1 = In.<span class="built_in">getOperand</span>(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">auto</span> oper2 = In.<span class="built_in">getOperand</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">switch</span> (In.<span class="built_in">getOpcode</span>())</span><br><span class="line">        {</span><br><span class="line">        <span class="keyword">case</span> Instruction::Add:</span><br><span class="line">          <span class="keyword">for</span>(User* user:In.<span class="built_in">users</span>())</span><br><span class="line">          {</span><br><span class="line">            <span class="keyword">if</span>(Instruction* UserIn = <span class="built_in">dyn_cast</span>&lt;Instruction&gt;(user))</span><br><span class="line">            {</span><br><span class="line">              Value* Val = <span class="literal">NULL</span>;</span><br><span class="line">              <span class="keyword">if</span>(In.<span class="built_in">isBinaryOp</span>())</span><br><span class="line">              {</span><br><span class="line">                <span class="keyword">if</span>(UserIn-&gt;<span class="built_in">getOpcode</span>() == Instruction::Sub)</span><br><span class="line">                {</span><br><span class="line">                  <span class="keyword">if</span>(UserIn-&gt;<span class="built_in">getOperand</span>(<span class="number">1</span>) == oper1)</span><br><span class="line">                    Val = oper2;</span><br><span class="line">                  <span class="keyword">else</span> <span class="keyword">if</span>(UserIn-&gt;<span class="built_in">getOperand</span>(<span class="number">1</span>) == oper2)</span><br><span class="line">                    Val = oper1;</span><br><span class="line"></span><br><span class="line">                  <span class="keyword">if</span>(Val)</span><br><span class="line">                  {</span><br><span class="line">                    UserIn-&gt;<span class="built_in">replaceAllUsesWith</span>(Val);  </span><br><span class="line">                    del_InsList.<span class="built_in">push_back</span>(UserIn);</span><br><span class="line">                    ++cnt;</span><br><span class="line">                  }</span><br><span class="line">                }</span><br><span class="line">              }</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">delIns</span>(del_InsList);</span><br><span class="line">  <span class="built_in">outs</span>() &lt;&lt; <span class="string">"define dso_local void @MultiInstOpt(i32 noundef %0, i32 noundef %1) {"</span> &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">  <span class="built_in">outs</span>() &lt;&lt; <span class="string">"multi-inst-opt: "</span> &lt;&lt; cnt &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">  <span class="keyword">return</span> PreservedAnalyses::<span class="built_in">none</span>();</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make &amp;&amp; opt -load-pass-plugin=./libLocalOpts.so -passes=algebraic-identity,strength-reduction,multi-inst-opt ./test/TestCaseBasic.ll -o ./TestCase.bc &amp;&amp; llvm-dis TestCase.bc -o TestCase.ll</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">define dso_local void @MultiInstOpt(i32 noundef %0, i32 noundef %1) {</span><br><span class="line">  %3 = add nsw i32 %0, 3</span><br><span class="line">  %4 = sub nsw i32 %3, 3</span><br><span class="line">  %5 = add nsw i32 %0, %1</span><br><span class="line">  %6 = sub nsw i32 %5, %1</span><br><span class="line">  %7 = call i32 (ptr, ...) @printf(ptr noundef @.str.1, i32 noundef %3, i32 noundef %4, i32 noundef %5, i32 noundef %6)</span><br><span class="line">  ret void</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">define dso_local void @MultiInstOpt(i32 noundef %0, i32 noundef %1) {</span><br><span class="line">  %3 = add nsw i32 %0, 3</span><br><span class="line">  %4 = add nsw i32 %0, %1</span><br><span class="line">  %5 = call i32 (ptr, ...) @printf(ptr noundef @.str.1, i32 noundef %3, i32 noundef %0, i32 noundef %4, i32 noundef %0)</span><br><span class="line">  ret void</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure> 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://jamorant12138.github.io/2023/CSCD70-Assignment1/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CSCD70/" rel="tag">CSCD70</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9D%99%E6%80%81%E5%88%86%E6%9E%90/" rel="tag">静态分析</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2023/DataFlow-Analysis/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            数据流分析 学习笔记
          
        </div>
      </a>
    
    
      <a href="/2023/JQCTF223%20Qemu-mr%20Recursive-MMIO-Flaws/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">京麒CTF2023 qemu-mr MMIO重入攻击</div>
      </a>
    
  </nav>

  
   
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2022-2025
        <i class="ri-heart-fill heart_icon"></i> 翰青HanQi
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="北极落小雪"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2022/About">关于</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->
 
<script src="/js/clickLove.js"></script>
 
<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>

</html>