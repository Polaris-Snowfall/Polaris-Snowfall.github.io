<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8" />
        
      <meta name="description" content="Boom? PWN ! ! !" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>CSAPP Labs |  北极落小雪</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    <link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
  </html>
</html>


<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-CSAPP-Labs"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  CSAPP Labs
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2023/CSAPP-Labs/" class="article-date">
  <time datetime="2023-06-25T16:00:00.000Z" itemprop="datePublished">2023-06-26</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a> / <a class="article-category-link" href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%9D%82%E9%A1%B9/">杂项</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">9.5k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">49 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p>记录CSAPP Lab的一些过程和心得,由于刚开始接触计算机其实完成的质量不高.</p>
<span id="more"></span>
<h1 id="Lab1-DataLab"><a href="#Lab1-DataLab" class="headerlink" title="Lab1:DataLab"></a>Lab1:DataLab</h1><p>用位运算实现一些基本操作</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * CS:APP Data Lab </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * &lt;Please put your name and userid here&gt;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * bits.c - Source file with your solutions to the Lab.</span></span><br><span class="line"><span class="comment"> *          This is the file you will hand in to your instructor.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * WARNING: Do not include the &lt;stdio.h&gt; header; it confuses the dlc</span></span><br><span class="line"><span class="comment"> * compiler. You can still use printf for debugging without including</span></span><br><span class="line"><span class="comment"> * &lt;stdio.h&gt;, although you might get a compiler warning. In general,</span></span><br><span class="line"><span class="comment"> * it's not good practice to ignore compiler warnings, but in this</span></span><br><span class="line"><span class="comment"> * case it's OK.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Instructions to Students:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * STEP 1: Read the following instructions carefully.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">You will provide your solution to the Data Lab by</span><br><span class="line">editing the collection of functions in this source file.</span><br><span class="line"></span><br><span class="line">INTEGER CODING RULES:</span><br><span class="line"> </span><br><span class="line">  Replace the <span class="string">"return"</span> statement in each function with one</span><br><span class="line">  or more lines of C code that implements the function. Your code </span><br><span class="line">  must conform to the following style:</span><br><span class="line"> </span><br><span class="line">  <span class="type">int</span> <span class="title function_">Funct</span><span class="params">(arg1, arg2, ...)</span> {</span><br><span class="line">      <span class="comment">/* brief description of how your implementation works */</span></span><br><span class="line">      <span class="type">int</span> var1 = Expr1;</span><br><span class="line">      ...</span><br><span class="line">      <span class="type">int</span> varM = ExprM;</span><br><span class="line"></span><br><span class="line">      varJ = ExprJ;</span><br><span class="line">      ...</span><br><span class="line">      varN = ExprN;</span><br><span class="line">      <span class="keyword">return</span> ExprR;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  Each <span class="string">"Expr"</span> is an expression using ONLY the following:</span><br><span class="line">  <span class="number">1.</span> Integer constants <span class="number">0</span> through <span class="number">255</span> (<span class="number">0xFF</span>), inclusive. You are</span><br><span class="line">      not allowed to use big constants such as <span class="number">0xffffffff</span>.</span><br><span class="line">  <span class="number">2.</span> Function arguments and local <span class="title function_">variables</span> <span class="params">(no global variables)</span>.</span><br><span class="line">  3. Unary integer operations ! ~</span><br><span class="line">  4. Binary integer operations &amp; ^ | + &lt;&lt; &gt;&gt;</span><br><span class="line">    </span><br><span class="line">  Some of the problems <span class="keyword">restrict</span> the <span class="built_in">set</span> of allowed operators even further.</span><br><span class="line">  Each "Expr" may consist of multiple operators. You are not restricted to</span><br><span class="line">  one operator per line.</span><br><span class="line"></span><br><span class="line">  You are expressly forbidden to:</span><br><span class="line">  1. Use any control constructs such as <span class="keyword">if</span>, <span class="keyword">do</span>, <span class="keyword">while</span>, <span class="keyword">for</span>, <span class="keyword">switch</span>, etc.</span><br><span class="line">  2. Define or use any macros.</span><br><span class="line">  3. Define any additional functions in this file.</span><br><span class="line">  4. Call any functions.</span><br><span class="line">  5. Use any other operations, such as &amp;&amp;, ||, -, or ?:</span><br><span class="line">  6. Use any form of casting.</span><br><span class="line">  7. Use any data type other than <span class="type">int</span>.  This implies that you</span><br><span class="line">     cannot use arrays, structs, or unions.</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">  You may assume that your machine:</span><br><span class="line">  1. Uses 2s complement, 32-bit representations of integers.</span><br><span class="line">  2. Performs right shifts arithmetically.</span><br><span class="line">  3. Has unpredictable behavior when shifting <span class="keyword">if</span> the shift amount</span><br><span class="line">     is less than 0 or greater than 31.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">EXAMPLES OF ACCEPTABLE CODING STYLE:</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * pow2plus1 - returns 2^x + 1, where 0 &lt;= x &lt;= 31</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">int</span> <span class="title function_">pow2plus1</span><span class="params">(<span class="type">int</span> x)</span> {</span><br><span class="line">     <span class="comment">/* exploit ability of shifts to compute powers of 2 */</span></span><br><span class="line">     <span class="keyword">return</span> (<span class="number">1</span> &lt;&lt; x) + <span class="number">1</span>;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * pow2plus4 - returns 2^x + 4, where 0 &lt;= x &lt;= 31</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="type">int</span> <span class="title function_">pow2plus4</span><span class="params">(<span class="type">int</span> x)</span> {</span><br><span class="line">     <span class="comment">/* exploit ability of shifts to compute powers of 2 */</span></span><br><span class="line">     <span class="type">int</span> result = (<span class="number">1</span> &lt;&lt; x);</span><br><span class="line">     result += <span class="number">4</span>;</span><br><span class="line">     <span class="keyword">return</span> result;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">FLOATING POINT CODING RULES</span><br><span class="line"></span><br><span class="line">For the problems that require you to implement floating-point operations,</span><br><span class="line">the coding rules are less strict.  You are allowed to use looping and</span><br><span class="line">conditional control.  You are allowed to use both ints and unsigneds.</span><br><span class="line">You can use arbitrary integer and <span class="type">unsigned</span> constants. You can use any arithmetic,</span><br><span class="line">logical, or comparison operations on <span class="type">int</span> or <span class="type">unsigned</span> data.</span><br><span class="line"></span><br><span class="line">You are expressly forbidden to:</span><br><span class="line">  <span class="number">1.</span> Define or use any macros.</span><br><span class="line">  <span class="number">2.</span> Define any additional functions in this file.</span><br><span class="line">  <span class="number">3.</span> Call any functions.</span><br><span class="line">  <span class="number">4.</span> Use any form of casting.</span><br><span class="line">  <span class="number">5.</span> Use any data type other than <span class="type">int</span> or <span class="type">unsigned</span>.  This means that you</span><br><span class="line">     cannot use arrays, structs, or unions.</span><br><span class="line">  <span class="number">6.</span> Use any floating point data types, operations, or constants.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NOTES:</span><br><span class="line">  <span class="number">1.</span> Use the <span class="title function_">dlc</span> <span class="params">(data lab checker)</span> <span class="title function_">compiler</span> <span class="params">(described in the handout)</span> to </span><br><span class="line">     check the legality of your solutions.</span><br><span class="line">  2. Each function has a maximum number of <span class="title function_">operations</span> <span class="params">(integer, logical,</span></span><br><span class="line"><span class="params">     or comparison)</span> that you are allowed to use <span class="keyword">for</span> your implementation</span><br><span class="line">     of the function.  The max operator count is checked by dlc.</span><br><span class="line">     Note that <span class="title function_">assignment</span> <span class="params">(<span class="string">'='</span>)</span> is not counted; you may use as many of</span><br><span class="line">     these as you want without penalty.</span><br><span class="line">  <span class="number">3.</span> Use the btest test harness to check your functions <span class="keyword">for</span> correctness.</span><br><span class="line">  <span class="number">4.</span> Use the BDD checker to formally verify your functions</span><br><span class="line">  <span class="number">5.</span> The maximum number of ops <span class="keyword">for</span> each function is given in the</span><br><span class="line">     header comment <span class="keyword">for</span> each function. If there are any inconsistencies </span><br><span class="line">     between the maximum ops in the writeup and in this file, consider</span><br><span class="line">     this file the authoritative source.</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * STEP 2: Modify the following functions according the coding rules.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *   IMPORTANT. TO AVOID GRADING SURPRISES:</span></span><br><span class="line"><span class="comment"> *   1. Use the dlc compiler to check that your solutions conform</span></span><br><span class="line"><span class="comment"> *      to the coding rules.</span></span><br><span class="line"><span class="comment"> *   2. Use the BDD checker to formally verify that your solutions produce </span></span><br><span class="line"><span class="comment"> *      the correct answers.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">//1</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * bitXor - x^y using only ~ and &amp; </span></span><br><span class="line"><span class="comment"> *   Example: bitXor(4, 5) = 1</span></span><br><span class="line"><span class="comment"> *   Legal ops: ~ &amp;</span></span><br><span class="line"><span class="comment"> *   Max ops: 14</span></span><br><span class="line"><span class="comment"> *   Rating: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">bitXor</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> {</span><br><span class="line">  <span class="comment">//数字逻辑异或的与非转换</span></span><br><span class="line">  <span class="keyword">return</span> ~((~((~x)&amp;y))&amp;(~(x&amp;(~y))));</span><br><span class="line">}</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * tmin - return minimum two's complement integer </span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 4</span></span><br><span class="line"><span class="comment"> *   Rating: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">tmin</span><span class="params">(<span class="type">void</span>)</span> {</span><br><span class="line">   <span class="comment">//最小的数是仅有最高有效位为1的数</span></span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>&lt;&lt;<span class="number">31</span>;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"><span class="comment">//2</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * isTmax - returns 1 if x is the maximum, two's complement number,</span></span><br><span class="line"><span class="comment"> *     and 0 otherwise </span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | +</span></span><br><span class="line"><span class="comment"> *   Max ops: 10</span></span><br><span class="line"><span class="comment"> *   Rating: 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">isTmax</span><span class="params">(<span class="type">int</span> x)</span> {</span><br><span class="line">  <span class="comment">//返回真值,关键在于将满足条件的数(即最大数)唯一地处理成0</span></span><br><span class="line">  <span class="comment">//利用xor比较是否相等</span></span><br><span class="line">  <span class="comment">//最大数+1和取反相同:!((~x)^(x+1));  但是-1同样有这一性质,要扣掉</span></span><br><span class="line">  <span class="comment">//利用!将数值转换为布尔值,再结合&amp;实现&amp;&amp;的功能</span></span><br><span class="line">  <span class="comment">//如果有移位操作:!((~x)^(1&lt;&lt;31))</span></span><br><span class="line">  <span class="type">int</span> x_plus_1 = x + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> (!((~x) ^ (x_plus_1)))&amp;(!!(x_plus_1));</span><br><span class="line">}</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * allOddBits - return 1 if all odd-numbered bits in word set to 1</span></span><br><span class="line"><span class="comment"> *   where bits are numbered from 0 (least significant) to 31 (most significant)</span></span><br><span class="line"><span class="comment"> *   Examples allOddBits(0xFFFFFFFD) = 0, allOddBits(0xAAAAAAAA) = 1</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 12</span></span><br><span class="line"><span class="comment"> *   Rating: 2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">allOddBits</span><span class="params">(<span class="type">int</span> x)</span> {</span><br><span class="line">  <span class="comment">//类似掩码吧</span></span><br><span class="line">  <span class="type">int</span> all = <span class="number">0xAA</span>+(<span class="number">0xAA</span>&lt;&lt;<span class="number">8</span>)+(<span class="number">0xAA</span>&lt;&lt;<span class="number">16</span>)+(<span class="number">0xAA</span>&lt;&lt;<span class="number">24</span>);</span><br><span class="line">  <span class="keyword">return</span> !((x&amp;all)^all);</span><br><span class="line">}</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * negate - return -x </span></span><br><span class="line"><span class="comment"> *   Example: negate(1) = -1.</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 5</span></span><br><span class="line"><span class="comment"> *   Rating: 2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">negate</span><span class="params">(<span class="type">int</span> x)</span> {</span><br><span class="line">  <span class="comment">//负数补码:绝对值取反+1</span></span><br><span class="line">  <span class="comment">//反过来正数求相反数:-1再取反</span></span><br><span class="line">  <span class="comment">//不过~(x-1)==(~x)+1</span></span><br><span class="line">  <span class="keyword">return</span> (~x)+<span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"><span class="comment">//3</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * isAsciiDigit - return 1 if 0x30 &lt;= x &lt;= 0x39 (ASCII codes for characters '0' to '9')</span></span><br><span class="line"><span class="comment"> *   Example: isAsciiDigit(0x35) = 1.</span></span><br><span class="line"><span class="comment"> *            isAsciiDigit(0x3a) = 0.</span></span><br><span class="line"><span class="comment"> *            isAsciiDigit(0x05) = 0.</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 15</span></span><br><span class="line"><span class="comment"> *   Rating: 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">isAsciiDigit</span><span class="params">(<span class="type">int</span> x)</span> {</span><br><span class="line">  <span class="comment">//该范围的有效位位:110000-111001</span></span><br><span class="line">  <span class="comment">//前两位及更高位固定不变,单独异或验证</span></span><br><span class="line">  <span class="comment">//末4位采用4位溢出的方式验证</span></span><br><span class="line">  <span class="type">int</span> bool1 = (x&gt;&gt;<span class="number">4</span>)^<span class="number">3</span>;</span><br><span class="line">  <span class="type">int</span> last_byte = x&amp;<span class="number">15</span>;</span><br><span class="line">  <span class="type">int</span> bool2 = (last_byte+<span class="number">6</span>)&amp;<span class="number">16</span>;</span><br><span class="line">  <span class="keyword">return</span> !bool1&amp;!bool2;</span><br><span class="line">}</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * conditional - same as x ? y : z </span></span><br><span class="line"><span class="comment"> *   Example: conditional(2,4,5) = 4</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 16</span></span><br><span class="line"><span class="comment"> *   Rating: 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">conditional</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y, <span class="type">int</span> z)</span> {</span><br><span class="line">  <span class="comment">//将x转换成0和-1,与x,y进行&amp;.(1会清空高位,选用-1保留所有位)</span></span><br><span class="line">  <span class="comment">//从flag1-&gt;flag2: 0异或任何数等于任何数,-1异或-1为0.实现0和-1的转化</span></span><br><span class="line">    <span class="type">int</span> flag1 = (~!!x) + <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> flag2 = flag1 ^ (~<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> (flag1 &amp; y) | (flag2 &amp; z);</span><br><span class="line">}</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * isLessOrEqual - if x &lt;= y  then return 1, else return 0 </span></span><br><span class="line"><span class="comment"> *   Example: isLessOrEqual(4,5) = 1.</span></span><br><span class="line"><span class="comment"> *   Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 24</span></span><br><span class="line"><span class="comment"> *   Rating: 3</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">isLessOrEqual</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> {</span><br><span class="line">  <span class="comment">//若不考虑溢出,则检测x-y的符号位</span></span><br><span class="line">  <span class="comment">//考虑溢出,因为溢出仅在x负y正和x正y负的情况下出现,而这两种情况又可直接比较大小,单独设置flag判断</span></span><br><span class="line">  <span class="type">int</span> mask = <span class="number">1</span>&lt;&lt;<span class="number">31</span>;</span><br><span class="line">  <span class="type">int</span> var1 = !(x&amp;mask);</span><br><span class="line">  <span class="type">int</span> var2 = !(y&amp;mask);</span><br><span class="line">  <span class="type">int</span> flag1 = !var1&amp;var2;</span><br><span class="line">  <span class="type">int</span> flag2 = !var2&amp;var1;</span><br><span class="line">  <span class="type">int</span> x_sub_y = x+(~y)+<span class="number">1</span>;</span><br><span class="line">  <span class="type">int</span> negate_SF = !((mask)&amp;x_sub_y);</span><br><span class="line">  <span class="comment">//感觉应该能化简..</span></span><br><span class="line">  <span class="keyword">return</span> (!negate_SF|!x_sub_y|flag1)&amp;!flag2;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"><span class="comment">//4</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * logicalNeg - implement the ! operator, using all of </span></span><br><span class="line"><span class="comment"> *              the legal operators except !</span></span><br><span class="line"><span class="comment"> *   Examples: logicalNeg(3) = 0, logicalNeg(0) = 1</span></span><br><span class="line"><span class="comment"> *   Legal ops: ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *   Max ops: 12</span></span><br><span class="line"><span class="comment"> *   Rating: 4 </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">logicalNeg</span><span class="params">(<span class="type">int</span> x)</span> {</span><br><span class="line">  <span class="comment">// (-x|x),若不为零,该值符号位必为1.</span></span><br><span class="line">    <span class="keyword">return</span> (~((((~x)+<span class="number">1</span>)|x)&gt;&gt;<span class="number">31</span>)+<span class="number">1</span>)^<span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"><span class="comment">/* howManyBits - return the minimum number of bits required to represent x in</span></span><br><span class="line"><span class="comment"> *             two's complement</span></span><br><span class="line"><span class="comment"> *  Examples: howManyBits(12) = 5</span></span><br><span class="line"><span class="comment"> *            howManyBits(298) = 10</span></span><br><span class="line"><span class="comment"> *            howManyBits(-5) = 4</span></span><br><span class="line"><span class="comment"> *            howManyBits(0)  = 1</span></span><br><span class="line"><span class="comment"> *            howManyBits(-1) = 1</span></span><br><span class="line"><span class="comment"> *            howManyBits(0x80000000) = 32</span></span><br><span class="line"><span class="comment"> *  Legal ops: ! ~ &amp; ^ | + &lt;&lt; &gt;&gt;</span></span><br><span class="line"><span class="comment"> *  Max ops: 90</span></span><br><span class="line"><span class="comment"> *  Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">howManyBits</span><span class="params">(<span class="type">int</span> x)</span> {</span><br><span class="line">  <span class="comment">//二分法,若为负找最高0,若为正找最高1</span></span><br><span class="line">    <span class="type">int</span> flag, cnt_16, cnt_8, cnt_4, cnt_2, cnt_1, cnt_0;</span><br><span class="line">    <span class="type">int</span> sign = x &gt;&gt; <span class="number">31</span>;</span><br><span class="line">    x = (sign &amp; (~x)) | (~sign &amp; (x));</span><br><span class="line">    flag = !!(x &gt;&gt; <span class="number">16</span>);</span><br><span class="line">    cnt_16 = flag &lt;&lt; <span class="number">4</span>;</span><br><span class="line">    x &gt;&gt;= (cnt_16);</span><br><span class="line">    flag = !!(x &gt;&gt; <span class="number">8</span>);</span><br><span class="line">    cnt_8 = flag &lt;&lt; <span class="number">3</span>;</span><br><span class="line">    x &gt;&gt;= (cnt_8);</span><br><span class="line">    flag = !!(x &gt;&gt; <span class="number">4</span>);</span><br><span class="line">    cnt_4 = flag &lt;&lt; <span class="number">2</span>;</span><br><span class="line">    x &gt;&gt;= cnt_4;</span><br><span class="line">    flag = !!(x &gt;&gt; <span class="number">2</span>);</span><br><span class="line">    cnt_2 = flag &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    x &gt;&gt;= cnt_2;</span><br><span class="line">    flag = !!(x &gt;&gt; <span class="number">1</span>);</span><br><span class="line">    cnt_1 = flag;</span><br><span class="line">    x &gt;&gt;= cnt_1;</span><br><span class="line">    cnt_0 = x;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> + cnt_0 + cnt_1 + cnt_2 + cnt_4 + cnt_8 + cnt_16;</span><br><span class="line">}</span><br><span class="line"><span class="comment">//float</span></span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * floatScale2 - Return bit-level equivalent of expression 2*f for</span></span><br><span class="line"><span class="comment"> *   floating point argument f.</span></span><br><span class="line"><span class="comment"> *   Both the argument and result are passed as unsigned int's, but</span></span><br><span class="line"><span class="comment"> *   they are to be interpreted as the bit-level representation of</span></span><br><span class="line"><span class="comment"> *   single-precision floating point values.</span></span><br><span class="line"><span class="comment"> *   When argument is NaN, return argument</span></span><br><span class="line"><span class="comment"> *   Legal ops: Any integer/unsigned operations incl. ||, &amp;&amp;. also if, while</span></span><br><span class="line"><span class="comment"> *   Max ops: 30</span></span><br><span class="line"><span class="comment"> *   Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">floatScale2</span><span class="params">(<span class="type">unsigned</span> uf)</span> </span><br><span class="line">{</span><br><span class="line">  <span class="comment">//分别处理三部分,*2就是exp+1;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="built_in">exp</span> = (uf &lt;&lt; <span class="number">1</span> &gt;&gt; <span class="number">24</span>);</span><br><span class="line">    <span class="type">unsigned</span> frac = uf &lt;&lt; <span class="number">9</span> &gt;&gt; <span class="number">9</span>;</span><br><span class="line">    <span class="type">int</span> mask = uf &gt;&gt; <span class="number">31</span>&lt;&lt;<span class="number">31</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">exp</span> == <span class="number">255</span> &amp;&amp; frac)</span><br><span class="line">        <span class="keyword">return</span> uf;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">exp</span> &gt;= <span class="number">254</span>)</span><br><span class="line">        <span class="keyword">return</span> mask| <span class="number">0x7f800000</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">exp</span> == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> mask | uf &lt;&lt; <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">exp</span>++;</span><br><span class="line">    <span class="keyword">return</span> mask|(<span class="built_in">exp</span>&lt;&lt;<span class="number">23</span>)|frac;</span><br><span class="line">}</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * floatFloat2Int - Return bit-level equivalent of expression (int) f</span></span><br><span class="line"><span class="comment"> *   for floating point argument f.</span></span><br><span class="line"><span class="comment"> *   Argument is passed as unsigned int, but</span></span><br><span class="line"><span class="comment"> *   it is to be interpreted as the bit-level representation of a</span></span><br><span class="line"><span class="comment"> *   single-precision floating point value.</span></span><br><span class="line"><span class="comment"> *   Anything out of range (including NaN and infinity) should return</span></span><br><span class="line"><span class="comment"> *   0x80000000u.</span></span><br><span class="line"><span class="comment"> *   Legal ops: Any integer/unsigned operations incl. ||, &amp;&amp;. also if, while</span></span><br><span class="line"><span class="comment"> *   Max ops: 30</span></span><br><span class="line"><span class="comment"> *   Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">floatFloat2Int</span><span class="params">(<span class="type">unsigned</span> uf)</span> {</span><br><span class="line">    <span class="type">int</span> <span class="built_in">exp</span> = (uf &gt;&gt; <span class="number">23</span>) &amp; <span class="number">0xff</span>;</span><br><span class="line">    <span class="type">int</span> sign = (uf &gt;&gt; <span class="number">31</span>) &amp; <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> frac = uf &amp; <span class="number">0x7fffff</span>;</span><br><span class="line">    <span class="type">int</span> shiftBits = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 0比较特殊，先判断0(正负0都算作0)</span></span><br><span class="line">    <span class="keyword">if</span> (!(uf &amp; <span class="number">0x7fffffff</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 判断是否为NaN还是无穷大</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">exp</span> == <span class="number">0xff</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x80000000</span>u;</span><br><span class="line">    <span class="comment">// 指数减去偏移量，获取到真正的指数</span></span><br><span class="line">    <span class="built_in">exp</span> -= <span class="number">127</span>;</span><br><span class="line">    <span class="comment">// 需要注意的是，原来的frac一旦向左移位，其值就一定会小于1，所以返回0</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">exp</span> &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 获取M，注意exp等于-127和不等于-127的情况是不一样的。当exp != -127时还有一个隐藏的1</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">exp</span> != <span class="number">-127</span>)</span><br><span class="line">        frac |= (<span class="number">1</span> &lt;&lt; <span class="number">23</span>);</span><br><span class="line">    <span class="comment">// 要移位的位数。注意float的小数点是点在第23位与第22位之间</span></span><br><span class="line">    shiftBits = <span class="number">23</span> - <span class="built_in">exp</span>;</span><br><span class="line">    <span class="comment">// 需要注意一点，如果指数过大，则也返回0x80000000u</span></span><br><span class="line">    <span class="keyword">if</span> (shiftBits &lt; <span class="number">31</span> - <span class="number">23</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x80000000</span>u;</span><br><span class="line">    <span class="comment">// 获取真正的结果</span></span><br><span class="line">    frac &gt;&gt;= shiftBits;</span><br><span class="line">    <span class="comment">// 判断符号</span></span><br><span class="line">    <span class="keyword">if</span> (sign == <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> ~frac + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">return</span> frac;</span><br><span class="line">}</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * floatPower2 - Return bit-level equivalent of the expression 2.0^x</span></span><br><span class="line"><span class="comment"> *   (2.0 raised to the power x) for any 32-bit integer x.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   The unsigned value that is returned should have the identical bit</span></span><br><span class="line"><span class="comment"> *   representation as the single-precision floating-point number 2.0^x.</span></span><br><span class="line"><span class="comment"> *   If the result is too small to be represented as a denorm, return</span></span><br><span class="line"><span class="comment"> *   0. If too large, return +INF.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> *   Legal ops: Any integer/unsigned operations incl. ||, &amp;&amp;. Also if, while </span></span><br><span class="line"><span class="comment"> *   Max ops: 30 </span></span><br><span class="line"><span class="comment"> *   Rating: 4</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="title function_">floatPower2</span><span class="params">(<span class="type">int</span> x)</span> {</span><br><span class="line">    <span class="comment">// 判断指数是否上溢或者下溢</span></span><br><span class="line">    <span class="type">int</span> <span class="built_in">exp</span> = x + <span class="number">127</span>;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">exp</span> &gt; <span class="number">0xfe</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0x7f800000</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">exp</span> &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">exp</span> &lt;&lt; <span class="number">23</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202305111056381.png"><br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202305111057616.png"></p>
<h1 id="Lab2-Bomb-Lab"><a href="#Lab2-Bomb-Lab" class="headerlink" title="Lab2:Bomb Lab"></a>Lab2:Bomb Lab</h1><p>拆炸弹,实际上就是逆向找绕过条件.<br>用IDA感觉直接秒了,不过练一下看汇编吧.<br>之前还真没有嗯看过汇编.<br>先根据跳转的地址将代码分成几个部分,从外向内识别每个循环体.</p>
<h2 id="phase-1"><a href="#phase-1" class="headerlink" title="phase_1"></a>phase_1</h2><p>一个简单的字符串比较<br>payload:’Border relations with Canada have never been better.’</p>
<h2 id="phase-2"><a href="#phase-2" class="headerlink" title="phase_2"></a>phase_2</h2><p>读入六个数字,第一个为1,下一个为上一个的两倍<br>payload:’1 2 4 8 16 32’</p>
<h2 id="phase-3"><a href="#phase-3" class="headerlink" title="phase_3"></a>phase_3</h2><p>读入两个数字,第一个数字不大于7.<br>实现了一张跳转表,跳到跳转表的第一个条目,检查第二个数字是否是311.<br>payload:’1 311’<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202305111501156.png"></p>
<h2 id="phase-4"><a href="#phase-4" class="headerlink" title="phase_4"></a>phase_4</h2><p>主要逆这个函数了,可见var2==arg1的时候拆除炸弹.<br>payload:’7 0’</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">func4(arg1,arg2,arg3)</span><br><span class="line">{</span><br><span class="line">    var1 = arg3-arg2;</span><br><span class="line">    var2 = arg2&gt;&gt;<span class="number">31</span>;</span><br><span class="line">    var1 += var2;</span><br><span class="line">    var1 /= <span class="number">2</span>;</span><br><span class="line">    var2 = var1+arg2;</span><br><span class="line">    <span class="keyword">if</span>(var2&gt;arg1)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>*func4();</span><br><span class="line">    <span class="keyword">if</span>(var2&lt;arg1)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>*func4()+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="phase-5"><a href="#phase-5" class="headerlink" title="phase_5"></a>phase_5</h2><p>payload:ionefg</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">phase_5(a1)</span><br><span class="line">{</span><br><span class="line">    <span class="comment">//a1即input_string的指针</span></span><br><span class="line">    var1 = a1;</span><br><span class="line">    <span class="keyword">if</span>(string_lenth(a1)!=<span class="number">6</span>)</span><br><span class="line">        exploade_bomb();</span><br><span class="line">    <span class="comment">//将input_string中每个字符的第四位作为下标,从stringarray中取出字符,拷贝到str数组中.</span></span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span>{</span><br><span class="line">            str[i] = StringArray[a1[i++]&amp;<span class="number">0xf</span>];</span><br><span class="line">    }<span class="keyword">while</span>(i&lt;<span class="number">6</span>);</span><br><span class="line">    str[<span class="number">6</span>]=<span class="string">'\0'</span>;</span><br><span class="line">    <span class="keyword">if</span>(strings_not_equal(str,<span class="string">"flyers"</span>))</span><br><span class="line">        exploade_bomb();</span><br><span class="line">    <span class="keyword">return</span> </span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>解密脚本</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">phase_5</span>(<span class="params">goal</span>):</span><br><span class="line">    stringarray = [ch <span class="keyword">for</span> ch <span class="keyword">in</span> string.ascii_lowercase + string.ascii_uppercase + string.digits]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> goal:</span><br><span class="line">        <span class="keyword">for</span> test <span class="keyword">in</span> stringarray:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">ord</span>(test)&amp;<span class="number">0xf</span> == i:</span><br><span class="line">                <span class="built_in">print</span>(test)</span><br><span class="line">                <span class="keyword">break</span> </span><br><span class="line"></span><br><span class="line">phase_5([<span class="number">9</span>,<span class="number">15</span>,<span class="number">14</span>,<span class="number">5</span>,<span class="number">6</span>,<span class="number">7</span>])</span><br></pre></td></tr></tbody></table></figure>
<h2 id="phase-6"><a href="#phase-6" class="headerlink" title="phase_6"></a>phase_6</h2><p>函数较长,分成__部分逆向.<br>代码部分是仅表示逻辑的伪代码,分支和循环尽量还原源码,使用下标代替指针增减.</p>
<h3 id="逆向"><a href="#逆向" class="headerlink" title="逆向"></a>逆向</h3><h4 id="第一部分"><a href="#第一部分" class="headerlink" title="第一部分"></a>第一部分</h4><p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202305121206844.png"></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">phase_6(a1)</span><br><span class="line">{</span><br><span class="line">    nums[<span class="number">6</span>];</span><br><span class="line">    read_six_numbers(a1,nums);</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    k = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    {</span><br><span class="line">        var1 = nums[k];</span><br><span class="line">        <span class="keyword">if</span>(--var1&gt;<span class="number">5</span>)</span><br><span class="line">            explode_bomb();</span><br><span class="line">        <span class="keyword">if</span>(++i == <span class="number">6</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">do</span>{</span><br><span class="line">                j = i;</span><br><span class="line">                <span class="keyword">if</span>(nums[j]==num[k])</span><br><span class="line">                    explode_bomb();</span><br><span class="line">        }<span class="keyword">while</span>(++j&lt;=<span class="number">5</span>);</span><br><span class="line">            k+=<span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="第二部分"><a href="#第二部分" class="headerlink" title="第二部分"></a>第二部分</h4><p>要注意的是,如果循环体的条件在开始时一定成立或为恒真式,汇编代码会省掉(一步)判断,这影响到对while、for等不同循环结构的判断.<br>如for(int i = 0;i!=24;),while(1);</p>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202305121500820.png"></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">phase_6(a1)</span><br><span class="line">{</span><br><span class="line">    <span class="comment">//第一部分</span></span><br><span class="line">    nums[<span class="number">6</span>];</span><br><span class="line">    read_six_numbers(a1,nums);</span><br><span class="line"></span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    k = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    {</span><br><span class="line">        var1 = nums[k];</span><br><span class="line">        <span class="keyword">if</span>(--var1&gt;<span class="number">5</span>)</span><br><span class="line">            explode_bomb();</span><br><span class="line">        <span class="keyword">if</span>(++i == <span class="number">6</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">do</span>{</span><br><span class="line">                j = i;</span><br><span class="line">                <span class="keyword">if</span>(nums[j]==num[k])</span><br><span class="line">                    explode_bomb();</span><br><span class="line">        }<span class="keyword">while</span>(++j&lt;=<span class="number">5</span>);</span><br><span class="line">            k+=<span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//第二部分</span></span><br><span class="line">    last = <span class="number">7</span>;</span><br><span class="line">    i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">do</span>{</span><br><span class="line">        nums[i] = <span class="number">7</span>-nums[i];</span><br><span class="line">    }<span class="keyword">while</span>(++i!=<span class="number">7</span>);</span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i!=<span class="number">6</span>;++i)</span><br><span class="line">    {</span><br><span class="line">       <span class="keyword">if</span>(nums[i]&gt;<span class="number">1</span>)</span><br><span class="line">       {</span><br><span class="line">            var3 = <span class="number">1</span>;</span><br><span class="line">            var2 = nodes;</span><br><span class="line">            <span class="keyword">do</span>{</span><br><span class="line">                    var2=var2-&gt;next;</span><br><span class="line">            }<span class="keyword">while</span>(++var3!=nums[i]);</span><br><span class="line">       }</span><br><span class="line">       <span class="keyword">else</span></span><br><span class="line">       {</span><br><span class="line">            var2 =  nodes;</span><br><span class="line">       }</span><br><span class="line">       arr[i] = var2;</span><br><span class="line">    }</span><br></pre></td></tr></tbody></table></figure>
<h4 id="第三部分"><a href="#第三部分" class="headerlink" title="第三部分"></a>第三部分</h4><p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202305141513827.png"></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    i = <span class="number">1</span>;</span><br><span class="line">    last = <span class="number">6</span>;</span><br><span class="line">    j = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    {</span><br><span class="line">        var2 = arr[i];</span><br><span class="line">        arr[j]-&gt;next = var2;</span><br><span class="line">        j = i;</span><br><span class="line">        <span class="keyword">if</span>(++i==last)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">    arr[<span class="number">5</span>]-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">    i = <span class="number">5</span>;</span><br><span class="line">    var3 = arr[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">do</span>{</span><br><span class="line">        <span class="keyword">if</span>(*var3&lt;*(var3-&gt;next))</span><br><span class="line">            explode_bomb();</span><br><span class="line">        var3 = var3-&gt;next;</span><br><span class="line">    }<span class="keyword">while</span>(--i);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>整个流程:<br>第一部分读入六个数字到栈上的nums数组,检查每个数字都不大于6且各不相等.<br>(其实就是读1-6的数字排列)<br>第二部分将nums数组中每个数num = 7-num.并以此在栈上的arr指针数组中存放对应数字的结点指针.<br>第三部分根据arr指针数组的顺序重构nodes链表.最后遍历链表检查链表中值是否为递减排序.<br>递增排序nodes链表:”3 4 5 6 1 2”,故payload:”4 3 2 1 6 5”<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202305141525078.png"></p>
<h2 id="secret-phase"><a href="#secret-phase" class="headerlink" title="secret_phase"></a>secret_phase</h2><p>呃呃有一个隐藏关卡.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202305141553892.png"><br>发现进入条件是从0x603870读取两个数字和一个字符串,且字符串要为”DrEvil”.查看0x603870内容发现为phase_4的payload(逆一下read_line函数也能算出来),即只需该phase_4的payload为”7 0 DrEvil”即可进入.</p>
<p>读入一个小于1000的数字.进入fun7.<br>一个递归,观察ptr可以发现是一个二叉排序树的根节点.最后要使返回值为2.num应为22.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202305141656566.png"></p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">fun7(ptr,num)</span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span>(!ptr)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span>(*ptr&gt;num)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>*fun7(*(ptr+<span class="number">8</span>),num);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>(*ptr!=num)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>*fun7(*(ptr+<span class="number">16</span>),num)+<span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Lab3-Attack-Lab"><a href="#Lab3-Attack-Lab" class="headerlink" title="Lab3:Attack Lab"></a>Lab3:Attack Lab</h1><p>这个就懒得做了,Linux下基本的ROP和shellcode还是比较熟的.</p>
<h1 id="Lab4-Architecture-Lab"><a href="#Lab4-Architecture-Lab" class="headerlink" title="Lab4:Architecture Lab"></a>Lab4:Architecture Lab</h1><p>说实话处理器这一章本来就看的云里雾里的.</p>
<h2 id="Part-A"><a href="#Part-A" class="headerlink" title="Part A"></a>Part A</h2><h3 id="sum-list"><a href="#sum-list" class="headerlink" title="sum_list"></a>sum_list</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">            .pos 0</span><br><span class="line">            irmovq stack,%rsp</span><br><span class="line">            call main</span><br><span class="line">            halt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            .align 8</span><br><span class="line">ele1:</span><br><span class="line">            .quad 0x00a</span><br><span class="line">            .quad ele2</span><br><span class="line">ele2:       </span><br><span class="line">            .quad 0x0b0</span><br><span class="line">            .quad ele3</span><br><span class="line">ele3:</span><br><span class="line">            .quad 0xc00</span><br><span class="line">            .quad 0</span><br><span class="line">main:</span><br><span class="line">            irmovq ele1,%rdi</span><br><span class="line">            call sum_list</span><br><span class="line">            pushq %rax</span><br><span class="line">            ret</span><br><span class="line">sum_list:</span><br><span class="line">            xorq %rax,%rax</span><br><span class="line">            jmp test</span><br><span class="line">test:</span><br><span class="line">            andq %rdi,%rdi</span><br><span class="line">            jne loop</span><br><span class="line">            ret</span><br><span class="line">loop:</span><br><span class="line">            mrmovq (%rdi),%rbx</span><br><span class="line">            addq %rbx,%rax</span><br><span class="line">            mrmovq 8(%rdi),%rdi</span><br><span class="line">            jmp test</span><br><span class="line">            </span><br><span class="line">            .pos 0x200</span><br><span class="line">stack:</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="rsum-list"><a href="#rsum-list" class="headerlink" title="rsum_list"></a>rsum_list</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">            .pos 0</span><br><span class="line">            irmovq stack,%rsp</span><br><span class="line">            call main</span><br><span class="line">            halt</span><br><span class="line"></span><br><span class="line">            .align 8</span><br><span class="line">ele1:</span><br><span class="line">            .quad 0x00a</span><br><span class="line">            .quad ele2</span><br><span class="line">ele2:</span><br><span class="line">            .quad 0x0b0</span><br><span class="line">            .quad ele3</span><br><span class="line">ele3:</span><br><span class="line">            .quad 0xc00</span><br><span class="line">            .quad 0</span><br><span class="line">main:</span><br><span class="line">            irmovq ele1,%rdi</span><br><span class="line">            call rsum_list</span><br><span class="line">            pushq %rax</span><br><span class="line">            ret</span><br><span class="line">rsum_list:</span><br><span class="line">            xorq %rbx,%rbx</span><br><span class="line">            pushq %rbx</span><br><span class="line">            andq %rdi,%rdi</span><br><span class="line">            jne else</span><br><span class="line">            xorq %rax,%rax</span><br><span class="line">            popq %rbx</span><br><span class="line">            ret</span><br><span class="line">else:</span><br><span class="line">            mrmovq (%rdi),%rcx</span><br><span class="line">            rmmovq %rcx,(%rsp)</span><br><span class="line">            mrmovq 8(%rdi),%rdi</span><br><span class="line">            call rsum_list</span><br><span class="line">            mrmovq (%rsp),%rbx</span><br><span class="line">            addq %rbx,%rax</span><br><span class="line">            popq %rbx</span><br><span class="line">            ret</span><br><span class="line"></span><br><span class="line">            .pos 0x200</span><br><span class="line">stack:            </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="copy-block"><a href="#copy-block" class="headerlink" title="copy_block"></a>copy_block</h3><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">            .pos 0</span><br><span class="line">            irmovq stack,%rsp</span><br><span class="line">            call main</span><br><span class="line">            halt</span><br><span class="line"></span><br><span class="line">            .align 8</span><br><span class="line">src:</span><br><span class="line">            .quad 0x00a</span><br><span class="line">            .quad 0x0b0</span><br><span class="line">            .quad 0xc00</span><br><span class="line">dest:        </span><br><span class="line">            .quad 0x111</span><br><span class="line">            .quad 0x222</span><br><span class="line">            .quad 0x333</span><br><span class="line">main:</span><br><span class="line">            irmovq $3,%rdx</span><br><span class="line">            irmovq src,%rdi</span><br><span class="line">            irmovq dest,%rsi</span><br><span class="line">            call copy_block</span><br><span class="line">            pushq %rax</span><br><span class="line">            ret</span><br><span class="line">copy_block:</span><br><span class="line">            xorq %rax,%rax</span><br><span class="line">            jmp condition</span><br><span class="line">condition:</span><br><span class="line">            andq %rdx,%rdx</span><br><span class="line">            jne loop</span><br><span class="line">            ret</span><br><span class="line">loop:</span><br><span class="line">            irmovq $8,%r8</span><br><span class="line">            mrmovq (%rdi),%rcx</span><br><span class="line">            addq %r8,%rdi</span><br><span class="line">            rmmovq %rcx,(%rsi)</span><br><span class="line">            addq %r8,%rsi</span><br><span class="line">            xorq %rcx,%rax</span><br><span class="line">            irmovq $1,%r8</span><br><span class="line">            subq %r8,%rdx</span><br><span class="line">            jmp condition</span><br><span class="line"></span><br><span class="line">            .pos 0x200</span><br><span class="line">stack:</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h2 id="Part-B"><a href="#Part-B" class="headerlink" title="Part B"></a>Part B</h2><p>根据IADDQ指令执行的六个阶段,添加一下需要用到的sig就行了.<br>挺简单的,这里就不贴出来了.</p>
<h2 id="Part-C"><a href="#Part-C" class="headerlink" title="Part C"></a>Part C</h2><h3 id="iaddq"><a href="#iaddq" class="headerlink" title="iaddq"></a>iaddq</h3><p>和Part B一样添加iaddq指令</p>
<h3 id="循环展开"><a href="#循环展开" class="headerlink" title="循环展开"></a>循环展开</h3><p>先6路+3路循环展开得到CPE9.15、Score27.0</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"># You can modify this portion</span><br><span class="line">	# Loop header</span><br><span class="line">	xorq %rax,%rax		# count = 0;</span><br><span class="line">	andq %rdx,%rdx		# len &lt;= 0?</span><br><span class="line">	jmp test		# if so, goto Done:</span><br><span class="line"></span><br><span class="line"># Loop header</span><br><span class="line">    andq %rdx,%rdx      # len &lt;= 0?</span><br><span class="line">    jmp test</span><br><span class="line">Loop:</span><br><span class="line">    mrmovq (%rdi),%r8</span><br><span class="line">    rmmovq %r8,(%rsi)</span><br><span class="line">    andq %r8,%r8</span><br><span class="line">    jle Loop1</span><br><span class="line">    iaddq $1,%rax</span><br><span class="line">Loop1:</span><br><span class="line">    mrmovq 8(%rdi),%r8</span><br><span class="line">    rmmovq %r8,8(%rsi)</span><br><span class="line">    andq %r8,%r8</span><br><span class="line">    jle Loop2</span><br><span class="line">    iaddq $1,%rax</span><br><span class="line">Loop2:</span><br><span class="line">    mrmovq 16(%rdi),%r8</span><br><span class="line">    rmmovq %r8,16(%rsi)</span><br><span class="line">    andq %r8,%r8</span><br><span class="line">    jle Loop3</span><br><span class="line">    iaddq $1,%rax</span><br><span class="line">Loop3:</span><br><span class="line">    mrmovq 24(%rdi),%r8</span><br><span class="line">    rmmovq %r8,24(%rsi)</span><br><span class="line">    andq %r8,%r8</span><br><span class="line">    jle Loop4</span><br><span class="line">    iaddq $1,%rax</span><br><span class="line">Loop4:</span><br><span class="line">    mrmovq 32(%rdi),%r8</span><br><span class="line">    rmmovq %r8,32(%rsi)</span><br><span class="line">    andq %r8,%r8</span><br><span class="line">    jle Loop5</span><br><span class="line">    iaddq $1,%rax</span><br><span class="line">Loop5:</span><br><span class="line">    mrmovq 40(%rdi),%r8</span><br><span class="line">    rmmovq %r8,40(%rsi)</span><br><span class="line">    iaddq $48,%rdi</span><br><span class="line">    iaddq $48,%rsi</span><br><span class="line">    andq %r8,%r8</span><br><span class="line">    jle test</span><br><span class="line">    iaddq $1,%rax  </span><br><span class="line"></span><br><span class="line">test:</span><br><span class="line">    iaddq $-6, %rdx         # 先减，判断够不够6个</span><br><span class="line">    jge Loop                # 6路展开</span><br><span class="line">    iaddq $6, %rdx</span><br><span class="line">    jmp test2               #剩下的</span><br><span class="line"></span><br><span class="line">L:</span><br><span class="line">    mrmovq (%rdi),%r8</span><br><span class="line">    rmmovq %r8,(%rsi)</span><br><span class="line">    andq %r8,%r8</span><br><span class="line">    jle L1</span><br><span class="line">    iaddq $1,%rax</span><br><span class="line">L1:</span><br><span class="line">    mrmovq 8(%rdi),%r8</span><br><span class="line">    rmmovq %r8,8(%rsi)</span><br><span class="line">    andq %r8,%r8</span><br><span class="line">    jle L2</span><br><span class="line">    iaddq $1,%rax</span><br><span class="line">L2:</span><br><span class="line">    mrmovq 16(%rdi),%r8</span><br><span class="line">    rmmovq %r8,16(%rsi)</span><br><span class="line">    iaddq $24,%rdi</span><br><span class="line">    iaddq $24,%rsi</span><br><span class="line">    andq %r8,%r8</span><br><span class="line">    jle test2</span><br><span class="line">    iaddq $1,%rax</span><br><span class="line">test2:</span><br><span class="line">    iaddq $-3, %rdx         # 先减，判断够不够3个</span><br><span class="line">    jge L</span><br><span class="line">    iaddq $2, %rdx          # -1则不剩了，直接Done,0 剩一个, 1剩2个</span><br><span class="line">    je R0</span><br><span class="line">    jl Done</span><br><span class="line">    mrmovq (%rdi),%r8</span><br><span class="line">    rmmovq %r8,(%rsi)</span><br><span class="line">    andq %r8,%r8</span><br><span class="line">    jle R2</span><br><span class="line">    iaddq $1,%rax</span><br><span class="line">R2:</span><br><span class="line">    mrmovq 8(%rdi),%r8</span><br><span class="line">    rmmovq %r8,8(%rsi)</span><br><span class="line">    andq %r8,%r8</span><br><span class="line">    jle Done</span><br><span class="line">    iaddq $1,%rax</span><br><span class="line">    jmp Done</span><br><span class="line">R0:</span><br><span class="line">    mrmovq (%rdi),%r8</span><br><span class="line">    rmmovq %r8,(%rsi)</span><br><span class="line">    andq %r8,%r8</span><br><span class="line">    jle Done</span><br><span class="line">    iaddq $1,%rax</span><br></pre></td></tr></tbody></table></figure>
<h3 id="消除气泡"><a href="#消除气泡" class="headerlink" title="消除气泡"></a>消除气泡</h3><p>注意到程序中的这个操作,会触发加载/使用数据冒险,导致插入一个气泡指令.<br>所以我们可以一次性复制两个数据,避免加载/使用数据冒险</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mrmovq (%rdi), %r8</span><br><span class="line">mrmovq 8(%rdi), %r9</span><br><span class="line">rmmovq %r8, (%rsi)</span><br><span class="line">rmmovq %r9, 8(%rsi)</span><br></pre></td></tr></tbody></table></figure>

<p>消除后得分45.4</p>
<h1 id="Lab5-Cache-Lab"><a href="#Lab5-Cache-Lab" class="headerlink" title="Lab5:Cache Lab"></a>Lab5:Cache Lab</h1><h2 id="Part-A-1"><a href="#Part-A-1" class="headerlink" title="Part A"></a>Part A</h2><p>模拟Cache的实现.<br>最开始的时候没有看到实验材料里的这句话,考虑复杂了…</p>
<blockquote>
<p>For this this lab, you should assume that memory accesses arealigned properly,  such that a singlememory  access  never  crosses  block  boundaries.   By  making  this  assumption,  you  can  ignore  therequest sizes in thevalgrindtraces</p>
</blockquote>
<p>大概实现了这样的数据结构,实验采取的是LRU策略,可以用链表来组织实现,我这里就用时间戳代替了.(ps:用time(NULL)获取的时间戳不够准确会造成多个行的时间戳相同,使用clock()代替或使用全局变量记录次数.)</p>
<blockquote>
<p>LRU，最近最少使用策略。替换最后一次访问时间最久远的哪一行<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202305182207207.png"></p>
</blockquote>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"cachelab.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;math.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;getopt.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">CacheLine</span>{</span></span><br><span class="line">    <span class="type">int</span> valid;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> time;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> tag;</span><br><span class="line">}CacheLine;</span><br><span class="line"></span><br><span class="line">CacheLine** Cache = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">int</span> groupcount = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> blocksize = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> s,E,b,t;</span><br><span class="line"><span class="type">char</span> verbose = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> misses = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> hits = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> evictions = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//因为不需要实际访问数据内容,所以不需要分配2^b字节的数据空间.</span></span><br><span class="line"><span class="comment">//只要地址位于某Set中且标志位相同,则hit</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">Cache_Init</span><span class="params">(<span class="type">int</span> s,<span class="type">int</span> E,<span class="type">int</span> b)</span></span><br><span class="line">{</span><br><span class="line">    groupcount = <span class="built_in">pow</span>(<span class="number">2</span>,s);</span><br><span class="line">    blocksize = <span class="built_in">pow</span>(<span class="number">2</span>,b);</span><br><span class="line">    Cache = (CacheLine**)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(CacheLine*)*groupcount);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;groupcount;++i)</span><br><span class="line">    {</span><br><span class="line">        Cache[i] = (CacheLine*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(CacheLine)*E);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>;j&lt;E;++j)</span><br><span class="line">        {</span><br><span class="line">            Cache[i][j].valid = <span class="number">0</span>;</span><br><span class="line">            Cache[i][j].time = <span class="number">0</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hit</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span>(verbose==<span class="number">1</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">" hit"</span>);</span><br><span class="line">    ++hits;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">miss</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span>(verbose==<span class="number">1</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">" miss"</span>);</span><br><span class="line">    ++misses;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">eviction</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span>(verbose==<span class="number">1</span>)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">" eviction"</span>);</span><br><span class="line">    ++evictions;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">AccessMemory</span><span class="params">(<span class="type">long</span> <span class="type">long</span> addr,<span class="type">int</span> size)</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">//这个地方使用掩码提取而不是直接移位,是因为算术右移会使标记发生变化.</span></span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> mask;</span><br><span class="line">    <span class="comment">//注意制作掩码的时候的常数类型LL</span></span><br><span class="line">    mask = (<span class="number">1LL</span> &lt;&lt; (s + b)) - <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> Setindex = (mask &amp; addr) &gt;&gt; b;</span><br><span class="line">    <span class="comment">// mask = (1LL &lt;&lt; b) - 1;</span></span><br><span class="line">    <span class="comment">// int blockoffset = mask &amp; addr;</span></span><br><span class="line">    mask = (<span class="number">1LL</span> &lt;&lt; t) - <span class="number">1</span>;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> tag = (addr &gt;&gt; (s + b)) &amp; mask;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    CacheLine* CacheSet = Cache[Setindex];</span><br><span class="line">    <span class="type">int</span> flag = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> LRtime = CacheSet[<span class="number">0</span>].time;</span><br><span class="line">    <span class="type">int</span> LRid = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;E;++i)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span>(CacheSet[i].valid==<span class="number">0</span>)</span><br><span class="line">        {</span><br><span class="line">            miss();</span><br><span class="line">            CacheSet[i].tag = tag;</span><br><span class="line">            CacheSet[i].valid = <span class="number">1</span>;</span><br><span class="line">            CacheSet[i].time = clock();</span><br><span class="line">            flag = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span>(CacheSet[i].tag==tag)</span><br><span class="line">        {</span><br><span class="line">            hit();</span><br><span class="line">            CacheSet[i].time = clock();</span><br><span class="line">            flag = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span>(CacheSet[i].time&lt;LRtime)</span><br><span class="line">        {</span><br><span class="line">            LRtime = CacheSet[i].time;</span><br><span class="line">            LRid = i;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>(flag==<span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        miss();</span><br><span class="line">        CacheSet[LRid].tag = tag;</span><br><span class="line">        CacheSet[LRid].time = clock();</span><br><span class="line">        eviction();</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span>* argv[])</span></span><br><span class="line">{</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* trace = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> optc;</span><br><span class="line">    <span class="keyword">while</span>((optc = getopt(argc,(<span class="type">char</span>* <span class="type">const</span> *)argv,<span class="string">"vs:E:b:t:"</span>))!=<span class="number">-1</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">switch</span>(optc)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'s'</span>:</span><br><span class="line">                s = atoi(optarg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'E'</span>:</span><br><span class="line">                E = atoi(optarg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'b'</span>:</span><br><span class="line">                b = atoi(optarg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'t'</span>:</span><br><span class="line">                trace = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="built_in">strlen</span>(optarg)+<span class="number">1</span>);</span><br><span class="line">                <span class="built_in">strcpy</span>(trace,optarg);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'v'</span>:</span><br><span class="line">                verbose = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;                </span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    t = <span class="number">64</span>-s-b;</span><br><span class="line"></span><br><span class="line">    Cache_Init(s,E,b);</span><br><span class="line"></span><br><span class="line">    FILE* tracefile = fopen(trace,<span class="string">"r"</span>);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">50</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> opt;</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> addr;</span><br><span class="line">    <span class="type">int</span> size;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="number">50</span>);</span><br><span class="line">        fgets(buf,<span class="number">50</span>,tracefile);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">sscanf</span>(buf,<span class="string">" %c %llx,%d"</span>,&amp;opt,&amp;addr,&amp;size)!=<span class="number">3</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">switch</span>(opt)</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'I'</span>:</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'L'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'S'</span>:</span><br><span class="line">                <span class="keyword">if</span>(verbose==<span class="number">1</span>)</span><br><span class="line">                {</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%c %llx,%d"</span>,opt,addr,size);</span><br><span class="line">                    AccessMemory(addr,size);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">" \n"</span>);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    AccessMemory(addr,size);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'M'</span>:</span><br><span class="line">                <span class="keyword">if</span>(verbose==<span class="number">1</span>)</span><br><span class="line">                {</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"%c %llx,%d"</span>,opt,addr,size);</span><br><span class="line">                    AccessMemory(addr,size);</span><br><span class="line">                    AccessMemory(addr,size);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">" \n"</span>);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                {</span><br><span class="line">                    AccessMemory(addr,size);</span><br><span class="line">                    AccessMemory(addr,size);</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    printSummary(hits,misses,evictions);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(trace);</span><br><span class="line">    trace = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;groupcount;++i)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">free</span>(Cache[i]);</span><br><span class="line">        Cache[i] = <span class="literal">NULL</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">free</span>(Cache);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>完成的截图<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202305182159330.png"></p>
<h2 id="Part-B-1"><a href="#Part-B-1" class="headerlink" title="Part B"></a>Part B</h2><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/387662272">https://zhuanlan.zhihu.com/p/387662272</a></p>
<h3 id="32x32"><a href="#32x32" class="headerlink" title="32x32"></a>32x32</h3><h4 id="暴力转置"><a href="#暴力转置" class="headerlink" title="暴力转置"></a>暴力转置</h4><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">transpose_submit</span><span class="params">(<span class="type">int</span> M, <span class="type">int</span> N, <span class="type">int</span> A[N][M], <span class="type">int</span> B[M][N])</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> i, j, tmp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; N; i++) {</span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">0</span>; j &lt; M; j++) {</span><br><span class="line">            tmp = A[i][j];</span><br><span class="line">            B[j][i] = tmp;</span><br><span class="line">        }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202305241452391.png"></p>
<h4 id="分块转置"><a href="#分块转置" class="headerlink" title="分块转置"></a>分块转置</h4><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">transpose_submit</span><span class="params">(<span class="type">int</span> M, <span class="type">int</span> N, <span class="type">int</span> A[N][M], <span class="type">int</span> B[M][N])</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="type">int</span> i1,j1;</span><br><span class="line">    <span class="keyword">for</span>(j = <span class="number">0</span>;j&lt;M;j+=<span class="number">8</span>)</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;M;i+=<span class="number">8</span>)</span><br><span class="line">            <span class="keyword">for</span>(j1 = j;j1&lt;j+<span class="number">8</span>;++j1)</span><br><span class="line">                <span class="keyword">for</span>(i1 = i;i1&lt;i+<span class="number">8</span>;++i1)</span><br><span class="line">                    B[j1][i1] = A[i1][j1];</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202305241452306.png"></p>
<h4 id="分块-变量存储"><a href="#分块-变量存储" class="headerlink" title="分块+变量存储"></a>分块+变量存储</h4><p>A和B矩阵相同下标的元素映射到缓存的同一组(回忆一下缓存的分组机制)<br>所以对于对角线上的元素,AB的连续访问发生冲突.<br>这里可以用空间换时间,一次将进入缓存的一整行读出来保存到临时变量中.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">transpose_submit</span><span class="params">(<span class="type">int</span> M, <span class="type">int</span> N, <span class="type">int</span> A[N][M], <span class="type">int</span> B[M][N])</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="type">int</span> j1;</span><br><span class="line">    <span class="type">int</span> val1,val2,val3,val4,val5,val6,val7,val0;</span><br><span class="line">    <span class="keyword">for</span>(j = <span class="number">0</span>;j&lt;M;j+=<span class="number">8</span>)</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;M;i+=<span class="number">8</span>)</span><br><span class="line">            <span class="keyword">for</span>(j1 = j;j1&lt;j+<span class="number">8</span>;++j1)</span><br><span class="line">            {</span><br><span class="line">                val0 = A[j1][i];</span><br><span class="line">                val1 = A[j1][i+<span class="number">1</span>];</span><br><span class="line">                val2 = A[j1][i+<span class="number">2</span>];</span><br><span class="line">                val3 = A[j1][i+<span class="number">3</span>];</span><br><span class="line">                val4 = A[j1][i+<span class="number">4</span>];</span><br><span class="line">                val5 = A[j1][i+<span class="number">5</span>];</span><br><span class="line">                val6 = A[j1][i+<span class="number">6</span>];</span><br><span class="line">                val7 = A[j1][i+<span class="number">7</span>];</span><br><span class="line">                B[i][j1] = val0;</span><br><span class="line">                B[i+<span class="number">1</span>][j1] = val1;</span><br><span class="line">                B[i+<span class="number">2</span>][j1] = val2;</span><br><span class="line">                B[i+<span class="number">3</span>][j1] = val3;</span><br><span class="line">                B[i+<span class="number">4</span>][j1] = val4;</span><br><span class="line">                B[i+<span class="number">5</span>][j1] = val5;</span><br><span class="line">                B[i+<span class="number">6</span>][j1] = val6;</span><br><span class="line">                B[i+<span class="number">7</span>][j1] = val7;</span><br><span class="line">            }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202305241453434.png"></p>
<h3 id="64x64"><a href="#64x64" class="headerlink" title="64x64"></a>64x64</h3><p>按照8x8分块,块的内部会发生冲突,于是使用4x4分块.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> transpose_submit_desc[] = <span class="string">"Transpose submission"</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">transpose_submit</span><span class="params">(<span class="type">int</span> M, <span class="type">int</span> N, <span class="type">int</span> A[N][M], <span class="type">int</span> B[M][N])</span></span><br><span class="line">{</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> i, j;</span><br><span class="line">    <span class="type">int</span> i1,j1;</span><br><span class="line">    <span class="keyword">for</span>(j = <span class="number">0</span>;j&lt;M;j+=<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>;i&lt;M;i+=<span class="number">4</span>)</span><br><span class="line">            <span class="keyword">for</span>(j1 = j;j1&lt;j+<span class="number">4</span>;++j1)</span><br><span class="line">                <span class="keyword">for</span>(i1 = i;i1&lt;i+<span class="number">4</span>;++i1)</span><br><span class="line">                    B[j1][i1] = A[i1][j1];</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202305241548256.png"></p>
<h1 id="Lab6-Shell-lab"><a href="#Lab6-Shell-lab" class="headerlink" title="Lab6:Shell lab"></a>Lab6:Shell lab</h1><p>实现一个有工作分配,信号处理,进程回收的shell.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202306190955121.png"></p>
<h2 id="部分实现"><a href="#部分实现" class="headerlink" title="部分实现"></a>部分实现</h2><h3 id="函数声明"><a href="#函数声明" class="headerlink" title="函数声明"></a>函数声明</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">eval</span><span class="params">(<span class="type">char</span> *cmdline)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">builtin_cmd</span><span class="params">(<span class="type">char</span> **argv)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">do_bgfg</span><span class="params">(<span class="type">char</span> **argv)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">waitfg</span><span class="params">(<span class="type">pid_t</span> pid)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sigchld_handler</span><span class="params">(<span class="type">int</span> sig)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sigtstp_handler</span><span class="params">(<span class="type">int</span> sig)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sigint_handler</span><span class="params">(<span class="type">int</span> sig)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Here are helper routines that we've provided for you */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">parseline</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *cmdline, <span class="type">char</span> **argv)</span></span>; </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sigquit_handler</span><span class="params">(<span class="type">int</span> sig)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">clearjob</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *job)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">initjobs</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">maxjid</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs)</span></span>; </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">addjob</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs, <span class="type">pid_t</span> pid, <span class="type">int</span> state, <span class="type">char</span> *cmdline)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">deletejob</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs, <span class="type">pid_t</span> pid)</span></span>; </span><br><span class="line"><span class="function"><span class="type">pid_t</span> <span class="title">fgpid</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs)</span></span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">job_t</span> *<span class="built_in">getjobpid</span>(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs, <span class="type">pid_t</span> pid);</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">job_t</span> *<span class="built_in">getjobjid</span>(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs, <span class="type">int</span> jid); </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">pid2jid</span><span class="params">(<span class="type">pid_t</span> pid)</span></span>; </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">listjobs</span><span class="params">(<span class="keyword">struct</span> <span class="type">job_t</span> *jobs)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">usage</span><span class="params">(<span class="type">void</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">unix_error</span><span class="params">(<span class="type">char</span> *msg)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">app_error</span><span class="params">(<span class="type">char</span> *msg)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="type">void</span> <span class="title">handler_t</span><span class="params">(<span class="type">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">handler_t</span> *<span class="title">Signal</span><span class="params">(<span class="type">int</span> signum, <span class="type">handler_t</span> *handler)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*Some function defined by myself*/</span></span><br><span class="line"><span class="function"><span class="type">pid_t</span> <span class="title">Fork</span><span class="params">()</span></span>;<span class="comment">//即CSAPP上提到的错误处理封装函数,不过用起来并不是很顺手</span></span><br></pre></td></tr></tbody></table></figure>
<h3 id="eval"><a href="#eval" class="headerlink" title="eval"></a>eval</h3><p>调用parseline函数解析命令行得到argv参数列表,获得前台或后台运行的标志state.<br>调用builtin_cmd检测是否是内置命令,若是则在其中处理,否则返回eval函数fork出子进程,子进程execve方式启动新程序,父进程将job通过addjob加入全局jobs列表,若为前台运行则调用waitfg等待前台程序结束.</p>
<p>需要注意的问题有两个.<br>第一个:</p>
<blockquote>
<p>When you run your shell from the standard Unix shell, your shell is running in the foreground processgroup.  If your shell then creates a child process, by defaultthat child will also be a member of theforeground process group. Since typingctrl-csends a SIGINT to every process in the foregroundgroup, typingctrl-cwill send a SIGINT to your shell, as well as to every process that your shellcreated, which obviously isn’t correct.Here  is  the  workaround:   After  thefork,  but  before  theexecve,  the  child  process  should  callsetpgid(0, 0), which puts the child in a new process group whose group ID is identical to thechild’s PID. This ensures that there will be only one process,  your shell, in the foreground processgroup.   When you typectrl-c, the shell should catch the resulting  SIGINT and then forward itto the appropriate foreground job (or more precisely, the process group that contains the foregroundjob).</p>
</blockquote>
<p>因为我们的shell(tsh)是运行在Unix shell之上的,所以当kernel发出一个SIGINT之类的信号,Unix shell会将信号同时发送给tsh以及所有tsh创建的进程(因为tsh是当前shell的前台进程,shell的默认行为会将SIGINT信号发送给整个<code>前台进程组</code>),而我们想要实现的只是将信号发送给tsh的前台进程组.所以在fork子进程后,需要setpgid使得子进程的进程组与父进程独立.</p>
<blockquote>
<p>int setpgid(pid_t pid, pid_t pgid);<br>该函数可以用于将一个进程加入到指定的进程组中，或者创建一个新的进程组。具体的行为取决于 pid 参数的取值：<br>    1. 如果 pid 参数为 0，则表示将调用进程加入到与调用进程的PID相同的进程组中。<br>    2. 如果 pgid 参数为 0，则表示将 pid 指定的进程的进程组ID设置为其自身的PID。<br>    3. 如果 pgid 参数不为 0，则表示将 pid 指定的进程的进程组ID设置为 pgid。<br>    setpgid 函数的返回值为 0 表示成功，返回值为 -1 表示出现错误，此时可以通过查看 errno 变量来获取具体的错误信息。</p>
</blockquote>
<p>第二个:</p>
<blockquote>
<p>In eval, the parent must usesigprocmaskto block SIGCHLD signals before it forks the child,and then unblock these signals, again usingsigprocmaskafter it adds the child to the job list by calling addjob. Since children inherit the blocked vectors of their parents, the child must be sureto then unblock SIGCHLD signals before it execs the new program.6<br>    The parent needs to block theSIGCHLDsignals in this way in order to avoid the race condition wherethe child is reaped by sigchld handler(and thus removed from the job list) before the parent calls addjob.</p>
</blockquote>
<p>由于进程间执行顺序是不确定的,子进程在被fork之后在最极端的情况下可以一直执行到结束而父进程还刚从fork函数返回.也就是说,父进程一旦fork子进程,随时可能收到SIGCHLD信号(子进程随时可能暂停或终止).设想一下在父进程fork子进程后,addjob之前,子进程结束发出SIGCHLD信号,父进程捕获信号并在信号处理程序中deletejob删除一个不存在的job,这可能引发错误或被deletejob无视(取决于deletejob的实现),父进程从信号处理函数返回后再调用addjob则会将一个已经终止的进程加入任务列表中.这显然是错误的.所以需要在fork函数之前阻塞SIGCHLD信号,addjob后恢复.需要注意的是子进程会继承父进程的阻塞状态,所以需要在execve之前恢复阻塞.</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * eval - Evaluate the command line that the user has just typed in</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * If the user has requested a built-in command (quit, jobs, bg or fg)</span></span><br><span class="line"><span class="comment"> * then execute it immediately. Otherwise, fork a child process and</span></span><br><span class="line"><span class="comment"> * run the job in the context of the child. If the job is running in</span></span><br><span class="line"><span class="comment"> * the foreground, wait for it to terminate and then return.  Note:</span></span><br><span class="line"><span class="comment"> * each child process must have a unique process group ID so that our</span></span><br><span class="line"><span class="comment">//  * background children don't receive SIGINT (SIGTSTP) from the kernel</span></span><br><span class="line"><span class="comment"> * when we type ctrl-c (ctrl-z) at the keyboard.  </span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">eval</span><span class="params">(<span class="type">char</span> *cmdline)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">char</span>* argv[MAXARGS];</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">int</span> state;</span><br><span class="line">    <span class="type">sigset_t</span> mask,prev;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sigemptyset</span>(&amp;mask);</span><br><span class="line">    <span class="built_in">sigaddset</span>(&amp;mask,SIGCHLD);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">parseline</span>(cmdline,argv))</span><br><span class="line">        state = BG;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        state = FG;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(argv[<span class="number">0</span>]==<span class="literal">NULL</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">builtin_cmd</span>(argv))</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">sigprocmask</span>(SIG_BLOCK,&amp;mask,&amp;prev);</span><br><span class="line">        <span class="keyword">if</span>((pid = <span class="built_in">Fork</span>())==<span class="number">0</span>)</span><br><span class="line">        {</span><br><span class="line">           <span class="built_in">sigprocmask</span>(SIG_SETMASK,&amp;prev,<span class="literal">NULL</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">setpgid</span>(<span class="number">0</span>, <span class="number">0</span>) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="built_in">unix_error</span>(<span class="string">"setpgid error"</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">execve</span>(argv[<span class="number">0</span>],argv,environ)&lt;<span class="number">0</span>)</span><br><span class="line">            {</span><br><span class="line">                <span class="built_in">unix_error</span>(<span class="string">"%s: command not found"</span>);</span><br><span class="line">                <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="built_in">addjob</span>(jobs,pid,state,cmdline);</span><br><span class="line">        <span class="built_in">sigprocmask</span>(SIG_SETMASK,&amp;prev,<span class="literal">NULL</span>);</span><br><span class="line">        <span class="keyword">if</span>(state==FG)</span><br><span class="line">            <span class="built_in">waitfg</span>(pid);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"[%d] (%d) %s"</span>,<span class="built_in">pid2jid</span>(pid),pid,cmdline);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="builtin-cmd"><a href="#builtin-cmd" class="headerlink" title="builtin_cmd"></a>builtin_cmd</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">builtin_cmd</span><span class="params">(<span class="type">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>],<span class="string">"quit"</span>))</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>],<span class="string">"fg"</span>)||!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>],<span class="string">"bg"</span>))</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">do_bgfg</span>(argv);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>],<span class="string">"jobs"</span>))</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">listjobs</span>(jobs);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    }        </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;     <span class="comment">/* not a builtin command */</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="dofgbg"><a href="#dofgbg" class="headerlink" title="dofgbg"></a>dofgbg</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * do_bgfg - Execute the builtin bg and fg commands</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">do_bgfg</span><span class="params">(<span class="type">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">int</span> jid;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">job_t</span>* job;</span><br><span class="line">    <span class="keyword">if</span>(argv[<span class="number">1</span>]==<span class="literal">NULL</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s command requires PID or %%jobid argument\n"</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(argv[<span class="number">1</span>][<span class="number">0</span>]==<span class="string">'%'</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span>((jid = <span class="built_in">atoi</span>(&amp;argv[<span class="number">1</span>][<span class="number">1</span>]))&lt;=<span class="number">0</span>)</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%s: argument must be a PID or %%jobid\n"</span>,argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span>((job = <span class="built_in">getjobjid</span>(jobs,jid))==<span class="literal">NULL</span>)</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%%%d: No such job\n"</span>, jid);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span>((pid = <span class="built_in">atoi</span>(&amp;argv[<span class="number">1</span>][<span class="number">1</span>]))&lt;=<span class="number">0</span>)</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%s: argument must be a PID or %%jobid\n"</span>,argv[<span class="number">0</span>]);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span>((job = <span class="built_in">getjobpid</span>(jobs,pid))==<span class="literal">NULL</span>)</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%%%d: No such process\n"</span>, pid);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>],<span class="string">"bg"</span>))</span><br><span class="line">    {</span><br><span class="line">        job-&gt;state = BG;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">kill</span>(-job-&gt;pid,SIGCONT)&lt;<span class="number">0</span>)</span><br><span class="line">            <span class="built_in">unix_error</span>(<span class="string">"kill error"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[%d] (%d) %s"</span>, job-&gt;jid, job-&gt;pid, job-&gt;cmdline);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(argv[<span class="number">0</span>],<span class="string">"fg"</span>))</span><br><span class="line">    {</span><br><span class="line">        job-&gt;state = FG;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">kill</span>(-job-&gt;pid,SIGCONT)&lt;<span class="number">0</span>)</span><br><span class="line">            <span class="built_in">unix_error</span>(<span class="string">"kill error"</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"[%d] (%d) %s"</span>, job-&gt;jid, job-&gt;pid, job-&gt;cmdline);</span><br><span class="line">        <span class="built_in">waitfg</span>(job-&gt;pid);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"do_bgfg: Internal error"</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="waitfg"><a href="#waitfg" class="headerlink" title="waitfg"></a>waitfg</h3><p>我使用了和write up上不同的处理,具体见注释.</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * waitfg - Block until process pid is no longer the foreground process</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">waitfg</span><span class="params">(<span class="type">pid_t</span> pid)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">job_t</span>* job = <span class="built_in">getjobpid</span>(jobs,pid);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//根据write up上的描述,waitfg使用 use a busy loop around thesleepfunction.的方式实现</span></span><br><span class="line">    <span class="comment">// while(1)</span></span><br><span class="line">    <span class="comment">// {</span></span><br><span class="line">    <span class="comment">//     if(job-&gt;state==FG)</span></span><br><span class="line">    <span class="comment">//         sleep(1);</span></span><br><span class="line">    <span class="comment">//     else</span></span><br><span class="line">    <span class="comment">//         break;</span></span><br><span class="line">    <span class="comment">// }</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//但CSAPP书上提到这种方法执行太慢,故采用sigsuspend函数</span></span><br><span class="line">    <span class="type">sigset_t</span> mask,prev;</span><br><span class="line">    <span class="comment">//获取当前set存入prev</span></span><br><span class="line">    <span class="built_in">sigemptyset</span>(&amp;mask);</span><br><span class="line">    <span class="built_in">sigprocmask</span>(SIG_BLOCK,&amp;mask,&amp;prev);</span><br><span class="line">    <span class="keyword">while</span>(job-&gt;state==FG)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">sigsuspend</span>(&amp;prev);</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">sigprocmask</span>(SIG_SETMASK,&amp;prev,<span class="literal">NULL</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="sigchld-handler"><a href="#sigchld-handler" class="headerlink" title="sigchld_handler"></a>sigchld_handler</h3><p>注意Linux的显式信号阻塞可能丢弃掉一部分SIGCHLD信号,所以在sigchld_handler函数的一次调用中需要尽可能多的回收子进程.</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * sigchld_handler - The kernel sends a SIGCHLD to the shell whenever</span></span><br><span class="line"><span class="comment"> *     a child job terminates (becomes a zombie), or stops because it</span></span><br><span class="line"><span class="comment"> *     received a SIGSTOP or SIGTSTP signal. The handler reaps all</span></span><br><span class="line"><span class="comment"> *     available zombie children, but doesn't wait for any other</span></span><br><span class="line"><span class="comment"> *     currently running children to terminate.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sigchld_handler</span><span class="params">(<span class="type">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    <span class="type">int</span> jid;</span><br><span class="line">    <span class="type">int</span> status;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">job_t</span>* job;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(verbose)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"sigchld_handler: entering"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>((pid = <span class="built_in">waitpid</span>(<span class="number">-1</span>,&amp;status,WNOHANG|WUNTRACED))&gt;<span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span>((job = <span class="built_in">getjobpid</span>(jobs,pid))==<span class="literal">NULL</span>)</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">fprintf</span>(<span class="string">"Lost track of (%d)\n"</span>,pid);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        jid = job-&gt;jid;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">WIFSTOPPED</span>(status))</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Job [%d] (%d) stopped by signal %d\n"</span>,jid,job-&gt;pid,<span class="built_in">WSTOPSIG</span>(status));</span><br><span class="line">            job-&gt;state = ST;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">WIFEXITED</span>(status))</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">deletejob</span>(jobs,pid))</span><br><span class="line">                <span class="keyword">if</span>(verbose)</span><br><span class="line">                {</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"sigchld_handler: Job [%d] (%d) deleted\n"</span>, jid, pid);</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"sigchld_handler: Job [%d] (%d) terminates OK (status %d)\n"</span>, jid, pid, <span class="built_in">WEXITSTATUS</span>(status));</span><br><span class="line">                }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">deletejob</span>(jobs,pid))</span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">if</span>(verbose)</span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">"sigchld_handler: Job [%d] (%d) deleted\n"</span>, jid, pid);</span><br><span class="line">            }</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Job [%d] (%d) terminated by signal %d\n"</span>, jid, pid, <span class="built_in">WTERMSIG</span>(status));</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(verbose)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"sigchld_handler: exiting"</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="sigint-handler、sigtstp-handler"><a href="#sigint-handler、sigtstp-handler" class="headerlink" title="sigint_handler、sigtstp_handler"></a>sigint_handler、sigtstp_handler</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * sigint_handler - The kernel sends a SIGINT to the shell whenver the</span></span><br><span class="line"><span class="comment"> *    user types ctrl-c at the keyboard.  Catch it and send it along</span></span><br><span class="line"><span class="comment"> *    to the foreground job.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sigint_handler</span><span class="params">(<span class="type">int</span> sig)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span>(verbose)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"sigint_handler: entering"</span>);</span><br><span class="line">    <span class="type">pid_t</span> pid = <span class="built_in">fgpid</span>(jobs);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pid){</span><br><span class="line">        <span class="comment">//pid设置为负,将信号发送给整个进程组.</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">kill</span>(-pid, SIGINT) &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="built_in">unix_error</span>(<span class="string">"kill (sigint) error"</span>);</span><br><span class="line">        <span class="keyword">if</span>(verbose){</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"sigint_handler: Job (%d) killed\n"</span>, pid);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(verbose)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"sigint_handler: exiting"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * sigtstp_handler - The kernel sends a SIGTSTP to the shell whenever</span></span><br><span class="line"><span class="comment"> *     the user types ctrl-z at the keyboard. Catch it and suspend the</span></span><br><span class="line"><span class="comment"> *     foreground job by sending it a SIGTSTP.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sigtstp_handler</span><span class="params">(<span class="type">int</span> sig)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">if</span>(verbose)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"sigstp_handler: entering"</span>);</span><br><span class="line">    <span class="type">pid_t</span> pid = <span class="built_in">fgpid</span>(jobs);</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">job_t</span>* job = <span class="built_in">getjobpid</span>(jobs,pid);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(pid)</span><br><span class="line">    {</span><br><span class="line">        <span class="comment">//pid设置为负,将信号发送给整个进程组.</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">kill</span>(-pid,SIGTSTP)&lt;<span class="number">0</span>)</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">unix_error</span>(<span class="string">"kill (tstp) error"</span>);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span>(verbose){</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"sigstp_handler: Job [%d] (%d) stopped\n"</span>, job-&gt;jid, pid);</span><br><span class="line">            }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(verbose)</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"sigstp_handler: exiting"</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="parseline"><a href="#parseline" class="headerlink" title="parseline"></a>parseline</h3><p>lab直接给出的,学一下实现.</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment"> * parseline - Parse the command line and build the argv array.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * Characters enclosed in single quotes are treated as a single</span></span><br><span class="line"><span class="comment"> * argument.  Return true if the user has requested a BG job, false if</span></span><br><span class="line"><span class="comment"> * the user has requested a FG job.  </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">parseline</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *cmdline, <span class="type">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> array[MAXLINE]; <span class="comment">/* holds local copy of command line */</span></span><br><span class="line">    <span class="type">char</span> *buf = array;          <span class="comment">/* ptr that traverses command line */</span></span><br><span class="line">    <span class="type">char</span> *delim;                <span class="comment">/* points to first space delimiter */</span></span><br><span class="line">    <span class="type">int</span> argc;                   <span class="comment">/* number of args */</span></span><br><span class="line">    <span class="type">int</span> bg;                     <span class="comment">/* background job? */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">strcpy</span>(buf, cmdline);</span><br><span class="line">    buf[<span class="built_in">strlen</span>(buf)<span class="number">-1</span>] = <span class="string">' '</span>;  <span class="comment">/* replace trailing '\n' with space */</span></span><br><span class="line">    <span class="keyword">while</span> (*buf &amp;&amp; (*buf == <span class="string">' '</span>)) <span class="comment">/* ignore leading spaces */</span></span><br><span class="line">	buf++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Build the argv list */</span></span><br><span class="line">    argc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (*buf == <span class="string">'\''</span>) {</span><br><span class="line">	buf++;</span><br><span class="line">	delim = <span class="built_in">strchr</span>(buf, <span class="string">'\''</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">	delim = <span class="built_in">strchr</span>(buf, <span class="string">' '</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (delim) {</span><br><span class="line">	argv[argc++] = buf;</span><br><span class="line">	*delim = <span class="string">'\0'</span>;</span><br><span class="line">	buf = delim + <span class="number">1</span>;</span><br><span class="line">	<span class="keyword">while</span> (*buf &amp;&amp; (*buf == <span class="string">' '</span>)) <span class="comment">/* ignore spaces */</span></span><br><span class="line">	       buf++;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (*buf == <span class="string">'\''</span>) {</span><br><span class="line">	    buf++;</span><br><span class="line">	    delim = <span class="built_in">strchr</span>(buf, <span class="string">'\''</span>);</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">else</span> {</span><br><span class="line">	    delim = <span class="built_in">strchr</span>(buf, <span class="string">' '</span>);</span><br><span class="line">	}</span><br><span class="line">    }</span><br><span class="line">    argv[argc] = <span class="literal">NULL</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (argc == <span class="number">0</span>)  <span class="comment">/* ignore blank line */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* should the job run in the background? */</span></span><br><span class="line">    <span class="keyword">if</span> ((bg = (*argv[argc<span class="number">-1</span>] == <span class="string">'&amp;'</span>)) != <span class="number">0</span>) {</span><br><span class="line">	argv[--argc] = <span class="literal">NULL</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> bg;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h1 id="Lab7-Malloc-lab"><a href="#Lab7-Malloc-lab" class="headerlink" title="Lab7:Malloc lab"></a>Lab7:Malloc lab</h1><h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><p>参照ptmalloc.</p>
<h3 id="堆块结构"><a href="#堆块结构" class="headerlink" title="堆块结构"></a>堆块结构</h3><p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202306221858686.png"></p>
<h3 id="空闲块组织"><a href="#空闲块组织" class="headerlink" title="空闲块组织"></a>空闲块组织</h3><p>分为fastbins和bins,fastbins不参与合并不进行切割.两者均采用单向链表的组织结构,fastbins有7个,由于堆块对齐的原因各个fastbins中chunk大小相同,故不需排序,从头部取出或放入.bins有8个,需排序.</p>
<h2 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h2><p>第一次跑过所有测试,80分,但此时还没有加入空闲块合并的功能.<br>查看util极低的数据,观察发现确实是空闲块未合并导致的.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202306211450673.png"></p>
<p>加入空闲块合并之后,好的,降了10分<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202306221745035.png"><br>发现原因是因为我的设计大部分参考的是glibc中ptmalloc的实现,注重查找的效率,但由于我本地的机器较快导致性能一直是满分,所以评分仅取决于空间利用率.</p>
<p>所以一些设计比如增加bin的数量(将空闲块按大小分区间组织加快查找速度),设计fastbin不参与合并加快速度,分配较大的top chunk减少mem_sbrk的调用次数(其实没有必要,ptmalloc这样实现是为了减少sbrk或mmap系统调用的开销,而本实验中的mm_malloc是建立在一个模拟的mem_sbrk之上,并不会进行系统调用)等,反而降低了空间利用率.</p>
<p>这是将fastbins和bins数量均减为1,topchunk默认大小改为0x1000后的成绩.可见空间利用率大幅提升.</p>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202306221847904.png"></p>
<p>还有很多可以完善的地方,不过现阶段对算法和数据结构的理解还不够,没办法自己设计,照着ptmalloc2写一份也没有太多意义.等之后看有没有机会实现一个完整的,直接使用系统调用的.</p>
<h3 id="一些debug插曲"><a href="#一些debug插曲" class="headerlink" title="一些debug插曲"></a>一些debug插曲</h3><h4 id="1"><a href="#1" class="headerlink" title="1"></a>1</h4><p>(高达5220%的内存利用率的超级内存分配器<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202306202159747.png"></p>
<p>一部分trace测试因分配到了brk更高地址被终止.<br>另一部分则发生段错误造成crash,测试这部分样例.<br>直接run起来,观察崩溃点,发现程序在访问(eax+4)内存时发生段错误,该表达式对应为top-&gt;size.即eax表示top的值为0.<br>top指针在初始化之后肯定是不可能为0的.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202306202147605.png"><br>设置观察点:watch (top==0),重新运行程序.<br>发现程序在此处停住,但源码中并没有top作为左值的语句.<br>瞬间反应过来,bins下标越界.<br>改掉程序中对i的检查.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202306202152686.png"></p>
<h4 id="2"><a href="#2" class="headerlink" title="2"></a>2</h4><p>然而我调试了接近两个小时后,发现最关键的问题在mdriver程序会多次调用mm_init函数,且在调用前将mem_brk复位,而我的init函数只是为调用一次使用的,并没有清空bins和top,导致多次运行时使用大量mem_brk之外的内存……<br>这才是上面内存利用率超高的原因.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202306210005305.png"></p>
<p>不过两小时也没白费,学了好多诸如watchpoints的调试命令和找到一些调试技巧.</p>
<h4 id="3"><a href="#3" class="headerlink" title="3"></a>3</h4><p>重写init函数,再次运行,不出意外的异常退出.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202306210007226.png"><br>不过只在部分样例中异常退出,原因是ran out of memory.这倒是很正常,因为此时还没有编写空闲块合并和realloc的功能<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202306210008744.png"></p>
<h4 id="4"><a href="#4" class="headerlink" title="4"></a>4</h4><p>编写realloc功能后运行崩溃,调试发现是realloc时没有做边界检查,如果下一个chunk是topchunk将会在切割后unlink(topchunk),而topchunk自然是不会在bin中的故引发”mm_unlink: nonexistent mptr”</p>
<h4 id="5"><a href="#5" class="headerlink" title="5"></a>5</h4><p>在mm_realloc和mm_malloc里调用mm_free时,应该使用用户态的指针而不是堆块头部指针…..感觉这是个挺容易犯错的地方</p>
<h1 id="Lab8-Proxy-lab"><a href="#Lab8-Proxy-lab" class="headerlink" title="Lab8:Proxy lab"></a>Lab8:Proxy lab</h1><h2 id="Part-A-2"><a href="#Part-A-2" class="headerlink" title="Part A"></a>Part A</h2><h3 id="设计-1"><a href="#设计-1" class="headerlink" title="设计"></a>设计</h3><p>使用的结构为</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> method[MAXLINE];</span><br><span class="line">    <span class="type">char</span> host[MAXLINE];</span><br><span class="line">    <span class="type">char</span> port[MAX_PORTLEN];</span><br><span class="line">    <span class="type">char</span> path[MAXLINE];</span><br><span class="line">    <span class="type">char</span> cgiargs[MAXLINE];</span><br><span class="line">    <span class="type">char</span> version[MAXLINE];</span><br><span class="line">}RequestLine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> name[MAXLINE];</span><br><span class="line">    <span class="type">char</span> value[MAXLINE];</span><br><span class="line">}RequestHeader;</span><br></pre></td></tr></tbody></table></figure>
<p>这是整个PartA的处理流程,其中Forward2Client未做处理,直接将从服务器收到的数据原封不动转发给客户端.Part A完成后程序已经可以在浏览器中实现代理访问.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202306240020148.png"><br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202306240023578.png"></p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"csapp.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Recommended max cache and object sizes */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_CACHE_SIZE 1049000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_OBJECT_SIZE 102400</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_PORTLEN 10</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_HEADERS 30</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREFIX_PRINT <span class="string">"HanQi_Proxy &gt; "</span></span></span><br><span class="line"><span class="comment">/* You won't lose style points for including this long line in your code */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *user_agent_hdr = <span class="string">"User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:10.0.3) Gecko/20120305 Firefox/10.0.3"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> method[MAXLINE];</span><br><span class="line">    <span class="type">char</span> host[MAXLINE];</span><br><span class="line">    <span class="type">char</span> port[MAX_PORTLEN];</span><br><span class="line">    <span class="type">char</span> path[MAXLINE];</span><br><span class="line">    <span class="type">char</span> cgiargs[MAXLINE];</span><br><span class="line">    <span class="type">char</span> version[MAXLINE];</span><br><span class="line">}RequestLine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> name[MAXLINE];</span><br><span class="line">    <span class="type">char</span> value[MAXLINE];</span><br><span class="line">}RequestHeader;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"proxy.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">parse_uri</span><span class="params">(<span class="type">char</span> uri[],RequestLine* requestline)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">char</span>* address_ptr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">char</span>* port_ptr = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">char</span>* path_ptr = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(address_ptr = <span class="built_in">strstr</span>(uri,<span class="string">"//"</span>))</span><br><span class="line">        address_ptr += <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        address_ptr = uri;</span><br><span class="line">    <span class="keyword">if</span>(port_ptr = <span class="built_in">strstr</span>(address_ptr,<span class="string">":"</span>))</span><br><span class="line">        port_ptr += <span class="number">1</span>;</span><br><span class="line">    path_ptr = <span class="built_in">strstr</span>(address_ptr,<span class="string">"/"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(path_ptr!=<span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">strncpy</span>(requestline-&gt;path,path_ptr,MAXLINE);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">strncpy</span>(requestline-&gt;path,<span class="string">"/"</span>,<span class="number">2</span>);</span><br><span class="line">        path_ptr = address_ptr+<span class="built_in">strlen</span>(address_ptr);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>(port_ptr!=<span class="literal">NULL</span>)</span><br><span class="line">        <span class="built_in">strncpy</span>(requestline-&gt;port,port_ptr,path_ptr-port_ptr);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">strncpy</span>(requestline-&gt;port,<span class="string">"80"</span>,<span class="number">3</span>);</span><br><span class="line">        port_ptr = path_ptr;</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">strncpy</span>(requestline-&gt;host,address_ptr,port_ptr-address_ptr<span class="number">-1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(PREFIX_PRINT<span class="string">"RequestTarget: %s:%s%s\n"</span>,requestline-&gt;host,requestline-&gt;port,requestline-&gt;path);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">read_requesthdrs</span><span class="params">(<span class="type">rio_t</span>* rio,RequestHeader requestheaders[MAX_HEADERS])</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> buf[MAXLINE];</span><br><span class="line">    <span class="built_in">Rio_readlineb</span>(rio,buf,MAXLINE);</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">strcmp</span>(<span class="string">"\r\n"</span>,buf))</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">sscanf</span>(buf,<span class="string">"%[^:]: %s\r\n"</span>,requestheaders[i].name,requestheaders[i].value);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s: %s\r\n"</span>,requestheaders[i].name,requestheaders[i].value);</span><br><span class="line">        ++i;</span><br><span class="line">        <span class="keyword">if</span>(i==MAX_HEADERS)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="built_in">Rio_readlineb</span>(rio,buf,MAXLINE);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">add_headers</span><span class="params">(RequestHeader requestheaders[MAX_HEADERS],<span class="type">int</span>* headers_num,<span class="type">char</span>* headername,<span class="type">char</span>* headervalue)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;MAX_HEADERS;++i)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span>(!<span class="built_in">strcmp</span>(headername,requestheaders[i].name))</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">strncpy</span>(requestheaders[i].value,headervalue,MAXLINE);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">strncpy</span>(requestheaders[*headers_num].name,headername,MAXLINE);</span><br><span class="line">    <span class="built_in">strncpy</span>(requestheaders[*headers_num].value,headervalue,MAXLINE);</span><br><span class="line">    ++(*headers_num);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Write2Server</span><span class="params">(<span class="type">int</span> server_fd,RequestLine* requestline,RequestHeader requestheaders[],<span class="type">int</span> headers_num)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">printf</span>(PREFIX_PRINT<span class="string">"Forwarding to %s:%s,ing...\n"</span>,requestline-&gt;host,requestline-&gt;port);</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">3</span>*MAXLINE+<span class="number">5</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里不是很懂,最后转发给服务器的uri只留下文件路径?</span></span><br><span class="line">    <span class="built_in">snprintf</span>(buf,<span class="number">3</span>*MAXLINE+<span class="number">5</span>,<span class="string">"%s %s %s\r\n"</span>,requestline-&gt;method,requestline-&gt;path,requestline-&gt;version);    </span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>,buf);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(server_fd,buf,<span class="built_in">strlen</span>(buf));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;headers_num;++i)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">snprintf</span>(buf,<span class="number">3</span>*MAXLINE+<span class="number">5</span>,<span class="string">"%s: %s\r\n"</span>,requestheaders[i].name,requestheaders[i].value);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s"</span>,buf);</span><br><span class="line">        <span class="built_in">Rio_writen</span>(server_fd,buf,<span class="built_in">strlen</span>(buf));</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">Rio_writen</span>(server_fd,<span class="string">"\r\n"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\r\n"</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Forward2Client</span><span class="params">(<span class="type">int</span> client_fd,<span class="type">int</span> server_fd)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span> headers_num = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">2</span>*MAXLINE+<span class="number">5</span>];</span><br><span class="line">    <span class="type">rio_t</span> server_rio;</span><br><span class="line">    <span class="type">int</span> size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(PREFIX_PRINT<span class="string">"Forwarding to Client,ing...\n"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Rio_readinitb</span>(&amp;server_rio,server_fd);</span><br><span class="line">    <span class="built_in">Rio_readlineb</span>(&amp;server_rio,buf,<span class="number">2</span>*MAXLINE+<span class="number">5</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>,buf);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(client_fd,buf,<span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="comment">// headers_num = read_requesthdrs(&amp;server_rio,headers);</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">Rio_readlineb</span>(&amp;server_rio,buf,<span class="number">2</span>*MAXLINE+<span class="number">5</span>);</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">strcmp</span>(<span class="string">"\r\n"</span>,buf))</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s"</span>,buf);</span><br><span class="line">        <span class="built_in">Rio_writen</span>(client_fd,buf,<span class="built_in">strlen</span>(buf));</span><br><span class="line">        <span class="built_in">Rio_readlineb</span>(&amp;server_rio,buf,<span class="number">2</span>*MAXLINE+<span class="number">5</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">Rio_writen</span>(client_fd,<span class="string">"\r\n"</span>,<span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"\r\n"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(size = <span class="built_in">Rio_readlineb</span>(&amp;server_rio,buf,MAXLINE))</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s"</span>,buf);</span><br><span class="line">        <span class="built_in">Rio_writen</span>(client_fd,buf,size);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span>* <span class="title">StartWork</span><span class="params">(<span class="type">int</span> connfd)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">char</span> buf[MAXLINE],uri[MAXLINE];</span><br><span class="line">    RequestLine requestline;</span><br><span class="line">    RequestHeader requestheaders[MAX_HEADERS];</span><br><span class="line">    <span class="type">rio_t</span> client_rio;</span><br><span class="line">    <span class="type">int</span> server_fd;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="built_in">Rio_readinitb</span>(&amp;client_rio,connfd);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">Rio_readlineb</span>(&amp;client_rio,buf,MAXLINE))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"%s"</span>,buf);</span><br><span class="line">    <span class="comment">//writeup中提到这里有个多行请求行的问题,待处理</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     Ideally  your  HTTP  request  parser  will  be  fullyrobust according to the relevant sections of RFC 1945, except for one detail: while the specification allowsfor multiline request fields</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="built_in">sscanf</span>(buf,<span class="string">"%s %s %s"</span>,requestline.method,uri,requestline.version);</span><br><span class="line">    <span class="type">int</span> headers_num = <span class="built_in">read_requesthdrs</span>(&amp;client_rio,requestheaders);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">parse_uri</span>(uri,&amp;requestline);</span><br><span class="line">    <span class="built_in">add_headers</span>(requestheaders,&amp;headers_num,<span class="string">"Host"</span>,requestline.host);</span><br><span class="line">    <span class="built_in">add_headers</span>(requestheaders,&amp;headers_num,<span class="string">"User-Agent"</span>,user_agent_hdr);</span><br><span class="line">    <span class="built_in">add_headers</span>(requestheaders,&amp;headers_num,<span class="string">"Connection"</span>,<span class="string">"close"</span>);</span><br><span class="line">    <span class="built_in">add_headers</span>(requestheaders,&amp;headers_num,<span class="string">"Proxy-Connection"</span>,<span class="string">"close"</span>);</span><br><span class="line"></span><br><span class="line">    server_fd = <span class="built_in">open_clientfd</span>(requestline.host,requestline.port);</span><br><span class="line">    <span class="built_in">printf</span>(PREFIX_PRINT<span class="string">"Connect to %s:%s.(serverFd: %d)\n"</span>,requestline.host,requestline.port,server_fd);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Write2Server</span>(server_fd,&amp;requestline,requestheaders,headers_num);</span><br><span class="line">    <span class="built_in">Forward2Client</span>(connfd,server_fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span> listenfd,connfd;</span><br><span class="line">    <span class="type">char</span> client_hostname[MAXLINE];</span><br><span class="line">    <span class="type">char</span> client_port[MAX_PORTLEN];</span><br><span class="line">    <span class="type">socklen_t</span> clientlen;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_storage</span> clientaddr;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(argc!=<span class="number">2</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr,PREFIX_PRINT<span class="string">"usage: %s &lt;port&gt;\n"</span>,argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">    listenfd = <span class="built_in">open_listenfd</span>(argv[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    {</span><br><span class="line">        clientlen = <span class="built_in">sizeof</span>(clientaddr);</span><br><span class="line">        connfd = <span class="built_in">accept</span>(listenfd,(SA*)&amp;clientaddr,&amp;clientlen);</span><br><span class="line">        <span class="built_in">Getnameinfo</span>((SA*)&amp;clientaddr,clientlen,client_hostname,MAXLINE,client_port,MAX_PORTLEN,<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(PREFIX_PRINT<span class="string">"Acceptd connection from (%s,%s),clientFd: %d\n"</span>,client_hostname,client_port,connfd);</span><br><span class="line">        <span class="built_in">StartWork</span>(connfd);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>


<h2 id="Part-B-2"><a href="#Part-B-2" class="headerlink" title="Part B"></a>Part B</h2><p>并发做的是预线程化的方式.照书上实现了sbuf包实现对client_fd(connfd)的管理.将之前程序中的StartWork作为线程例程.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202306251624471.png"></p>
<h3 id="sbuf包"><a href="#sbuf包" class="headerlink" title="sbuf包"></a>sbuf包</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SBUF_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SBUF_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> {</span><br><span class="line">    <span class="type">int</span>* buf;</span><br><span class="line">    <span class="type">int</span> count;</span><br><span class="line">    <span class="type">int</span> front;  <span class="comment">//buf[(front+1)%count]为第一个item</span></span><br><span class="line">    <span class="type">int</span> rear;   <span class="comment">//buf[rear%count]为最后一个元素</span></span><br><span class="line">    <span class="type">sem_t</span> mutex;</span><br><span class="line">    <span class="type">sem_t</span> slots;</span><br><span class="line">    <span class="type">sem_t</span> items;</span><br><span class="line">}<span class="type">sbuf_t</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sbuf_init</span><span class="params">(<span class="type">sbuf_t</span>* sp,<span class="type">int</span> n)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sbuf_deinit</span><span class="params">(<span class="type">sbuf_t</span>* sp)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sbuf_insert</span><span class="params">(<span class="type">sbuf_t</span>* sp,<span class="type">int</span> item)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sbuf_remove</span><span class="params">(<span class="type">sbuf_t</span>* sp)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sbuf_init</span><span class="params">(<span class="type">sbuf_t</span> *sp, <span class="type">int</span> n)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    sp-&gt;buf = <span class="built_in">calloc</span>(n,<span class="built_in">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    sp-&gt;count = n;</span><br><span class="line">    sp-&gt;front = sp-&gt;rear = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">sem_init</span>(&amp;sp-&gt;mutex,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">sem_init</span>(&amp;sp-&gt;slots,<span class="number">0</span>,n);</span><br><span class="line">    <span class="built_in">sem_init</span>(&amp;sp-&gt;items,<span class="number">0</span>,<span class="number">0</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sbuf_deinit</span><span class="params">(<span class="type">sbuf_t</span> *sp)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">free</span>(sp-&gt;buf);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">sbuf_insert</span><span class="params">(<span class="type">sbuf_t</span> *sp, <span class="type">int</span> item)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">sem_wait</span>(&amp;sp-&gt;slots);</span><br><span class="line">    <span class="built_in">sem_wait</span>(&amp;sp-&gt;mutex);</span><br><span class="line">    sp-&gt;buf[(++sp-&gt;rear)%(sp-&gt;count)] = item;</span><br><span class="line">    <span class="built_in">sem_post</span>(&amp;sp-&gt;mutex);</span><br><span class="line">    <span class="built_in">sem_post</span>(&amp;sp-&gt;items);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">sbuf_remove</span><span class="params">(<span class="type">sbuf_t</span> *sp)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span> item;</span><br><span class="line">    <span class="built_in">sem_wait</span>(&amp;sp-&gt;items);</span><br><span class="line">    <span class="built_in">sem_wait</span>(&amp;sp-&gt;mutex);</span><br><span class="line">    item = sp-&gt;buf[(++sp-&gt;front)%(sp-&gt;count)];</span><br><span class="line">    <span class="built_in">sem_post</span>(&amp;sp-&gt;mutex);</span><br><span class="line">    <span class="built_in">sem_post</span>(&amp;sp-&gt;slots);</span><br><span class="line">    <span class="keyword">return</span> item;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="main"><a href="#main" class="headerlink" title="main"></a>main</h3><figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span> listenfd,connfd;</span><br><span class="line">    <span class="type">char</span> client_hostname[MAXLINE];</span><br><span class="line">    <span class="type">char</span> client_port[MAX_PORTLEN];</span><br><span class="line">    <span class="type">socklen_t</span> clientlen;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_storage</span> clientaddr;</span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(argc!=<span class="number">2</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr,PREFIX_PRINT<span class="string">"usage: %s &lt;port&gt;\n"</span>,argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="built_in">sbuf_init</span>(&amp;sbuf,SBUFSIZE);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>;i&lt;NTHREADS;++i)</span><br><span class="line">        <span class="built_in">pthread_create</span>(&amp;tid,<span class="literal">NULL</span>,StartWork,<span class="literal">NULL</span>);</span><br><span class="line">    </span><br><span class="line">    listenfd = <span class="built_in">open_listenfd</span>(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    {</span><br><span class="line">        clientlen = <span class="built_in">sizeof</span>(clientaddr);</span><br><span class="line">        connfd = <span class="built_in">accept</span>(listenfd,(SA*)&amp;clientaddr,&amp;clientlen);        </span><br><span class="line">        <span class="built_in">Getnameinfo</span>((SA*)&amp;clientaddr,clientlen,client_hostname,MAXLINE,client_port,MAX_PORTLEN,<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(PREFIX_PRINT<span class="string">"Acceptd connection from (%s,%s),clientFd: %d\n"</span>,client_hostname,client_port,connfd);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">sbuf_insert</span>(&amp;sbuf,connfd);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h2 id="Part-C-1"><a href="#Part-C-1" class="headerlink" title="Part C"></a>Part C</h2><p>类似于Cache lab的设计,读写cache使用的是读者优先的读者-写者模型.要注意的一点是读者读完后其实也会进行写(更新lru),所以也要上锁.<br>想清楚读者-写者模型的特征,每一个地方上锁是为了避免怎样的竞争,之后便可以根据需求做出变化.</p>
<figure class="highlight cpp"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> </span><br><span class="line">{</span><br><span class="line">    <span class="type">char</span> uri[MAXLINE];</span><br><span class="line">    <span class="type">char</span> content_type[MAXLINE];</span><br><span class="line">    <span class="type">char</span>* data;</span><br><span class="line">    <span class="type">char</span> server[MAXLINE];</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">size_t</span> lru;</span><br><span class="line">}CacheLine;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span></span><br><span class="line">{</span><br><span class="line">    CacheLine* cachelines;</span><br><span class="line">    <span class="type">size_t</span> current_lru;</span><br><span class="line">    <span class="type">size_t</span> cache_num;</span><br><span class="line">    <span class="type">size_t</span> cache_size;</span><br><span class="line">}Cache;</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202306271005363.png"></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://jamorant12138.github.io/2023/CSAPP-Labs/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CSAPP/" rel="tag">CSAPP</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2023/DASCTF-2023-June-Binary-WP/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            DASCTF 2023六月挑战赛｜二进制专项 复现
          
        </div>
      </a>
    
    
      <a href="/2023/CSAPP--Notes/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">CSAPP--Notes</div>
      </a>
    
  </nav>

  
   
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2022-2024
        <i class="ri-heart-fill heart_icon"></i> 翰青HanQi
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="北极落小雪"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2022/About">关于</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->
 
<script src="/js/clickLove.js"></script>
 
<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>

</html>