<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8" />
        
      <meta name="description" content="Boom? PWN ! ! !" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>CVE-2012-2836 CVE-2009-3895 libexif 整数溢出 |  北极落小雪</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>
  </html>
</html>


<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-Try Fuzzing -CVE-2012-2836 CVE-2009-3895 libexif Integer-Overflow"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  CVE-2012-2836 CVE-2009-3895 libexif 整数溢出
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/Try%20Fuzzing%20-CVE-2012-2836%20CVE-2009-3895%20libexif%20Integer-Overflow/" class="article-date">
  <time datetime="2024-03-10T16:00:00.000Z" itemprop="datePublished">2024-03-11</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Pwn/">Pwn</a> / <a class="article-category-link" href="/categories/Pwn/%E5%BA%94%E7%94%A8%E5%B1%82/">应用层</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">2.2k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">10 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p>libexif-0.6.14.</p>
<h2 id="CVE-2012-2836"><a href="#CVE-2012-2836" class="headerlink" title="CVE-2012-2836"></a>CVE-2012-2836</h2><p>-s 123跑几分钟,出了13个crash,栈回溯分一下类,一共4种路径</p>
<h3 id="崩溃分析"><a href="#崩溃分析" class="headerlink" title="崩溃分析"></a>崩溃分析</h3><p>crash 0:<br>调用exif_data_load_data_thumbnail函数时size参数明显过大,且正好是unsigned int的最大值,猜测是个整数溢出或错误的类型转换(int32_t转uint32_t).</p>
<span id="more"></span>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202403101050276.png"></p>
<p>崩溃指令可以看出是memmove时的越界读取,逻辑上符合size过大可能出现的情况.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202403101057788.png"></p>
<p>crash 5:<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202403101050586.png"><br>崩溃的原因是从buf中取元素.<br>发现调用exif_get_short时参数buf是错误的地址,且与exif_data_load_data的d_orig地址非常相似,相差0xFFFFFFFF+3,同样让人联想到整数溢出类型的漏洞.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202403101116353.png"></p>
<p>crash 8:<br>和crash0到达memmove的路径不同,其他相同.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202403101050817.png"><br>crash 10:</p>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202403101051016.png"></p>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202403101126771.png"></p>
<h3 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><h4 id="Crash-0"><a href="#Crash-0" class="headerlink" title="Crash 0"></a>Crash 0</h4><p>跟着链子来到exif_data_load_data_thumbnail函数.众所周知,缓冲区溢出关注四个变量,destination大小,source大小,写入destination的偏移,读取source的偏移.如果指定了偏移,就意味着比较时的运算,有运算就有Integer Overflow的风险.<br>函数开始的Check中明显存在offset+size的上溢出问题,导致越界读取.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">exif_data_load_data_thumbnail</span> <span class="params">(ExifData *data, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *d,</span></span><br><span class="line"><span class="params">			       <span class="type">unsigned</span> <span class="type">int</span> ds, ExifLong offset, ExifLong size)</span></span><br><span class="line">{</span><br><span class="line">	<span class="keyword">if</span> (ds &lt; offset + size) {</span><br><span class="line">		exif_log (data-&gt;priv-&gt;<span class="built_in">log</span>, EXIF_LOG_CODE_DEBUG, <span class="string">"ExifData"</span>,</span><br><span class="line">			  <span class="string">"Bogus thumbnail offset and size: %i &lt; %i + %i."</span>,</span><br><span class="line">			  (<span class="type">int</span>) ds, (<span class="type">int</span>) offset, (<span class="type">int</span>) size);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	}</span><br><span class="line">	<span class="keyword">if</span> (data-&gt;data) </span><br><span class="line">		exif_mem_free (data-&gt;priv-&gt;mem, data-&gt;data);</span><br><span class="line">	data-&gt;size = size;</span><br><span class="line">	data-&gt;data = exif_data_alloc (data, data-&gt;size);</span><br><span class="line">	<span class="keyword">if</span> (!data-&gt;data) </span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	<span class="built_in">memcpy</span> (data-&gt;data, d + offset, data-&gt;size);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>如何正确的Check overflow?引用《Secure Coding in C and C++》中的描述.</p>
<blockquote>
<p>Precondition.Addition of unsigned integers can result in an integer overflowif the sum of the left-hand side (LHS) and right-hand side (RHS) of an additionoperation is greater than UINT_MAXfor addition of inttype and ULLONG_MAXforaddition of unsignedlonglong type.<br>Addition of signed integers is more complicated, as shown in Table 5–5.As you test for these preconditions, make sure that the test itself does notoverflow. The tests in Table 5–5 are guaranteed not to overflow for appropri-ately signed values.</p>
<p>Postcondition.Another  solution  to  detecting  integer  overflow  is  to  performthe addition and then evaluate the results of the operation. For example, to testfor overflow of signed integers, let sum=lhs+rhs. If lhsis non-negative andsum&lt;rhs, an overflow has occurred. Similarly, if lhsis negative and sum&gt;rhs,an  overflow  has  occurred.  In  all  other  cases,  the  addition  operation  succeedswithout overflow. For unsigned integers, if the sum is smaller than either oper-and, an overflow has occurred.</p>
</blockquote>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202403101356063.png"></p>
<p>官方的修补方案:</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Sanity checks */</span></span><br><span class="line"><span class="keyword">if</span> ((o + s &lt; o) || (o + s &lt; s) || (o + s &gt; ds) || (o &gt; ds)) {</span><br><span class="line">	exif_log (data-&gt;priv-&gt;<span class="built_in">log</span>, EXIF_LOG_CODE_DEBUG, <span class="string">"ExifData"</span>,</span><br><span class="line">		  <span class="string">"Bogus thumbnail offset (%u) or size (%u)."</span>,</span><br><span class="line">		  o, s);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="crash-8"><a href="#crash-8" class="headerlink" title="crash 8"></a>crash 8</h4><p>同样的check问题.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">exif_mnote_data_olympus_load</span> <span class="params">(ExifMnoteData *en,</span></span><br><span class="line"><span class="params">			      <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">unsigned</span> <span class="type">int</span> buf_size)</span></span><br><span class="line">{</span><br><span class="line">......</span><br><span class="line">	    <span class="keyword">if</span> (o + s &gt; buf_size) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">	    <span class="comment">/* Sanity check */</span></span><br><span class="line">	    n-&gt;entries[i].data = exif_mem_alloc (en-&gt;mem, s);</span><br><span class="line">	    <span class="keyword">if</span> (!n-&gt;entries[i].data) <span class="keyword">continue</span>;</span><br><span class="line">	    n-&gt;entries[i].size = s;</span><br><span class="line">	    <span class="built_in">memcpy</span> (n-&gt;entries[i].data, buf + o, s);</span><br><span class="line">......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>官方修补方案</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((dataofs + s &lt; dataofs) || (dataofs + s &lt; s) || </span><br><span class="line">    (dataofs + s &gt; buf_size)) {</span><br><span class="line">	exif_log (en-&gt;<span class="built_in">log</span>, EXIF_LOG_CODE_DEBUG,</span><br><span class="line">		  <span class="string">"ExifMnoteOlympus"</span>,</span><br><span class="line">		  <span class="string">"Tag data past end of buffer (%u &gt; %u)"</span>,</span><br><span class="line">		  dataofs + s, buf_size);</span><br><span class="line">	<span class="keyword">continue</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="crash-5"><a href="#crash-5" class="headerlink" title="crash 5"></a>crash 5</h4><p>同样的check问题.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">exif_data_load_data</span> <span class="params">(ExifData *data, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *d_orig,</span></span><br><span class="line"><span class="params">		     <span class="type">unsigned</span> <span class="type">int</span> ds_orig)</span></span><br><span class="line">{</span><br><span class="line">......</span><br><span class="line">	<span class="comment">/* IFD 1 offset */</span></span><br><span class="line">	<span class="keyword">if</span> (offset + <span class="number">6</span> + <span class="number">2</span> &gt; ds) {</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	}</span><br><span class="line">	n = exif_get_short (d + <span class="number">6</span> + offset, data-&gt;priv-&gt;order);</span><br><span class="line">......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>官方修补:<br>虽然看起来还是有溢出,但”ds is restricted to 16 bit above, so offset is restricted too, and offset+8 should not overflow”. </p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Sanity check the offset, being careful about overflow */</span></span><br><span class="line"><span class="keyword">if</span> (offset &gt; ds || offset + <span class="number">6</span> + <span class="number">2</span> &gt; ds)</span><br><span class="line">	<span class="keyword">return</span>;</span><br></pre></td></tr></tbody></table></figure>

<h4 id="crash-10"><a href="#crash-10" class="headerlink" title="crash 10"></a>crash 10</h4><p>同样的check问题.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">exif_mnote_data_canon_load</span> <span class="params">(ExifMnoteData *ne,</span></span><br><span class="line"><span class="params">	<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">unsigned</span> <span class="type">int</span> buf_size)</span></span><br><span class="line">{</span><br><span class="line">......</span><br><span class="line">		<span class="keyword">if</span> (o + s &gt; buf_size) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/* Sanity check */</span></span><br><span class="line">		n-&gt;entries[i].data = exif_mem_alloc (ne-&gt;mem, <span class="keyword">sizeof</span> (<span class="type">char</span>) * s);</span><br><span class="line">		<span class="keyword">if</span> (!n-&gt;entries[i].data) <span class="keyword">return</span>;</span><br><span class="line">		n-&gt;entries[i].size = s;</span><br><span class="line">		<span class="built_in">memcpy</span> (n-&gt;entries[i].data, buf + o, s);</span><br><span class="line">......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>官方修补:</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((dataofs + s &lt; s) || (dataofs + s &lt; dataofs) || (dataofs + s &gt; buf_size)) {</span><br><span class="line">	exif_log (ne-&gt;<span class="built_in">log</span>, EXIF_LOG_CODE_DEBUG,</span><br><span class="line">		<span class="string">"ExifMnoteCanon"</span>,</span><br><span class="line">		<span class="string">"Tag data past end of buffer (%u &gt; %u)"</span>,</span><br><span class="line">		dataofs + s, buf_size);</span><br><span class="line">	<span class="keyword">continue</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h4 id="anoher"><a href="#anoher" class="headerlink" title="anoher"></a>anoher</h4><p>以及一个没有打出来的load函数中的check洞.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">exif_mnote_data_pentax_load</span> <span class="params">(ExifMnoteData *en,</span></span><br><span class="line"><span class="params">		<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">unsigned</span> <span class="type">int</span> buf_size)</span></span><br><span class="line">{</span><br><span class="line">......</span><br><span class="line">            <span class="keyword">if</span> (o + s &gt; buf_size) <span class="keyword">return</span>;</span><br><span class="line">                                                                                </span><br><span class="line">            <span class="comment">/* Sanity check */</span></span><br><span class="line">            n-&gt;entries[i].data = exif_mem_alloc (en-&gt;mem, <span class="keyword">sizeof</span> (<span class="type">char</span>) * s);</span><br><span class="line">            <span class="keyword">if</span> (!n-&gt;entries[i].data) <span class="keyword">return</span>;</span><br><span class="line">            n-&gt;entries[i].size = s;</span><br><span class="line">            <span class="built_in">memcpy</span> (n-&gt;entries[i].data, buf + o, s);</span><br><span class="line">......</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>官方修补:</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((dataofs + s &lt; dataofs) || (dataofs + s &lt; s) ||</span><br><span class="line">	(dataofs + s &gt; buf_size)) {</span><br><span class="line">	exif_log (en-&gt;<span class="built_in">log</span>, EXIF_LOG_CODE_DEBUG,</span><br><span class="line">			  <span class="string">"ExifMnoteDataPentax"</span>, <span class="string">"Tag data past end "</span></span><br><span class="line">		  <span class="string">"of buffer (%u &gt; %u)"</span>, dataofs + s, buf_size);</span><br><span class="line">	<span class="keyword">continue</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="CodeQL"><a href="#CodeQL" class="headerlink" title="CodeQL"></a>CodeQL</h3><p>为该漏洞模式编写CodeQL查询,漏洞建模为: 被ExifLoader-&gt;buf污染的转换后可能发生溢出的比较表达式.<br>编写整洁的CodeQL查询需要非常熟悉标准库,而笔者显然不是,所以编写的查询比较繁琐.</p>
<p>下方的查询共报出8个结果,命中5个漏洞点中的2个.<br>误报原因在于对ds变量取值范围分析不精,误报点不会发生溢出.<br>漏报的漏洞均来自exif-mnote-data-XXX.这三个函数是通过d-&gt;methods.load (d, buf, buf_size)的函数指针调用,猜测是污点分析时在函数指针的调用时中断.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"> import cpp</span><br><span class="line"> import semmle.code.cpp.rangeanalysis.SimpleRangeAnalysis</span><br><span class="line"> import semmle.code.cpp.dataflow.new.DataFlow</span><br><span class="line"> import semmle.code.cpp.dataflow.new.TaintTracking</span><br><span class="line"> </span><br><span class="line">class PFFiledAccess extends FieldAccess</span><br><span class="line">{</span><br><span class="line">    PFFiledAccess() </span><br><span class="line">    {</span><br><span class="line">        exists(Access fa </span><br><span class="line">            |   (fa instanceof FieldAccess </span><br><span class="line">            or  fa instanceof PointerFieldAccess)</span><br><span class="line">            and this=fa)</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"> module FlowConfig implements DataFlow::ConfigSig</span><br><span class="line"> {</span><br><span class="line">     predicate isSource(DataFlow::Node source)</span><br><span class="line">     {</span><br><span class="line">         exists(PFFiledAccess pffa</span><br><span class="line">            | pffa.getQualifier().(VariableAccess).getTarget().getUnderlyingType().stripType().getName()="_ExifLoader"</span><br><span class="line">            and pffa.getTarget().getName() in ["buf"]</span><br><span class="line">            and source=DataFlow::exprNode(pffa))</span><br><span class="line">            </span><br><span class="line">     }</span><br><span class="line"> </span><br><span class="line">     predicate isSink(DataFlow::Node sink) </span><br><span class="line">     {</span><br><span class="line">        exists(Expr e</span><br><span class="line">            |(not e.getAChild().getType() instanceof PointerType)</span><br><span class="line">              and (convertedExprMightOverflow(e))</span><br><span class="line">            and e.getParent() instanceof RelationalOperation</span><br><span class="line">              and sink=DataFlow::exprNode(e))</span><br><span class="line">     }</span><br><span class="line"></span><br><span class="line"> }</span><br><span class="line"> </span><br><span class="line"> module Flow = TaintTracking::Global&lt;FlowConfig&gt;;</span><br><span class="line"> </span><br><span class="line">from DataFlow::Node source, DataFlow::Node sink,Expr sinke </span><br><span class="line">where Flow::flow(source, sink)</span><br><span class="line">and sinke = sink.asExpr()</span><br><span class="line">select source,sink,sinke.getChild(0).toString()+sink.toString()+sinke.getChild(1).toString(),sink.getLocation() as location order by location</span><br></pre></td></tr></tbody></table></figure>

<p>我像这样添加边,但查询结果没有变化</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">predicate <span class="title function_">isAdditionalFlowStep</span><span class="params">(DataFlow::Node pred, DataFlow::Node succ)</span></span><br><span class="line">{</span><br><span class="line">   exists( ExprCall ec</span><br><span class="line">       |ec.getAnArgument() = pred.asExpr()</span><br><span class="line">       and ec.getTarget().getAParameter().getAnAccess() = succ.asExpr())  </span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>进一步测试并查询文档发现,对于VariableCall,getTarget谓词不能获取到目标.</p>
<blockquote>
<p>Gets the target of the call, as best as makes sense for this kind of call. The precise meaning depends on the kind of call it is: - For a call to a function, it’s the function being called. - For a C++ method call, it’s the statically resolved method. - For an Objective C message expression, it’s the statically resolved method, and it might not exist. - For a variable call, it never exists.</p>
</blockquote>
<p>找了下标准库发现没找到相关的实现,自己写一个.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Function targetOfVariableCall(VariableCall vc) </span><br><span class="line">{</span><br><span class="line">    exists(Assignment a,FunctionAccess fa</span><br><span class="line">        |vc.getExpr().(ValueFieldAccess).getQualifier().(VariableAccess).getTarget().getAnAccess() = a.getLValue().(ValueFieldAccess).getQualifier()</span><br><span class="line">        and a.getRValue()=fa</span><br><span class="line">        and result=fa.getTarget())</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"> predicate isAdditionalFlowStep(DataFlow::Node pred, DataFlow::Node succ)</span><br><span class="line"> {</span><br><span class="line">    exists( VariableCall ec</span><br><span class="line">        |ec.getAnArgument() = pred.asExpr()</span><br><span class="line">        and targetOfVariableCall(ec).getAParameter().getAnAccess() = succ.asExpr())  </span><br><span class="line"> }</span><br></pre></td></tr></tbody></table></figure>

<p>最终查询到13个结果,5个漏洞点均命中.</p>
<h2 id="CVE-2009-3895"><a href="#CVE-2009-3895" class="headerlink" title="CVE-2009-3895"></a>CVE-2009-3895</h2><h3 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h3><p>为之前的漏洞点打上Patch,继续Fuzz.<br>打出一个Crash.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202403110059830.png"></p>
<p>跟到漏洞点,发现此时e-&gt;components的值是2147483664.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">exif_data_load_data_entry</span> <span class="params">(ExifData *data, ExifEntry *entry,</span></span><br><span class="line"><span class="params">			   <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *d,</span></span><br><span class="line"><span class="params">			   <span class="type">unsigned</span> <span class="type">int</span> size, <span class="type">unsigned</span> <span class="type">int</span> offset)</span></span><br><span class="line">{</span><br><span class="line">			<span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; e-&gt;components; i++)</span><br><span class="line">				exif_set_short (</span><br><span class="line">					e-&gt;data + i *</span><br><span class="line">					exif_format_get_size (</span><br><span class="line">					EXIF_FORMAT_SHORT), o,</span><br><span class="line">					(ExifShort) exif_get_long (</span><br><span class="line">					e-&gt;data + i *</span><br><span class="line">					exif_format_get_size (</span><br><span class="line">					EXIF_FORMAT_LONG), o));</span><br><span class="line">			e-&gt;format = EXIF_FORMAT_SHORT;</span><br><span class="line">			e-&gt;size = e-&gt;components *</span><br><span class="line">				exif_format_get_size (e-&gt;format);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>而在进行下方操作时,发生越界读取.由于i(uint32_t)作为循环变量,上限是由可控的e-&gt;components决定的,在乘法运算中可能会发生整数溢出.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exif_get_long (e-&gt;data + i *exif_format_get_size (EXIF_FORMAT_LONG), o)</span><br></pre></td></tr></tbody></table></figure>
<p>然而这里的整数正溢出是如何直接造成越界读取的呢?之前几个漏洞是整数溢出导致checker失效,也就是说直接导致越界读写的是绕过检测的恶意offset和读取大小超过了缓冲区实际大小.<br>来看下这里的缓冲区是怎么分配的,还是大小乘数量,虽然这里参与运算的entry-&gt;components是64位,但s是uint32_t,截断后与溢出发生同样效果.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//仅展示相关代码</span></span><br><span class="line"></span><br><span class="line">	entry-&gt;components = exif_get_long  (d + offset + <span class="number">4</span>, data-&gt;priv-&gt;order);</span><br><span class="line"></span><br><span class="line">	s = exif_format_get_size (entry-&gt;format) * entry-&gt;components;</span><br><span class="line">	<span class="keyword">if</span> (!s)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (s &gt; <span class="number">4</span>)</span><br><span class="line">		doff = exif_get_long (d + offset + <span class="number">8</span>, data-&gt;priv-&gt;order);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		doff = offset + <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">	entry-&gt;data = exif_data_alloc (data, s);</span><br></pre></td></tr></tbody></table></figure>

<p>从道理上来说,分配和写入时使用同样的表达式,即使都发生溢出,但缓冲区的大小和(偏移+)写入的大小是匹配的,不会造成问题.然而这里是使用的循环变量i进行运算,由于分配时溢出实际分配到的缓冲区较小,则在i从0开始递增的过程中,这里不会发生溢出,偏移逐渐超过缓冲区大小造成越界读取.</p>
<p>所以实际的漏洞点应该是分配缓冲区时的整数溢出.<br>官方修补:</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((s &lt; entry-&gt;components) || (s == <span class="number">0</span>)){</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h3 id="CodeQL-1"><a href="#CodeQL-1" class="headerlink" title="CodeQL"></a>CodeQL</h3><p>为什么之前的CodeQL查询漏掉了这个漏洞?下列是原因.</p>
<ol>
<li>之前的Sink建模为条件表达式,而这里显然不是.</li>
<li>CodeQL的污点并不会从一次具有污染性的FieldAccess传播到该Field所有的FieldAccess(如果这样建模污染就太广了).</li>
<li>CodeQL的污点不会从循环终止条件传播到循环计数器.</li>
</ol>
<p>处于练习的目的,我最小化的连上了相关的边.成功发现了该漏洞,但查询结果数也来到了171条.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">predicate classFieldTaintStep(DataFlow::Node pred,DataFlow::Node succ,string fn) </span><br><span class="line">{</span><br><span class="line">    exists(PFFiledAccess pffa </span><br><span class="line">        |pffa = pred.asExpr()</span><br><span class="line">        and pffa.getTarget().getName()=fn</span><br><span class="line">        and pffa.getTarget().getAnAccess() = succ.asExpr())</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">predicate forGuardTaintStep(DataFlow::Node pred,DataFlow::Node succ)</span><br><span class="line">{</span><br><span class="line">    exists(ForStmt fs, LoopCounter lc</span><br><span class="line">        |fs.getCondition().(RelationalOperation).getAChild() = lc.getAnAccess() </span><br><span class="line">        and fs.getCondition().(RelationalOperation).getAChild() = pred.asExpr()</span><br><span class="line">        and lc.getAnAccess()=succ.asExpr())</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>



 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://jamorant12138.github.io/2024/Try%20Fuzzing%20-CVE-2012-2836%20CVE-2009-3895%20libexif%20Integer-Overflow/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CVE/" rel="tag">CVE</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2024/CVE-2023-4911%20LD-HeapOverflow/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            CVE-2023-4911 GLIBC ld 堆溢出提权
          
        </div>
      </a>
    
    
      <a href="/2024/Try%20Fuzzing%20-%20CVE-2019-13288%20xpdf%20Infinite-Recursion/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">CVE-2019-13288 xpdf 无限递归</div>
      </a>
    
  </nav>

  
   
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2022-2025
        <i class="ri-heart-fill heart_icon"></i> 翰青HanQi
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="北极落小雪"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2022/About">关于</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->
 
<script src="/js/clickLove.js"></script>
 
<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>

</html>